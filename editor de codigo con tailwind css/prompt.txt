necesito que añadas estas reglas al momento que e usuario se registre debe de registrar la hora y fecha del registro por que le vamos a dar solo 7 dias de prueva  cuando eso se finalice debe aparecer un modal donde indique al usuario que su prueva ya termino pidiendo que seleccione 2 planes mensual de 5 dolares y anual de 20 dolares cuando seleccione uno de ellos debe de rediriguir a whatsap tomando en cuenta el tipo de seleccion y mandar al usuario al numero 962221725  ojo el modal debe ser completamente atractivo cuando realize el pago yo debo de poder activar la cuenta dependiendo del tipo de pago haya echo para eso debes modificar las reglas que tengo   rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null; // Solo usuarios autenticados
    }
  }
}  

debo de poder ver al usuario por email  el dia que se registro y cuando va a vencer 

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCode</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Spectrum Color Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            900: '#1e1e28',
                            800: '#282a36',
                            700: '#44475a',
                            600: '#6272a4',
                            500: '#f8f8f2',
                        },
                        accent: {
                            purple: '#bd93f9',
                            pink: '#ff79c6',
                            teal: '#8be9fd',
                            amber: '#ffb86c',
                            green: '#50fa7b',
                            red: '#ff5555'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Monaco Editor -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/editor/editor.main.min.css">

    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Spectrum Color Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    <style>
        html,
        body {
            max-height: 100%;
            margin: 0;
            overflow: hidden;
        }

        /* ============================
           Scrollbar personalizado
        =============================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ============================
           Transiciones y efectos
        =============================== */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .editor-glow {
            box-shadow: 0 0 15px rgba(189, 147, 249, 0.3);
        }

        .fab {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }

        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .user-profile {
            position: relative;
            transition: all 0.2s ease;
            z-index: 999;
        }

        .user-profile .dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            min-width: 200px;
            background-color: #282a36;
            border: 1px solid #44475a;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 8px 0;
            margin-top: 8px;
        }

        .user-profile:hover .dropdown,
        .user-profile .dropdown:hover {
            display: block;
        }

        .user-profile .dropdown button {
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            color: #f8f8f2;
            transition: all 0.2s ease;
        }

        .user-profile .dropdown button:hover {
            background-color: #44475a;
            color: white;
        }

        .user-profile .dropdown .user-email {
            padding: 8px 16px;
            color: #8be9fd;
            font-size: 0.9rem;
            border-bottom: 1px solid #44475a;
            margin-bottom: 4px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .terminal-cursor {
            animation: blink 1s step-end infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================
           Texto y Gradientes
        =============================== */
        .gradient-text {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, #bd93f9, #ff79c6);
        }

        h3 {
            color: white;
        }

        .tooltip-text {
            font-size: 1rem;
            font-family: monospace;
            text-align: center;
            align-items: center;
        }

        button:focus:not(:focus-visible) {
            outline: none;
        }

        /* ============================
           Editor Monaco y sugerencias
        =============================== */
        .monaco-editor .suggest-widget .monaco-list-row.focused .codicon {
            color: #bd93f9 !important;
        }

        .monaco-editor .suggest-widget .monaco-list-row.focused {
            color: #f8f8f2 !important;
            background-color: #44475a !important;
        }

        .monaco-editor .parameter-hints-widget {
            border: 1px solid #44475a;
            background-color: #282a36;
        }

        .monaco-editor .parameter-hints-widget .signature {
            color: #f8f8f2;
        }

        .monaco-editor .parameter-hints-widget .docs {
            color: #6272a4;
        }

        .monaco-editor {
            .tag {
                color: var(--tag-color);
            }

            .angle-bracket {
                color: var(--delimiter-color);
            }

            .identifier {
                color: var(--text-color);
            }

            .mtk1 {
                color: var(--text-color);
            }

            .mtk5 {
                color: var(--delimiter-color);
            }

            .mtk6 {
                color: var(--tag-color);
            }

            .mtk10 {
                color: var(--keyword-color);
            }

            .mtk12 {
                color: var(--string-color);
            }

            .mtk8 {
                color: var(--number-color);
            }

            .mtk3 {
                color: var(--comment-color);
            }
        }

        /* ============================
           Modal y overlay
        =============================== */
        .modal-overlay {
            background-color: rgba(30, 30, 40, 0.8);
        }

        #error-modal {
            animation: fadeIn 0.3s ease-out;
        }

        #error-modal div {
            border-color: #ff5555;
        }

        /* ============================
           Tooltip y elementos interactivos
        =============================== */
        .tooltip {
            position: relative;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #282a36;
            color: #f8f8f2;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* ============================
           Consola y logs
        =============================== */
        .console-log {
            color: #f8f8f2;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        .console-error {
            color: #ff5555;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        .console-warn {
            color: #ffb86c;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        .console-info {
            color: #8be9fd;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        #console-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-family: monospace;
            line-height: 1.5;
            padding: 8px;
        }

        /* ============================
           Errores y advertencias en código
        =============================== */
        .error-lens-decoration-error {
            background: rgba(255, 85, 85, 0.1);
            border-bottom: 2px dashed #ff5555;
        }

        .error-lens-glyph-margin-error {
            background: rgba(255, 85, 85, 0.2);
        }

        .error-lens-inline-error::after {
            content: attr(title);
            color: #ff5555;
            background: rgba(30, 30, 40, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 12px;
        }

        /* Advertencias */
        .error-lens-decoration-warning {
            background: rgba(255, 184, 108, 0.1);
            border-bottom: 2px dashed #ffb86c;
        }

        .error-lens-glyph-margin-warning {
            background: rgba(255, 184, 108, 0.2);
        }

        .error-lens-inline-warning::after {
            content: attr(title);
            color: #ffb86c;
            background: rgba(30, 30, 40, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 12px;
        }

        /* Información */
        .error-lens-decoration-info {
            background: rgba(139, 233, 253, 0.1);
            border-bottom: 2px dashed #8be9fd;
        }

        .error-lens-glyph-margin-info {
            background: rgba(139, 233, 253, 0.2);
        }

        .error-lens-inline-info::after {
            content: attr(title);
            color: #8be9fd;
            background: rgba(30, 30, 40, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 12px;
        }

        /* ============================
           Sidebar y menú
        =============================== */
        #sidebar {
            position: absolute;
            min-height: calc(100vh - 4.3rem);
            z-index: 20;
            transition: transform 0.3s ease-in-out;
        }

        @media (min-width: 768px) {
            #sidebar {
                position: absolute;
                transform: translateX(0);
            }

            #sidebar.-translate-x-full {
                transform: translateX(-100%);
            }

            #quick-access {
                position: absolute !important;
                right: 0;
                top: 0;
                height: 100%;
                z-index: 20;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                opacity: 0;
                visibility: hidden;
            }

            #quick-access.show {
                transform: translateX(0);
                opacity: 1;
                visibility: visible;
                transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            }
        }

        #main-content {
            width: 100%;
            transition: width 0.3s ease;
        }

        #editor-container {
            width: 100%;
            min-height: calc(100vh - 9rem);
            flex: 1;
            transition: all 0.3s ease;
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            /* Añade esto */
            background: white;
            /* Para visualizarlo mejor */
        }

        #editor-container.half-screen {
            min-height: 40vh !important;
            flex: 0;
        }

        footer {
            flex-shrink: 0;
            height: 28px;
        }

        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #preview-container {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease, flex 0.3s ease;
            flex: none;
        }

        #preview-container.full-height {
            flex: 1;
            min-height: calc(100vh - 9rem);
        }

        #preview-container.half-screen {
            flex: 1;
            min-height: 40vh !important;
        }

        #terminal-panel {
            height: 0;
            flex-shrink: 0;
            transition: height 0.3s ease, flex 0.3s ease;
        }


        #terminal-panel.half-screen {
            flex: 1;
            min-height: 37vh !important;
        }

        @media(max-width:799px) {
            #editor-container {
                min-height: calc(100vh - 12rem);
            }

            #editor-container.half-screen {
                min-height: 30vh !important;
            }

            #preview-container.half-screen {
                min-height: 30vh !important;
            }

            #terminal-panel.half-screen {
                min-height: 46vh !important;
            }

            #sidebar {
                min-height: calc(100vh - 7.7rem);
            }

        }

        /* #monaco-editor {
            width: 100% !important;
        } */
        #quick-access {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            z-index: 20;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        #quick-access.show {
            transform: translateX(0);
        }

        /* ============================
           Tooltips y botones
        =============================== */
        .tooltip-text {
            font-size: 1rem;
            font-family: monospace;
            text-align: center;
            align-items: center;
        }

        .color-preset-btn {
            transition: all 0.2s ease;
        }

        .color-preset-btn:hover {
            transform: translateY(-2px);
        }

        /* ============================
           Formularios y entradas
        =============================== */
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 2px;
        }

        body,
        #sidebar,
        #quick-access,
        #terminal-panel,
        #config-modal {
            background-color: #1e1e28 !important;
            color: #f8f8f2 !important;
        }

        #editor-tabs,
        header {
            background-color: #282a36 !important;
            border-color: #44475a !important;
        }

        input,
        select,
        textarea {
            background-color: #282a36 !important;
            border: 1px solid #44475a !important;
            color: #f8f8f2 !important;
        }

        .file-item:hover,
        .folder-item:hover {
            background-color: #44475a !important;
        }

        .monaco-editor .view-overlays .current-line {
            border: none !important;
            background-color: #282a36 !important;
        }

        .monaco-editor .glyph-margin {
            display: none !important;
        }

        .monaco-editor .view-ruler {
            display: none !important;
        }



        /* ============================
           Animaciones y carga
        =============================== */
        .loader-dots {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 13px;
        }

        .dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #bd93f9;
            border-radius: 50%;
            animation: loader-dots 1.2s linear infinite;
        }

        .dot:nth-child(2) {
            left: 10px;
            animation-delay: 0.2s;
        }

        .dot:nth-child(3) {
            left: 20px;
            animation-delay: 0.4s;
        }

        @keyframes loader-dots {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        pre code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }

        /* ============================
             TEMAS PERSONALIZADOS (Corregidos)
        =============================== */
        /* TEMAS OSCUROS - VERSION CORREGIDA */
        body.theme-dark {
            --text-color: #d4d4d4;
            --background-color: #1e1e1e;
            --keyword-color: #569cd6;
            --string-color: #ce9178;
            --number-color: #b5cea8;
            --comment-color: #6a9955;
            --delimiter-color: #d4d4d4;
            --tag-color: #4ec9b0;
        }



        body.theme-feminine {
            --text-color: #ecc5d2;
            --background-color: #282a36;
            --keyword-color: #ff99cc;
            --string-color: #d4a5d4;
            --number-color: #f4b3c2;
            --comment-color: #a78faa;
            --delimiter-color: #d4a15f;
            --tag-color: #d67ad1;
        }

        body.theme-vibrant {
            --text-color: #e5e5e5;
            --background-color: #282a36;
            --keyword-color: #ffdd40;
            --string-color: #ff7f7f;
            --number-color: #7fdbca;
            --comment-color: #50fa7b;
            --delimiter-color: #ff79c6;
            --tag-color: #8be9fd;
        }

        body.theme-professional {
            --text-color: #e0e0e0;
            --background-color: #282a36;
            --keyword-color: #4EC9B0;
            --string-color: #CE9178;
            --number-color: #B5CEA8;
            --comment-color: #6A9955;
            --delimiter-color: #808080;
            --tag-color: #569CD6;
        }

        /* ESTILOS GLOBALES */
        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .monaco-editor {
            background-color: var(--background-color) !important;
        }
    </style>
</head>

<body class="bg-dark-900 text-gray-200 font-sans antialiased overflow-hidden h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="bg-dark-800 border-b border-dark-700 px-4 py-3 flex items-center justify-between">
        <div class="flex flex-1 overflow-hidden w-full">
            <!-- Menu Button -->
            <button id="menu-toggle" class="text-gray-400 hover:text-white transition-all p-2 rounded-md hover:bg-dark-700">
                <i class="fas fa-bars text-lg"></i>
            </button>

            <!-- Logo/Brand -->
            <div class="flex items-center">
                <i class="fas fa-code text-accent-purple text-xl mr-2"></i>
                <span class="text-xl font-bold gradient-text">BCode</span>
            </div>
        </div>

        <!-- Right Side Controls -->
        <!-- En el header, reemplaza el div del perfil con esto: -->
        <div class="flex items-center space-x-3">
            <!-- Theme Toggle -->
            <button id="config-toggle" class="text-gray-400 hover:text-white transition-all p-2 rounded-md hover:bg-dark-700 tooltip">
                <i class="fas fa-cog"></i>
                <span class="tooltip-text">Configuración del editor</span>
            </button>

            <!-- User Profile -->
            <div class="user-profile hidden relative">
                <div
                    class="w-8 h-8 rounded-full bg-accent-teal flex items-center justify-center text-white font-semibold cursor-pointer user-initials">
                    <span>?</span>
                </div>
                <div class="dropdown hidden">
                    <div class="user-email"></div>
                    <button id="signout-btn" class="flex items-center px-3 py-2 text-sm hover:bg-dark-700">
                        <i class="fas fa-sign-out-alt mr-2"></i> 
                        <span>Cerrar sesión</span>
                    </button>
                </div>
            </div>

            <!-- Sign In Button (shown when not authenticated) -->
            <button id="signin-btn" class="text-gray-400 hover:text-white transition-all p-2 rounded-md hover:bg-dark-700">
                <i class="fas fa-sign-in-alt"></i>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden  ">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="bg-dark-800 w-64 border-r border-dark-700 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-20">
            <!-- File Explorer Header -->
            <div class="px-4 py-3 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-sm font-semibold uppercase tracking-wider text-gray-400">Explorador</h3>
                <div class="flex space-x-2">
                    <button id="new-folder-btn" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-folder-plus text-sm"></i>
                        <span class="tooltip-text">Nueva carpeta</span>
                    </button>
                    <button id="new-folder-principal-btn" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-folder-plus text-sm"></i>
                        <span class="tooltip-text">Nueva carpeta (Princial)</span>
                    </button>

                    <button id="new-file-btn" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-file-plus text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- File Tree -->
            <div id="file-explorer" class="flex-1 overflow-y-auto py-2">
                <!-- Files will be loaded here dynamically -->
                <div id="file-list" class="px-2"></div>
            </div>
            <div class="px-4 py-3 border-t border-dark-700">
                <div class="flex justify-between space-x-2">
                    <button id="import-btn" class="text-gray-400 hover:text-white transition-all p-2 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-file-import text-sm"></i>
                        <span class="tooltip-text">Importar</span>
                    </button>
                    <button id="export-btn" class="text-gray-400 hover:text-white transition-all p-2 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-file-export text-sm"></i>
                        <span class="tooltip-text">Exportar</span>
                    </button>
                    <button id="code-actions-btn" class="text-gray-400 hover:text-white transition-all p-2 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-code text-sm"></i>
                        <span class="tooltip-text">Acciones</span>
                    </button>
                </div>
            </div>


            <!-- Status Bar -->
            <div class="px-3 py-2 border-t border-dark-700 text-xs text-gray-500 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-circle text-green-500"></i>
                    <span id="current-language">HTML</span>
                </div>
                <div>
                    <span>UTF-8</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden w-full transition-all duration-300" id="main-content">

            <!-- Editor Tabs -->
            <div id="editor-tabs" class="bg-dark-800 border-b border-dark-700 flex items-center overflow-x-auto">
                <div class="flex">
                    <!-- Tabs will be loaded here dynamically -->
                </div>

                <!-- Tab Actions -->
                <div class="ml-auto flex items-center px-3">
                    <button id="close-all-tabs" class="text-gray-400 hover:text-white p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-times-circle text-sm"></i>
                        <span class="tooltip-text">Cerrar todas</span>
                    </button>
                </div>
            </div>

            <!-- Editor Area -->
            <div id="editor-container"
                class="flex-1 overflow-hidden editor-glow transition-all flex items-center justify-center">
                <h2 class="text-3xl font-bold text-accent-purple text-center">
                    BCode tu mejor editor de código<br>
                    <span class="text-xl text-gray-400 font-normal">Crea tu archivo para empezar a codificar</span>
                </h2>
                <!-- Monaco Editor se cargará aquí cuando se necesite -->
                <div id="monaco-editor" class="h-full w-full hidden"></div>
            </div>

            <!-- Preview Panel -->
            <div id="preview-container" class="bg-white h-0 overflow-hidden transition-all duration-300">
                <iframe id="preview-frame" class="w-full h-full border-none"></iframe>
            </div>

            <!-- Terminal/Output Panel -->
            <div id="terminal-panel"
                class="bg-dark-800 border-t border-dark-700 h-0 overflow-hidden transition-all duration-300">
                <!-- Terminal Tabs -->
                <div class="bg-dark-800 flex border-b border-dark-700">
                    <button class="terminal-tab px-4 py-2 text-sm font-medium border-b-2 border-accent-purple text-white" data-tab="terminal">
                        Terminal
                    </button>
                    <button class="terminal-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white" data-tab="console">
                        Consola
                    </button>
                    <button class="terminal-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white" data-tab="problems">
                        Problemas
                    </button>
                </div>

                <!-- Terminal Content -->
                <div id="terminal-content" class="p-3 font-mono text-sm h-full overflow-y-auto">
                    <div class="text-green-400">$ Listo para ejecutar código</div>
                    <div class="mt-4 flex items-center">
                        <span class="text-green-400">$</span>
                        <span id="terminal-cursor" class="terminal-cursor ml-1">_</span>
                    </div>
                </div>

                <!-- Console Content -->
                <div id="console-content" class="p-3 font-mono text-sm h-full overflow-y-auto hidden">
                    <div class="text-gray-400">La consola está lista. Los errores y logs aparecerán aquí.</div>
                </div>


                <!-- Problems Content -->
                <div id="problems-content" class="p-3 font-mono text-sm h-full overflow-y-auto hidden">
                    <div class="text-gray-400">tu codigo no tiene problemas parece estar todo ok</div>
                </div>
            </div>
        </main>

        <!-- Quick Access Panel (Right Sidebar) -->
        <aside id="quick-access" class="bg-dark-800 w-48 border-l border-dark-dark-700 flex flex-col">
            <div class="px-4 py-3 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-sm font-semibold uppercase tracking-wider text-gray-400">Accesos</h3>

            </div>

            <div class="flex-1 overflow-y-auto py-2 px-2">
                <!-- Color Picker -->
                <div id="color-picker-container" class="mb-4">
                    <input type="text" id="color-picker" class="w-full" />
                </div>

                <!-- Quick Insert Buttons -->
                <div class="mb-4">
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">INSERTAR</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded rounded hover:bg-dark-600 hover:text-white" data-insert="{">{</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="}">}</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="[">[</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="]">]</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="(">(</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert=")">)</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="'">'</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert='"'>"</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="`">`</button>

                    </div>
                </div>

                <!-- Code Actions -->
                <div>
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">ACCIONES</h4>
                    <div class="space-y-2">
                        <button id="comment-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">
                            <i class="fas fa-comment mr-2 text-gray-400"></i>
                            Comentar
                        </button>
                        <button id="format-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">
                            <i class="fas fa-align-left mr-2 text-gray-400"></i>
                            Formatear
                        </button>
                        <button id="copy-all-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">
                            <i class="fas fa-copy mr-2 text-gray-400"></i>
                            Copiar todo
                        </button>
                        <button id="format-css-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">Formatear CSS</button>
                    </div>
                </div>
            </div>
            <button id="close-quick-access" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700">
                <i class="fas fa-times text-sm"></i>
            </button>
        </aside>
    </div>


    <!-- Modals -->
    <!-- New Folder Modal -->
    <div id="new-folder-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Nueva Carpeta</h3>
                <button id="close-new-folder-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="folder-name" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 mb-4 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="Nombre de la carpeta">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-new-folder" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="create-folder" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Crear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div id="new-file-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Nuevo Archivo</h3>
                <button id="close-new-file-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="file-name" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 mb-4 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="Nombre del archivo (ej. index.html)">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-new-file" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="create-file" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Crear
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="new-principal-folder-modal"
        class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Nueva Carpeta Principal</h3>
                <button id="close-new-principal-folder-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="principal-folder-name" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 mb-4 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="Nombre de la carpeta principal">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-new-principal-folder" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="create-principal-folder" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purpleple-600 text-white">
                        Crear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Importar Carpeta</h3>
                <button id="close-import-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Seleccionar carpeta para importar</label>
                    <input type="file" id="file-import" class="hidden" multiple webkitdirectory>
                    <button id="browse-files" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 text-sm hover:bg-dark-600">
                        <i class="fas fa-folder-open mr-2"></i> Seleccionar carpeta
                    </button>
                    <p class="text-xs text-gray-500 mt-2">Se importará toda la estructura de la carpeta seleccionada.
                    </p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-import" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Exportar Proyecto</h3>
                <button id="close-export-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Seleccionar carpeta</label>
                    <select id="export-folder-select" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                        <!-- Solo se cargarán las carpetas principales aquí -->
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-export" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="confirm-export" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Exportar
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Code Actions Modal -->
    <div id="code-actions-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-full max-w-2xl md:w-1/2 md:max-w-2xl">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Acciones de Código</h3>
                <button id="close-code-actions-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <textarea id="code-textarea" class="w-full h-64 bg-dark-700 border border-dark-600 rounded px-3 py-2 font-mono text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple"></textarea>
                <div class="flex justify-end space-x-2 mt-4">
                    <button id="copy-code" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        <i class="fas fa-copy mr-2"></i> Copiar
                    </button>
                    <button id="paste-code" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        <i class="fas fa-paste mr-2"></i> Pegar
                    </button>
                    <button id="insert-code" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        <i class="fas fa-code mr-2"></i> Insertar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Iniciar sesión / Registrarse</h3>
                <button id="close-auth-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div id="auth-tabs" class="flex border-b border-dark-700 mb-4">
                    <button class="auth-tab px-4 py-2 text-sm font-medium border-b-2 border-accent-purple text-white" data-tab="login">
                        Iniciar sesión
                    </button>
                    <button class="auth-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white" data-tab="signup">
                        Registrarse
                    </button>
                </div>

                <!-- Login Form -->
                <div id="login-content" class="auth-content">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Correo electrónico</label>
                        <input type="email" id="login-email" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="tu@email.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Contraseña</label>
                        <input type="password" id="login-password" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="••••••••">
                    </div>
                    <div id="login-error" class="hidden mt-4 p-3 bg-red-500/20 text-red-400 rounded text-sm"></div>
                    <button id="login-btn" class="w-full mt-4 bg-accent-purple text-white px-4 py-2 rounded hover:bg-purple-600">
                        Iniciar sesión
                    </button>
                </div>

                <!-- Signup Form -->
                <div id="signup-content" class="auth-content hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Correo electrónico</label>
                        <input type="email" id="signup-email" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="tu@email.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Contraseña</label>
                        <input type="password" id="signup-password" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="••••••••">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-2">Confirmar contraseña</label>
                        <input type="password" id="signup-confirm" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="••••••••">
                    </div>
                    <div id="signup-error" class="hidden mt-4 p-3 bg-red-500/20 text-red-400 rounded text-sm"></div>
                    <button id="signup-btn" class="w-full mt-4 bg-accent-purple text-white px-4 py-2 rounded hover:bg-purple-600">
                        Registrarse
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div
            class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-11/12 max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Configuración del Editor</h3>
                <button id="close-config-modal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
            </div>

            <div class="flex-1 overflow-y-auto">
                <!-- Tabs de configuración -->
                <div class="border-b border-dark-700 flex">
                    <button class="config-tab px-4 py-3 text-sm font-medium border-b-2 border-accent-purple text-white" data-tab="editor">
                    Editor
                </button>
                    <button class="config-tab px-4 py-3 text-sm font-medium text-gray-400 hover:text-white" data-tab="colors">
                    Colores
                </button>
                    <button class="config-tab px-4 py-3 text-sm font-medium text-gray-400 hover:text-white" data-tab="advanced">
                    Avanzado
                </button>
                </div>

                <!-- Contenido de las pestañas -->
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Pestaña Editor -->
                    <div id="editor-config-content" class="config-content">
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-400 mb-4">APARIENCIA</h4>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Tema de la interfaz</label>
                                    <select id="ui-theme" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                    <option value="dark">Oscuro</option>
                                    <option value="light">Claro</option>
                                </select>
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Tamaño de fuente</label>
                                    <select id="font-size" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                    <option value="12">12px</option>
                                    <option value="14" selected>14px</option>
                                    <option value="16">16px</option>
                                    <option value="18">18px</option>
                                    <option value="20">20px</option>
                                </select>
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Familia de fuente</label>
                                    <select id="font-family" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                    <option value="'Fira Code', monospace">Fira Code</option>
                                    <option value="'Courier New', monospace">Courier New</option>
                                    <option value="'Consolas', monospace">Consolas</option>
                                    <option value="'Source Code Pro', monospace">Source Code Pro</option>
                                </select>
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Altura de línea</label>
                                    <select id="line-height" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                    <option value="1.2">Compacto (1.2)</option>
                                    <option value="1.5" selected>Normal (1.5)</option>
                                    <option value="1.8">Amplio (1.8)</option>
                                </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-400 mb-4">COMPORTAMIENTO</h4>

                            <div class="space-y-3">
                                <label class="flex items-center space-x-3">
                                <input type="checkbox" id="word-wrap" class="form-checkbox h-4 w-4 text-accent-purple rounded focus:ring-accent-purple">
                                <span class="text-sm">Word Wrap (Ajuste de línea)</span>
                            </label>

                                <label class="flex items-center space-x-3">
                                <input type="checkbox" id="auto-closing" class="form-checkbox h-4 w-4 text-accent-purple rounded focus:ring-accent-purple" checked>
                                <span class="text-sm">Cierre automático de llaves/corchetes</span>
                            </label>

                                <label class="flex items-center space-x-3">
                                <input type="checkbox" id="auto-indent" class="form-checkbox h-4 w-4 text-accent-purple rounded focus:ring-accent-purple" checked>
                                <span class="text-sm">Autoindentación</span>
                            </label>

                                <label class="flex items-center space-x-3">
                                <input type="checkbox" id="format-on-save" class="form-checkbox h-4 w-4 text-accent-purple rounded focus:ring-accent-purple">
                                <span class="text-sm">Formatear al guardar</span>
                            </label>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña Colores -->
                    <div id="colors-config-content" class="config-content hidden">
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-400 mb-4">PRESETS DE COLORES</h4>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button class="color-preset-btn p-3 rounded border border-dark-700 hover:border-accent-purple" data-preset="default">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full bg-accent-purple"></div>
                                    <div class="w-4 h-4 rounded-full bg-accent-pink"></div>
                                    <div class="w-4 h-4 rounded-full bg-accent-teal"></div>
                                </div>
                                <span class="text-xs mt-1 block">Default</span>
                            </button>

                                <button class="color-preset-btn p-3 rounded border border-dark-700 hover:border-accent-purple" data-preset="feminine">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full bg-pink-400"></div>
                                    <div class="w-4 h-4 rounded-full bg-purple-400"></div>
                                    <div class="w-4 h-4 rounded-full bg-fuchsia-400"></div>
                                </div>
                                <span class="text-xs mt-1 block">Femenino</span>
                            </button>

                                <button class="color-preset-btn p-3 rounded border border-dark-700 hover:border-accent-purple" data-preset="professional">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                                    <div class="w-4 h-4 rounded-full bg-gray-500"></div>
                                    <div class="w-4 h-4 rounded-full bg-green-500"></div>
                                </div>
                                <span class="text-xs mt-1 block">Profesional</span>
                            </button>

                                <button class="color-preset-btn p-3 rounded border border-dark-700 hover:border-accent-purple" data-preset="vibrant">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 rounded-full bg-yellow-400"></div>
                                    <div class="w-4 h-4 rounded-full bg-orange-500"></div>
                                    <div class="w-4 h-4 rounded-full bg-red-500"></div>
                                </div>
                                <span class="text-xs mt-1 block">Vibrante</span>
                            </button>
                            </div>

                            <h4 class="text-sm font-semibold text-gray-400 mb-4">PERSONALIZAR COLORES</h4>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Color de texto</label>
                                    <input type="color" id="text-color" class="w-8 h-8 rounded cursor-pointer" value="#f8f8f2">
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Fondo del editor</label>
                                    <input type="color" id="editor-bg" class="w-8 h-8 rounded cursor-pointer" value="#282a36">
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Color de palabras clave</label>
                                    <input type="color" id="keyword-color" class="w-8 h-8 rounded cursor-pointer" value="#ff79c6">
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Color de strings</label>
                                    <input type="color" id="string-color" class="w-8 h-8 rounded cursor-pointer" value="#f1fa8c">
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Color de números</label>
                                    <input type="color" id="number-color" class="w-8 h-8 rounded cursor-pointer" value="#bd93f9">
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Color de comentarios</label>
                                    <input type="color" id="comment-color" class="w-8 h-8 rounded cursor-pointer" value="#6272a4">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña Avanzado -->
                    <div id="advanced-config-content" class="config-content hidden">
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-400 mb-4">AJUSTES AVANZADOS</h4>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Tamaño de tabulación</label>
                                    <select id="tab-size" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                    <option value="2">2 espacios</option>
                                    <option value="4" selected>4 espacios</option>
                                    <option value="8">8 espacios</option>
                                </select>
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Tipo de tabulación</label>
                                    <select id="insert-spaces" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                    <option value="true">Espacios</option>
                                    <option value="false">Tabulación real</option>
                                </select>
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm">Límite de columna</label>
                                    <input type="number" id="column-limit" min="0" max="200" value="80" class="bg-dark-700 border border-dark-600 rounded px-3 py-1 text-sm w-20 focus:outline-none focus:ring-1 focus:ring-accent-purple">
                                </div>

                                <div class="pt-4 border-t border-dark-700">
                                    <button id="reset-config" class="px-4 py-2 text-sm rounded bg-red-500 hover:bg-red-600 text-white">
                                    Restablecer configuración
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-dark-700 flex justify-end">
                <button id="save-config" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                Guardar cambios
            </button>
            </div>
        </div>
    </div>
    <!-- Status Bar -->
    <footer
        class="bg-dark-800 border-t border-dark-700 px-3 py-1 flex items-center justify-between text-xs text-gray-400">
        <div class="flex items-center space-x-4">
            <div class="flex items-center">
                <i class="fas fa-code-branch mr-1"></i>
                <span>main</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-circle text-green-500 mr-1"></i>
                <span id="status-message">Ready</span>
            </div>
        </div>

        <div class="flex items-center space-x-4">
            <div class="flex items-center">
                <i class="fas fa-laptop-code mr-1"></i>
                <span>UTF-8</span>
            </div>
            <div class="flex items-center">
                <i class="fab fa-js mr-1"></i>
                <span id="current-file-type">JavaScript</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-clock mr-1"></i>
                <span id="current-time">00:00</span>
            </div>
        </div>
    </footer>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 flex flex-col space-y-3 z-10">
        <!-- Run Button -->
        <button id="run-btn" class="fab w-12 h-12 rounded-full bg-accent-purple text-white flex items-center justify-center shadow-lg hover:bg-purple-600 tooltip">
        <i class="fas fa-play"></i>
        
    </button>

        <!-- Terminal Toggle -->
        <button id="terminal-toggle" class="fab w-12 h-12 rounded-full bg-dark-700 text-gray-300 flex items-center justify-center shadow-lg hover:bgbg-dark-600 hover:text-white tooltip">
        <i class="fas fa-terminal"></i>
        
    </button>

        <!-- Quick Access Toggle -->
        <button id="quick-access-toggle" class="fab w-12 h-12 rounded-full bg-dark-700 text-gray-300 flex items-center justify-center shadow-lg hover:bg-dark-600 hover:text-white tooltip">
        <i class="fas fa-bolt"></i>
        
    </button>
    </div>

    <!-- Firebase App (el núcleo de Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>

    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <!-- Firestore Database (Reemplaza Realtime Database) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    <!-- Main App Script -->
    <script>
        // script.js


window.addEventListener('beforeunload', async function (e) {
    // Solo guardar en Local Storage si no hay usuario autenticado
    if (!currentUser) {
        localStorage.setItem('bustosCodeState', JSON.stringify({
            projectStructure,
            folderCode,
            activeFolderPath,
            activeFile,
            openTabs,
            theme: currentTheme,
            expandedFolders,
            lastUpdated: Date.now()
        }));
    }

    // Si estamos online y autenticados, intentar guardar en Firestore
    if (isOnline && currentUser) {
        try {
            await db.collection('users').doc(currentUser.uid)
                .collection('projects').doc('default')
                .set({
                    projectStructure,
                    folderCode,
                    activeFolderPath,
                    activeFile,
                    openTabs,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
        } catch (error) {
            console.error('Error al guardar en Firebase antes de salir:', error);
        }
    }
});

// Global variables
let expandedFolders = {};
let editor = null;
let consoleRedirected = false;
let currentTheme = 'dark';
let projectStructure = {
    name: 'root',
    type: 'folder',
    children: []
};
let folderCode = {};
let activeFolderPath = null;
let activeFolder = activeFolderPath;
let activeFile = null;
let openTabs = [];
let monacoInitialized = false;
let isPreviewVisible = false;
// --- 1. Configuración inicial ---
const firebaseConfig = {
    apiKey: "AIzaSyAPqX2ScjLut1-aDWeDjBFhm8i8GzdviLs",
    authDomain: "bcode-9e8f1.firebaseapp.com",
    projectId: "bcode-9e8f1",
    storageBucket: "bcode-9e8f1.appspot.com",
    messagingSenderId: "451286588637",
    appId: "1:451286588637:web:41b4d0a0251e74e49ccf34",
    measurementId: "G-L5WHY20NHN"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

db.enablePersistence()
    .catch((err) => {
        if (err.code == 'failed-precondition') {
            console.log('Persistencia no disponible en múltiples pestañas');
        } else if (err.code == 'unimplemented') {
            console.log('Persistencia no soportada en este navegador');
        }
    });

// Estado de autenticación
let currentUser = null;
let isOnline = false;

// Configuración por defecto
const defaultConfig = {
    uiTheme: 'dark',
    editorTheme: 'bustoscode-dark',
    fontSize: 14,
    fontFamily: "'Fira Code', monospace",
    lineHeight: 1.5,
    wordWrap: false,
    autoClosing: true,
    autoIndent: true,
    formatOnSave: false,
    colors: {
        text: '#f8f8f2',
        editorBg: '#282a36',
        keyword: '#ff79c6',
        string: '#f1fa8c',
        number: '#bd93f9',
        comment: '#6272a4'
    },
    tabSize: 4,
    insertSpaces: true,
    columnLimit: 0
};
function applyVSCODETheme() {
    // Colores EXACTOS de VS Code Dark
    const vsCodeColors = {
        text: '#d4d4d4',
        editorBg: '#282a36',
        keyword: '#569cd6',
        string: '#ce9178',
        number: '#b5cea8',
        comment: '#6a9955',
        delimiter: '#d4d4d4',
        tag: '#4ec9b0'
    };

    // Aplicar al body
    document.body.className = 'theme-dark';

    // Actualizar inputs
    document.getElementById('text-color').value = vsCodeColors.text;
    document.getElementById('keyword-color').value = vsCodeColors.keyword;
    document.getElementById('string-color').value = vsCodeColors.string;
    document.getElementById('number-color').value = vsCodeColors.number;
    document.getElementById('comment-color').value = vsCodeColors.comment;
    document.getElementById('editor-bg').value = vsCodeColors.editorBg;

    // Configurar Monaco
    monaco.editor.defineTheme('vscode-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
            { token: 'comment', foreground: vsCodeColors.comment, fontStyle: 'italic' },
            { token: 'keyword', foreground: vsCodeColors.keyword },
            { token: 'string', foreground: vsCodeColors.string },
            { token: 'number', foreground: vsCodeColors.number },
            { token: 'delimiter.html', foreground: vsCodeColors.delimiter },
            { token: 'tag.html', foreground: vsCodeColors.tag }
        ],
        colors: {
            'editor.foreground': vsCodeColors.text,
            'editor.background': vsCodeColors.editorBg,
            'editorLineNumber.foreground': '#858585',
            'editor.lineHighlightBackground': '#2a2a2a'
        }
    });

    monaco.editor.setTheme('vscode-dark');
    if (editor) editor.layout();
}
// Cargar configuración desde localStorage
function loadConfig() {
    const savedConfig = localStorage.getItem('bcodeEditorConfig');
    return savedConfig ? JSON.parse(savedConfig) : { ...defaultConfig };
}

// Guardar configuración en localStorage
function saveConfig(config) {
    localStorage.setItem('bcodeEditorConfig', JSON.stringify(config));
}

// Aplicar configuración al editor
function applyConfig(config) {
    // Aplicar tema de la interfaz
    document.body.classList.toggle('bg-gray-100', config.uiTheme === 'light');
    document.body.classList.toggle('text-gray-800', config.uiTheme === 'light');

    // Aplicar configuración del editor
    if (editor) {
        editor.updateOptions({
            fontSize: config.fontSize,
            fontFamily: config.fontFamily,
            lineHeight: config.lineHeight,
            wordWrap: config.wordWrap ? 'on' : 'off',
            autoClosingBrackets: config.autoClosing ? 'always' : 'never',
            autoIndent: config.autoIndent ? 'full' : 'none',
            tabSize: config.tabSize,
            insertSpaces: config.insertSpaces,
            rulers: config.columnLimit > 0 ? [config.columnLimit] : []
        });

        // Aplicar tema de colores personalizado
        monaco.editor.defineTheme('bcode-custom', {
            base: config.uiTheme === 'light' ? 'vs' : 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: config.colors.comment, fontStyle: 'italic' },
                { token: 'keyword', foreground: config.colors.keyword },
                { token: 'number', foreground: config.colors.number },
                { token: 'string', foreground: config.colors.string },
                { token: 'type', foreground: config.colors.type || '#8be9fd' },
                { token: 'delimiter.html', foreground: config.colors.delimiter || '#ffb86c' }
            ],
            colors: {
                'editor.background': config.colors.editorBg,
                'editor.foreground': config.colors.text,
                'editor.lineHighlightBackground': config.colors.editorBg === '#282a36' ? '#282a36' : '#f0f0f0',
                'editor.selectionBackground': '#44475a80'
            }
        });

        monaco.editor.setTheme('bcode-custom');
    }
}
const HF_TOKEN = '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';
const HF_MODELS = {
    CODE: 'bigcode/starcoder',
    CHAT: 'OpenAssistant/oasst-sft-4-pythia-12b-epoch-3.5',
    DEFAULT: 'gpt2'
};

let currentAIModel = HF_MODELS.CODE;

async function queryHFAPI(data, retries = 3, delay = 1000) {
    try {
        const response = await fetch(`https://api-inference.huggingface.co/models/${currentAIModel}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${HF_TOKEN}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            if (response.status === 503 && retries > 0) { // Modelo cargando
                await new Promise(resolve => setTimeout(resolve, delay));
                return queryHFAPI(data, retries - 1, delay * 2);
            }
            throw new Error(`Error HTTP: ${response.status}`);
        }

        return await response.json();
    } catch (error) {
        console.error('Error en la API:', error);
        throw error;
    }
}

async function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const message = input.value.trim();
    const chat = document.getElementById('ai-chat');

    if (!message) return;

    // Mostrar mensaje de usuario
    chat.innerHTML += `
        <div class="bg-dark-700 rounded-lg p-3 mb-3 text-right">
            <div class="text-xs text-gray-400 mb-1">Tú:</div>
            <p class="text-sm">${message}</p>
        </div>
    `;

    // Mostrar indicador de carga
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'bg-dark-700 rounded-lg p-3 mb-3';
    loadingMsg.innerHTML = `
        <div class="text-xs text-gray-400 mb-1">AI:</div>
        <div class="flex items-center text-sm">
            <div class="loader-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    `;
    chat.appendChild(loadingMsg);
    chat.scrollTop = chat.scrollHeight;

    try {
        // Seleccionar modelo según contexto
        const isCodeRequest = message.toLowerCase().includes('código') ||
            message.toLowerCase().includes('programa') ||
            message.toLowerCase().includes('error');

        currentAIModel = isCodeRequest ? HF_MODELS.CODE : HF_MODELS.CHAT;

        const response = await queryHFAPI({
            inputs: `Como experto en desarrollo web y asistente de programación, responde: ${message}`,
            parameters: {
                max_new_tokens: 500,
                temperature: 0.7,
                return_full_text: false
            }
        });

        loadingMsg.remove();

        // Procesar respuesta
        const aiResponse = response[0]?.generated_text || 'No pude generar una respuesta.';

        chat.innerHTML += `
            <div class="bg-dark-700 rounded-lg p-3 mb-3">
                <div class="text-xs text-gray-400 mb-1">AI:</div>
                <pre class="text-sm whitespace-pre-wrap">${formatAIResponse(aiResponse)}</pre>
            </div>
        `;

    } catch (error) {
        loadingMsg.remove();
        chat.innerHTML += `
            <div class="bg-dark-700 rounded-lg p-3 mb-3">
                <div class="text-xs text-red-400 mb-1">Error:</div>
                <p class="text-sm">${error.message}</p>
            </div>
        `;
    }

    input.value = '';
    chat.scrollTop = chat.scrollHeight;
}

function formatAIResponse(text) {
    // Mejorar formato de código en las respuestas
    return text.replace(/```([\s\S]*?)```/g, (match, code) => {
        return `<code class="block bg-dark-800 p-2 rounded my-2">${code.trim()}</code>`;
    });
}

// Configurar el modal de configuración
function setupConfigModal() {
    const config = loadConfig();

    // Mostrar/ocultar modal
    document.getElementById('config-toggle').addEventListener('click', () => {
        document.getElementById('config-modal').classList.remove('hidden');
        loadCurrentConfigToForm();
    });

    document.getElementById('close-config-modal').addEventListener('click', () => {
        document.getElementById('config-modal').classList.add('hidden');
    });

    // Cambiar entre pestañas
    document.querySelectorAll('.config-tab').forEach(tab => {
        tab.addEventListener('click', function () {
            const tabName = this.getAttribute('data-tab');

            // Actualizar pestañas
            document.querySelectorAll('.config-tab').forEach(t => {
                t.classList.remove('border-accent-purple', 'text-white');
                t.classList.add('text-gray-400');
            });
            this.classList.add('border-accent-purple', 'text-white');

            // Actualizar contenido
            document.querySelectorAll('.config-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-config-content`).classList.remove('hidden');
        });
    });

    // Presets de colores
    document.querySelectorAll('.color-preset-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const preset = this.getAttribute('data-preset');
            document.body.className = `theme-${preset}`;
            if (preset === 'default') {
                applyVSCODETheme();
                showStatusMessage('Tema VS Code Dark aplicado', 'success');
                return;
            }
            // 1. Limpiar clases y aplicar tema
            document.body.className = `theme-${preset}`;

            // 2. Obtener colores REALES del CSS
            const style = getComputedStyle(document.body);
            const colors = {
                text: style.getPropertyValue('--text-color').trim(),
                editorBg: style.getPropertyValue('--background-color').trim(),
                keyword: style.getPropertyValue('--keyword-color').trim(),
                string: style.getPropertyValue('--string-color').trim(),
                number: style.getPropertyValue('--number-color').trim(),
                comment: style.getPropertyValue('--comment-color').trim(),
                delimiter: style.getPropertyValue('--delimiter-color').trim(),
                tag: style.getPropertyValue('--tag-color').trim()
            };

            // 3. Actualizar inputs de color
            const setColorValue = (id, color) => {
                const input = document.getElementById(id);
                input.value = color.startsWith('#') ? color : rgbToHex(color);
            };

            setColorValue('text-color', colors.text);
            setColorValue('keyword-color', colors.keyword);
            setColorValue('string-color', colors.string);
            setColorValue('number-color', colors.number);
            setColorValue('comment-color', colors.comment);
            setColorValue('editor-bg', colors.editorBg);

            // 4. Configurar Monaco CON LOS COLORES DEL CSS
            monaco.editor.defineTheme(`active-theme`, {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: colors.comment, fontStyle: 'italic' },
                    { token: 'keyword', foreground: colors.keyword },
                    { token: 'string', foreground: colors.string },
                    { token: 'number', foreground: colors.number },
                    { token: 'delimiter.html', foreground: colors.delimiter },
                    { token: 'tag.html', foreground: colors.tag }
                ],
                colors: {
                    'editor.foreground': colors.text,
                    'editor.background': colors.editorBg,
                    'editorLineNumber.foreground': colors.comment,
                    'editor.lineHighlightBackground': `${colors.editorBg}80`
                }
            });

            monaco.editor.setTheme(`active-theme`);
            if (editor) setTimeout(() => editor.layout(), 100);

            showStatusMessage(`Tema ${preset} aplicado`, 'success');
        });
    });

    // Función de conversión RGB/HSL a HEX
    function rgbToHex(color) {
        const div = document.createElement('div');
        div.style.color = color;
        document.body.appendChild(div);
        const rgb = getComputedStyle(div).color;
        document.body.removeChild(div);

        const [r, g, b] = rgb.match(/\d+/g).map(n => parseInt(n));
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }

    // Función para asegurar fondos oscuros
    function oscurecerColor(color) {
        const coloresOscuros = {
            '#ffffff': '#1e1e1e',    // Blanco -> Oscuro
            '#f8f8f2': '#282a36',    // Fondo original claro -> Oscuro
            '#2a1e28': '#1a121a',    // Fondo femenino más oscuro
            '#1a1a1a': '#0a0a0a'     // Vibrante más oscuro
        };
        return coloresOscuros[color] || color;
    }
    // Guardar configuración
    document.getElementById('save-config').addEventListener('click', () => {
        const newConfig = {
            uiTheme: document.getElementById('ui-theme').value,
            fontSize: parseInt(document.getElementById('font-size').value),
            fontFamily: document.getElementById('font-family').value,
            lineHeight: parseFloat(document.getElementById('line-height').value),
            wordWrap: document.getElementById('word-wrap').checked,
            autoClosing: document.getElementById('auto-closing').checked,
            autoIndent: document.getElementById('auto-indent').checked,
            formatOnSave: document.getElementById('format-on-save').checked,
            colors: {
                text: document.getElementById('text-color').value,
                editorBg: document.getElementById('editor-bg').value,
                keyword: document.getElementById('keyword-color').value,
                string: document.getElementById('string-color').value,
                number: document.getElementById('number-color').value,
                comment: document.getElementById('comment-color').value
            },
            tabSize: parseInt(document.getElementById('tab-size').value),
            insertSpaces: document.getElementById('insert-spaces').value === 'true',
            columnLimit: parseInt(document.getElementById('column-limit').value)
        };

        saveConfig(newConfig);
        applyConfig(newConfig);
        document.getElementById('config-modal').classList.add('hidden');
        showStatusMessage('Configuración guardada', 'success');
    });

    // Restablecer configuración
    document.getElementById('reset-config').addEventListener('click', () => {
        if (confirm('¿Estás seguro de que quieres restablecer toda la configuración a los valores predeterminados?')) {
            saveConfig({ ...defaultConfig });
            applyConfig(defaultConfig);
            loadCurrentConfigToForm();
            showStatusMessage('Configuración restablecida', 'success');
        }
    });
}

// Cargar configuración actual al formulario
function loadCurrentConfigToForm() {
    const config = loadConfig();

    document.getElementById('ui-theme').value = config.uiTheme;
    document.getElementById('font-size').value = config.fontSize;
    document.getElementById('font-family').value = config.fontFamily;
    document.getElementById('line-height').value = config.lineHeight;
    document.getElementById('word-wrap').checked = config.wordWrap;
    document.getElementById('auto-closing').checked = config.autoClosing;
    document.getElementById('auto-indent').checked = config.autoIndent;
    document.getElementById('format-on-save').checked = config.formatOnSave;

    document.getElementById('text-color').value = config.colors.text;
    document.getElementById('editor-bg').parentElement.style.display = 'none';
    document.getElementById('keyword-color').value = config.colors.keyword;
    document.getElementById('string-color').value = config.colors.string;
    document.getElementById('number-color').value = config.colors.number;
    document.getElementById('comment-color').value = config.colors.comment;

    document.getElementById('tab-size').value = config.tabSize;
    document.getElementById('insert-spaces').value = config.insertSpaces.toString();
    document.getElementById('column-limit').value = config.columnLimit;
}


// Initialize the app
function init() {
    // Load saved state
    loadState();

    // Initialize Monaco Editor
    initMonaco();

    // Setup event listeners
    setupEventListeners();
    setupConfigModal();
    applyConfig(loadConfig());
    // Update clock
    updateClock();
    setInterval(updateClock, 60000);

    // Observador de estado de autenticación
    auth.onAuthStateChanged((user) => {
        currentUser = user;
        showAuthUI();

        if (user) {
            // Usuario autenticado - cargar estado
            loadState();
        } else {
            // Usuario no autenticado - cargar solo de localStorage
            const localState = localStorage.getItem('bustosCodeState');
            if (localState) {
                const state = JSON.parse(localState);
                // Cargar estado local sin datos de Firebase
            }
        }
    });

    // Initialize color picker
    $("#color-picker").spectrum({
        color: "#bd93f9",
        preferredFormat: "hex",
        showInput: true,
        showPalette: true,
        palette: [
            ["#000000", "#44475a", "#6272a4", "#bd93f9"],
            ["#ff5555", "#ff79c6", "#ffb86c", "#f1fa8c"],
            ["#50fa7b", "#8be9fd", "#282a36", "#f8f8f2"]
        ],
        change: function (color) {
            if (editor) {
                const selection = editor.getSelection();
                const range = new monaco.Range(
                    selection.startLineNumber,
                    selection.startColumn,
                    selection.endLineNumber,
                    selection.endColumn
                );
                editor.executeEdits("", [{
                    range: range,
                    text: color.toHexString(),
                    forceMoveMarkers: true
                }]);
            }
        }

    });


    window.addEventListener('message', function (e) {
        if (!e.data || !e.data.type) return;
        const consoleContent = document.getElementById('console-content');
        switch (e.data.type) {
            case 'iframe-error':
                appendToConsole('error',
                    `${e.data.message}\n${e.data.error || ''}`,
                    e.data.filename,
                    e.data.lineno,
                    e.data.colno
                );
                break;

            case 'iframe-promise-error':
                appendToConsole('error',
                    `Unhandled promise rejection: ${e.data.message}\n${e.data.stack || ''}`
                );
                break;

            case 'iframe-console':
                const args = e.data.args.map(arg => {
                    try { return JSON.parse(arg); }
                    catch { return arg; }
                });
                appendToConsole(e.data.method, args.join(' '));
                break;
        }
    });

}
function applyFeminineColors() {
    const style = document.createElement('style');
    style.id = 'feminine-colors';
    style.innerHTML = `
        .monaco-editor .tag { color: #bd93f9; }
        .monaco-editor .angle-bracket { color: #bd93f9; }
        .monaco-editor .identifier { color: #ff79c6; }
        .monaco-editor .keyword { color: #ff79c6; }
    `;
    document.head.appendChild(style);
}
// Initialize Monaco Editor
function initMonaco() {
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });

    require(['vs/editor/editor.main'], function () {
        monacoInitialized = true;
        const language = 'html';  // Asegúrate de que esta variable esté definida
monaco.languages.registerCompletionItemProvider(language, {
    provideCompletionItems: function (model, position) {
        const wordInfo = model.getWordUntilPosition(position);
        const range = new monaco.Range(position.lineNumber, wordInfo.startColumn, position.lineNumber, wordInfo.endColumn);

        const keywords = [
                        {
                "label": "html5",
                "documentation": "Crear estructura básica de HTML5",
                "insertText": "<!DOCTYPE html>\n<html lang=\"${1:es}\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>${2:Título de la página}</title>\n</head>\n<body>\n  ${3:Contenido}\n</body>\n</html>",
                "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                {
                    "label": "div",
                    "documentation": "Crear un elemento div",
                    "insertText": "<div>${1:content}</div>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "span",
                    "documentation": "Crear un elemento span",
                    "insertText": "<span>${1:content}</span>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "p",
                    "documentation": "Crear un párrafo",
                    "insertText": "<p>${1:text}</p>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "a",
                    "documentation": "Crear un enlace",
                    "insertText": "<a href=\"${1:url}\">${2:text}</a>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "img",
                    "documentation": "Insertar una imagen",
                    "insertText": "<img src=\"${1:source}\" alt=\"${2:description}\"/>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "ul",
                    "documentation": "Lista desordenada",
                    "insertText": "<ul>\n\t<li>${1:item1}</li>\n\t<li>${2:item2}</li>\n</ul>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "ol",
                    "documentation": "Lista ordenada",
                    "insertText": "<ol>\n\t<li>${1:item1}</li>\n\t<li>${2:item2}</li>\n</ol>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "table",
                    "documentation": "Crear una tabla",
                    "insertText": "<table>\n\t<tr>\n\t\t<th>${1:Header1}</th>\n\t\t<th>${2:Header2}</th>\n\t</tr>\n\t<tr>\n\t\t<td>${3:Data1}</td>\n\t\t<td>${4:Data2}</td>\n\t</tr>\n</table>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "form",
                    "documentation": "Formulario",
                    "insertText": "<form action=\"${1:action}\" method=\"${2:get/post}\">\n\t${3:content}\n</form>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input",
                    "documentation": "Elemento input",
                    "insertText": "<input type=\"${1:text}\" name=\"${2:name}\" />",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "button",
                    "documentation": "Elemento botón",
                    "insertText": "<button type=\"${1:button}\">${2:Click me}</button>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "meta",
                    "documentation": "Meta etiqueta",
                    "insertText": "<meta charset=\"${1:UTF-8}\"/>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "link",
                    "documentation": "Enlace a stylesheet",
                    "insertText": "<link rel=\"stylesheet\" href=\"${1:styles.css}\" />",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "h1",
                    "documentation": "Encabezado nivel 1",
                    "insertText": "<h1>${1:Heading}</h1>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "h2",
                    "documentation": "Encabezado nivel 2",
                    "insertText": "<h2>${1:Heading}</h2>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "h3",
                    "documentation": "Encabezado nivel 3",
                    "insertText": "<h3>${1:Heading}</h3>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "h4",
                    "documentation": "Encabezado nivel 4",
                    "insertText": "<h4>${1:Heading}</h4>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "h5",
                    "documentation": "Encabezado nivel 5",
                    "insertText": "<h5>${1:Heading}</h5>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "h6",
                    "documentation": "Encabezado nivel 6",
                    "insertText": "<h6>${1:Heading}</h6>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "strong",
                    "documentation": "Texto en negrita",
                    "insertText": "<strong>${1:text}</strong>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "em",
                    "documentation": "Texto en énfasis (cursiva)",
                    "insertText": "<em>${1:text}</em>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "mark",
                    "documentation": "Texto resaltado",
                    "insertText": "<mark>${1:text}</mark>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "small",
                    "documentation": "Texto pequeño",
                    "insertText": "<small>${1:text}</small>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "del",
                    "documentation": "Texto eliminado",
                    "insertText": "<del>${1:text}</del>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "ins",
                    "documentation": "Texto insertado",
                    "insertText": "<ins>${1:text}</ins>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "sub",
                    "documentation": "Subíndice",
                    "insertText": "<sub>${1:text}</sub>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "sup",
                    "documentation": "Superíndice",
                    "insertText": "<sup>${1:text}</sup>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "code",
                    "documentation": "Código de computadora",
                    "insertText": "<code>${1:code}</code>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "pre",
                    "documentation": "Texto preformateado",
                    "insertText": "<pre>${1:code}</pre>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "blockquote",
                    "documentation": "Cita larga",
                    "insertText": "<blockquote cite=\"${1:source}\">\n\t${2:quote}\n</blockquote>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "q",
                    "documentation": "Cita corta",
                    "insertText": "<q cite=\"${1:source}\">${2:quote}</q>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "abbr",
                    "documentation": "Abreviatura",
                    "insertText": "<abbr title=\"${1:full}\">${2:abbr}</abbr>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "address",
                    "documentation": "Información de contacto",
                    "insertText": "<address>\n\t${1:contact info}\n</address>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "cite",
                    "documentation": "Título de un trabajo",
                    "insertText": "<cite>${1:title}</cite>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "bdo",
                    "documentation": "Dirección del texto",
                    "insertText": "<bdo dir=\"${1:rtl}\">${2:text}</bdo>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "kbd",
                    "documentation": "Entrada de teclado",
                    "insertText": "<kbd>${1:key}</kbd>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "samp",
                    "documentation": "Salida de muestra",
                    "insertText": "<samp>${1:sample}</samp>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "var",
                    "documentation": "Variable",
                    "insertText": "<var>${1:variable}</var>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "time",
                    "documentation": "Fecha/Hora",
                    "insertText": "<time datetime=\"${1:YYYY-MM-DD}\">${2:date}</time>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "a",
                    "documentation": "Enlace",
                    "insertText": "<a href=\"${1:url}\" target=\"${2:_blank}\" rel=\"${3:noopener}\">${4:text}</a>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "img",
                    "documentation": "Imagen",
                    "insertText": "<img src=\"${1:source}\" alt=\"${2:description}\" width=\"${3}\" height=\"${4}\"/>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "picture",
                    "documentation": "Imagen adaptable",
                    "insertText": "<picture>\n\t<source media=\"(min-width: ${1:650px})\" srcset=\"${2:large.jpg}\">\n\t<source media=\"(min-width: ${3:465px})\" srcset=\"${4:medium.jpg}\">\n\t<img src=\"${5:small.jpg}\" alt=\"${6:description}\">\n</picture>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "figure",
                    "documentation": "Figura con leyenda",
                    "insertText": "<figure>\n\t<img src=\"${1:image.jpg}\" alt=\"${2:description}\">\n\t<figcaption>${3:caption}</figcaption>\n</figure>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "audio",
                    "documentation": "Audio",
                    "insertText": "<audio controls>\n\t<source src=\"${1:audio.mp3}\" type=\"audio/mpeg\">\n\t${2:Your browser does not support the audio element.}\n</audio>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "video",
                    "documentation": "Video",
                    "insertText": "<video width=\"${1:320}\" height=\"${2:240}\" controls>\n\t<source src=\"${3:movie.mp4}\" type=\"video/mp4\">\n\t${4:Your browser does not support the video tag.}\n</video>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "source",
                    "documentation": "Fuente multimedia",
                    "insertText": "<source src=\"${1:file}\" type=\"${2:mime/type}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "track",
                    "documentation": "Pista de texto",
                    "insertText": "<track src=\"${1:subtitles.vtt}\" kind=\"${2:subtitles}\" srclang=\"${3:en}\" label=\"${4:English}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "map",
                    "documentation": "Mapa de imagen",
                    "insertText": "<map name=\"${1:mapname}\">\n\t<area shape=\"${2:rect}\" coords=\"${3:x1,y1,x2,y2}\" href=\"${4:link.html}\" alt=\"${5:description}\">\n</map>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "area",
                    "documentation": "Área en mapa de imagen",
                    "insertText": "<area shape=\"${1:rect}\" coords=\"${2:x1,y1,x2,y2}\" href=\"${3:link.html}\" alt=\"${4:description}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Listas
                {
                    "label": "ul",
                    "documentation": "Lista desordenada",
                    "insertText": "<ul>\n\t<li>${1:item1}</li>\n\t<li>${2:item2}</li>\n</ul>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "ol",
                    "documentation": "Lista ordenada",
                    "insertText": "<ol>\n\t<li>${1:item1}</li>\n\t<li>${2:item2}</li>\n</ol>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "li",
                    "documentation": "Elemento de lista",
                    "insertText": "<li>${1:item}</li>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "dl",
                    "documentation": "Lista de definición",
                    "insertText": "<dl>\n\t<dt>${1:term}</dt>\n\t<dd>${2:definition}</dd>\n</dl>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "dt",
                    "documentation": "Término en lista de definición",
                    "insertText": "<dt>${1:term}</dt>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "dd",
                    "documentation": "Definición en lista de definición",
                    "insertText": "<dd>${1:definition}</dd>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Tablas
                {
                    "label": "table",
                    "documentation": "Tabla",
                    "insertText": "<table>\n\t<thead>\n\t\t<tr>\n\t\t\t<th>${1:Header1}</th>\n\t\t\t<th>${2:Header2}</th>\n\t\t</tr>\n\t</thead>\n\t<tbody>\n\t\t<tr>\n\t\t\t<td>${3:Data1}</td>\n\t\t\t<td>${4:Data2}</td>\n\t\t</tr>\n\t</tbody>\n</table>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "caption",
                    "documentation": "Leyenda de tabla",
                    "insertText": "<caption>${1:table title}</caption>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "th",
                    "documentation": "Celda de encabezado",
                    "insertText": "<th scope=\"${1:col/row}\">${2:header}</th>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "tr",
                    "documentation": "Fila de tabla",
                    "insertText": "<tr>\n\t<td>${1:data}</td>\n</tr>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "td",
                    "documentation": "Celda de datos",
                    "insertText": "<td>${1:data}</td>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "thead",
                    "documentation": "Encabezado de tabla",
                    "insertText": "<thead>\n\t<tr>\n\t\t<th>${1:header}</th>\n\t</tr>\n</thead>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "tbody",
                    "documentation": "Cuerpo de tabla",
                    "insertText": "<tbody>\n\t<tr>\n\t\t<td>${1:data}</td>\n\t</tr>\n</tbody>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "tfoot",
                    "documentation": "Pie de tabla",
                    "insertText": "<tfoot>\n\t<tr>\n\t\t<td>${1:footer}</td>\n\t</tr>\n</tfoot>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "colgroup",
                    "documentation": "Grupo de columnas",
                    "insertText": "<colgroup>\n\t<col span=\"${1:2}\" style=\"background-color:${2:red}\">\n</colgroup>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "col",
                    "documentation": "Columna",
                    "insertText": "<col span=\"${1:1}\" style=\"background-color:${2:red}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Formularios avanzados
                {
                    "label": "form",
                    "documentation": "Formulario avanzado",
                    "insertText": "<form action=\"${1:script.php}\" method=\"${2:post}\" enctype=\"${3:multipart/form-data}\">\n\t${4:inputs}\n</form>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input",
                    "documentation": "Campo de entrada",
                    "insertText": "<input type=\"${1:text}\" name=\"${2:name}\" id=\"${3:id}\" placeholder=\"${4:placeholder}\" value=\"${5:value}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "textarea",
                    "documentation": "Área de texto",
                    "insertText": "<textarea name=\"${1:name}\" id=\"${2:id}\" rows=\"${3:4}\" cols=\"${4:50}\" placeholder=\"${5:placeholder}\">${6:text}</textarea>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "select",
                    "documentation": "Lista desplegable",
                    "insertText": "<select name=\"${1:name}\" id=\"${2:id}\">\n\t<option value=\"${3:value1}\">${4:Option 1}</option>\n\t<option value=\"${5:value2}\">${6:Option 2}</option>\n</select>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "optgroup",
                    "documentation": "Grupo de opciones",
                    "insertText": "<optgroup label=\"${1:Group}\">\n\t<option value=\"${2:value1}\">${3:Option 1}</option>\n</optgroup>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "option",
                    "documentation": "Opción en lista",
                    "insertText": "<option value=\"${1:value}\">${2:Text}</option>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "label",
                    "documentation": "Etiqueta para control de formulario",
                    "insertText": "<label for=\"${1:id}\">${2:Label text}</label>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "fieldset",
                    "documentation": "Grupo de controles de formulario",
                    "insertText": "<fieldset>\n\t<legend>${1:Title}</legend>\n\t${2:inputs}\n</fieldset>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "legend",
                    "documentation": "Título para fieldset",
                    "insertText": "<legend>${1:Title}</legend>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "datalist",
                    "documentation": "Lista de opciones para input",
                    "insertText": "<datalist id=\"${1:list}\">\n\t<option value=\"${2:Option1}\">\n\t<option value=\"${3:Option2}\">\n</datalist>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "output",
                    "documentation": "Resultado de cálculo",
                    "insertText": "<output name=\"${1:result}\" for=\"${2:input1 input2}\">${3:0}</output>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "meter",
                    "documentation": "Medidor escalar",
                    "insertText": "<meter value=\"${1:0.6}\" min=\"${2:0}\" max=\"${3:1}\">60%</meter>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "progress",
                    "documentation": "Barra de progreso",
                    "insertText": "<progress value=\"${1:70}\" max=\"${2:100}\">70%</progress>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Contenido interactivo
                {
                    "label": "details",
                    "documentation": "Widget de detalles/desplegable",
                    "insertText": "<details>\n\t<summary>${1:Summary}</summary>\n\t${2:Content}\n</details>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "summary",
                    "documentation": "Resumen para details",
                    "insertText": "<summary>${1:Summary}</summary>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "dialog",
                    "documentation": "Cuadro de diálogo",
                    "insertText": "<dialog open>\n\t${1:Dialog content}\n</dialog>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "menu",
                    "documentation": "Menú de comandos",
                    "insertText": "<menu>\n\t<li><button>${1:Command}</button></li>\n</menu>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "menuitem",
                    "documentation": "Elemento de menú",
                    "insertText": "<menuitem label=\"${1:Command}\" icon=\"${2:icon.png}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Metadatos
                {
                    "label": "head",
                    "documentation": "Contenedor de metadatos",
                    "insertText": "<head>\n\t${1:metadata}\n</head>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "title",
                    "documentation": "Título del documento",
                    "insertText": "<title>${1:Page Title}</title>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "base",
                    "documentation": "URL base",
                    "insertText": "<base href=\"${1:https://example.com/}\" target=\"${2:_blank}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "link",
                    "documentation": "Relación con recurso externo",
                    "insertText": "<link rel=\"${1:stylesheet}\" href=\"${2:style.css}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "meta",
                    "documentation": "Metadatos",
                    "insertText": "<meta name=\"${1:description}\" content=\"${2:content}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "style",
                    "documentation": "Estilos CSS",
                    "insertText": "<style>\n\t${1:css rules}\n</style>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "script",
                    "documentation": "Script JavaScript",
                    "insertText": "<script>\n\t${1:code}\n<\/script>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "noscript",
                    "documentation": "Contenido alternativo sin scripts",
                    "insertText": "<noscript>\n\t${1:Your browser does not support JavaScript!}\n</noscript>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "template",
                    "documentation": "Plantilla HTML",
                    "insertText": "<template>\n\t${1:content}\n</template>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Secciones
                {
                    "label": "div",
                    "documentation": "División/Contenedor",
                    "insertText": "<div>\n\t${1:content}\n</div>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "span",
                    "documentation": "Contenedor en línea",
                    "insertText": "<span>${1:content}</span>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "header",
                    "documentation": "Encabezado de sección",
                    "insertText": "<header>\n\t${1:content}\n</header>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "footer",
                    "documentation": "Pie de sección",
                    "insertText": "<footer>\n\t${1:content}\n</footer>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "main",
                    "documentation": "Contenido principal",
                    "insertText": "<main>\n\t${1:content}\n</main>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "section",
                    "documentation": "Sección genérica",
                    "insertText": "<section>\n\t${1:content}\n</section>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "article",
                    "documentation": "Contenido independiente",
                    "insertText": "<article>\n\t${1:content}\n</article>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "aside",
                    "documentation": "Contenido relacionado",
                    "insertText": "<aside>\n\t${1:content}\n</aside>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "nav",
                    "documentation": "Navegación",
                    "insertText": "<nav>\n\t${1:links}\n</nav>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Elementos incrustados
                {
                    "label": "iframe",
                    "documentation": "Marco incrustado",
                    "insertText": "<iframe src=\"${1:url}\" width=\"${2:300}\" height=\"${3:200}\" title=\"${4:description}\" allow=\"${5:permissions}\"></iframe>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "embed",
                    "documentation": "Contenido externo incrustado",
                    "insertText": "<embed src=\"${1:file}\" type=\"${2:mime/type}\" width=\"${3:300}\" height=\"${4:200}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "object",
                    "documentation": "Objeto incrustado",
                    "insertText": "<object data=\"${1:file}\" type=\"${2:mime/type}\" width=\"${3:300}\" height=\"${4:200}\"></object>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "param",
                    "documentation": "Parámetro para object",
                    "insertText": "<param name=\"${1:name}\" value=\"${2:value}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // SVG y MathML
                {
                    "label": "svg",
                    "documentation": "Gráficos vectoriales",
                    "insertText": "<svg width=\"${1:100}\" height=\"${2:100}\">\n\t<circle cx=\"${3:50}\" cy=\"${4:50}\" r=\"${5:40}\" stroke=\"${6:black}\" stroke-width=\"${7:3}\" fill=\"${8:red}\" />\n</svg>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "math",
                    "documentation": "Notación matemática",
                    "insertText": "<math>\n\t${1:math content}\n</math>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Scripting
                {
                    "label": "canvas",
                    "documentation": "Gráficos con JavaScript",
                    "insertText": "<canvas id=\"${1:myCanvas}\" width=\"${2:200}\" height=\"${3:100}\"></canvas>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },

                // Tipos de input específicos
                {
                    "label": "input-text",
                    "documentation": "Campo de texto",
                    "insertText": "<input type=\"text\" name=\"${1:name}\" id=\"${2:id}\" placeholder=\"${3:placeholder}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-password",
                    "documentation": "Campo de contraseña",
                    "insertText": "<input type=\"password\" name=\"${1:name}\" id=\"${2:id}\" placeholder=\"${3:placeholder}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-email",
                    "documentation": "Campo de email",
                    "insertText": "<input type=\"email\" name=\"${1:name}\" id=\"${2:id}\" placeholder=\"${3:email@example.com}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-number",
                    "documentation": "Campo numérico",
                    "insertText": "<input type=\"number\" name=\"${1:name}\" id=\"${2:id}\" min=\"${3:1}\" max=\"${4:10}\" step=\"${5:1}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-date",
                    "documentation": "Selector de fecha",
                    "insertText": "<input type=\"date\" name=\"${1:name}\" id=\"${2:id}\" min=\"${3:2020-01-01}\" max=\"${4:2025-12-31}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-checkbox",
                    "documentation": "Casilla de verificación",
                    "insertText": "<input type=\"checkbox\" name=\"${1:name}\" id=\"${2:id}\" value=\"${3:value}\" checked>",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-radio",
                    "documentation": "Botón de opción",
                    "insertText": "<input type=\"radio\" name=\"${1:group}\" id=\"${2:id}\" value=\"${3:value}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-file",
                    "documentation": "Selector de archivos",
                    "insertText": "<input type=\"file\" name=\"${1:name}\" id=\"${2:id}\" accept=\"${3:.jpg,.png}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-submit",
                    "documentation": "Botón de envío",
                    "insertText": "<input type=\"submit\" value=\"${1:Submit}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-reset",
                    "documentation": "Botón de reinicio",
                    "insertText": "<input type=\"reset\" value=\"${1:Reset}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-button",
                    "documentation": "Botón genérico",
                    "insertText": "<input type=\"button\" value=\"${1:Click Me}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-color",
                    "documentation": "Selector de color",
                    "insertText": "<input type=\"color\" name=\"${1:name}\" id=\"${2:id}\" value=\"${3:#ff0000}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-range",
                    "documentation": "Control deslizante",
                    "insertText": "<input type=\"range\" name=\"${1:name}\" id=\"${2:id}\" min=\"${3:0}\" max=\"${4:100}\" value=\"${5:50}\" step=\"${6:1}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-search",
                    "documentation": "Campo de búsqueda",
                    "insertText": "<input type=\"search\" name=\"${1:name}\" id=\"${2:id}\" placeholder=\"${3:Search...}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-tel",
                    "documentation": "Campo de teléfono",
                    "insertText": "<input type=\"tel\" name=\"${1:name}\" id=\"${2:id}\" pattern=\"${3:[0-9]{3}-[0-9]{3}-[0-9]{4}}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-url",
                    "documentation": "Campo de URL",
                    "insertText": "<input type=\"url\" name=\"${1:name}\" id=\"${2:id}\" placeholder=\"${3:https://example.com}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-time",
                    "documentation": "Selector de hora",
                    "insertText": "<input type=\"time\" name=\"${1:name}\" id=\"${2:id}\" min=\"${3:09:00}\" max=\"${4:18:00}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-datetime-local",
                    "documentation": "Selector de fecha y hora local",
                    "insertText": "<input type=\"datetime-local\" name=\"${1:name}\" id=\"${2:id}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-month",
                    "documentation": "Selector de mes",
                    "insertText": "<input type=\"month\" name=\"${1:name}\" id=\"${2:id}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                },
                {
                    "label": "input-week",
                    "documentation": "Selector de semana",
                    "insertText": "<input type=\"week\" name=\"${1:name}\" id=\"${2:id}\">",
                    "insertTextRules": monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                }
                ];

        return {
            suggestions: keywords.map(keyword => ({
                label: keyword.label,
                kind: monaco.languages.CompletionItemKind.Snippet,
                documentation: keyword.documentation,
                insertText: keyword.insertText,
                insertTextRules: keyword.insertTextRules,
                range: range
            }))
        };
    }
});



        applyVSCODETheme();
        // Define a new theme
        monaco.editor.defineTheme('bustoscode-dark', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '#6272a4', fontStyle: 'italic' },
                { token: 'keyword', foreground: '#ff79c6' },
                { token: 'number', foreground: '#bd93f9' },
                { token: 'string', foreground: '#f1fa8c' },
                { token: 'type', foreground: '#8be9fd' },
                { token: 'delimiter.html', foreground: '#ffb86c' }
            ],
            colors: {
                'editor.background': '#1e1e28',
                'editor.foreground': '#f8f8f2',
                'editor.lineHighlightBackground': '#282a36',
                'editor.lineHighlightBorder': '#44475a',
                'editor.selectionBackground': '#44475a80',
                'editorCursor.foreground': '#f8f8f2',
                'editorGutter.background': '#1e1e28',
                'editorIndentGuide.background': '#44475a',
                'editorWhitespace.foreground': '#44475a',
                'editor.selectionHighlightBorder': '#44475a'
            }
        });
        // Tema Femenino Actualizado
        monaco.editor.defineTheme('bustoscode-feminine', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '#a78faa', fontStyle: 'italic' },
                { token: 'keyword', foreground: '#ff99cc' },
                { token: 'number', foreground: '#f4b3c2' },
                { token: 'string', foreground: '#d4a5d4' },
                { token: 'type', foreground: '#d67ad1' },
                { token: 'delimiter.html', foreground: '#d4a15f' },
                { token: 'tag.html', foreground: '#d67ad1' },
                { token: 'attribute.name.html', foreground: '#ff99cc' }
            ],
            colors: {
                'editor.foreground': '#ecc5d2',
                'editor.background': '#2a1e28',
                'editor.lineHighlightBackground': '#3a2e38',
                'editor.selectionBackground': '#44475a80'
            }
        });

        // Tema Vibrante
        monaco.editor.defineTheme('bustoscode-vibrant', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '#50fa7b', fontStyle: 'italic' },
                { token: 'keyword', foreground: '#ffdd40' },
                { token: 'number', foreground: '#7fdbca' },
                { token: 'string', foreground: '#ff7f7f' },
                { token: 'type', foreground: '#8be9fd' },
                { token: 'delimiter.html', foreground: '#ff79c6' },
                { token: 'tag.html', foreground: '#8be9fd' },
                { token: 'attribute.name.html', foreground: '#50fa7b' }
            ],
            colors: {
                'editor.foreground': '#e5e5e5',
                'editor.background': '#1a1a1a',
                'editor.lineHighlightBackground': '#2d2d2d',
                'editor.selectionBackground': '#44475a80'
            }
        });

        // Tema Oscuro/Profesional (VSCode-like)
        monaco.editor.defineTheme('bustoscode-dark', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '#6a9955', fontStyle: 'italic' },
                { token: 'keyword', foreground: '#569cd6' },
                { token: 'number', foreground: '#b5cea8' },
                { token: 'string', foreground: '#ce9178' },
                { token: 'type', foreground: '#4ec9b0' },
                { token: 'delimiter.html', foreground: '#d4d4d4' },
                { token: 'tag.html', foreground: '#4ec9b0' },
                { token: 'attribute.name.html', foreground: '#9cdcfe' }
            ],
            colors: {
                'editor.foreground': '#d4d4d4',
                'editor.background': '#1e1e1e',
                'editor.lineHighlightBackground': '#252526',
                'editor.selectionBackground': '#264f78'
            }
        });

        // Tema Profesional
        monaco.editor.defineTheme('bustoscode-professional', {
            base: 'vs',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '#608b4e', fontStyle: 'italic' },
                { token: 'keyword', foreground: '#0000ff' },
                { token: 'number', foreground: '#098658' },
                { token: 'string', foreground: '#a31515' },
                { token: 'type', foreground: '#267f99' },
                { token: 'delimiter.html', foreground: '#800080' },
                { token: 'tag.html', foreground: '#800080' },
                { token: 'attribute.name.html', foreground: '#ff0000' }
            ],
            colors: {
                'editor.foreground': '#333333',
                'editor.background': '#ffffff',
                'editor.lineHighlightBackground': '#f3f3f3',
                'editor.selectionBackground': '#add6ff'
            }
        });

        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: "// Bienvenido a BCode\n// Crea una carpeta o abre tu carpeta para comenzar",
            language: 'javascript',
            theme: 'bustoscode-dark',
            automaticLayout: true,
            rulers: [],
            minimap: {
                enabled: true,
                renderCharacters: false,
                maxColumn: 80
            },
            scrollBeyondLastLine: false,
            roundedSelection: true,
            renderLineHighlight: 'none',
            glyphMargin: false,

            scrollbar: {
                vertical: 'auto',
                horizontal: 'auto',
                useShadows: true
            },
            suggestOnTriggerCharacters: true,
            wordBasedSuggestions: true,
            cursorStyle: 'line-thin',
            cursorBlinking: 'smooth'
        });

        // Aplicar configuración guardada
        applyConfig(loadConfig());

        function applyTheme(themeName) {
            document.body.className = '';
            document.body.classList.add(`theme-${themeName}`);

            // 2. Configurar colores para Monaco
            const styles = getComputedStyle(document.body);

            monaco.editor.defineTheme('custom-theme', {
                base: themeName === 'professional' ? 'vs' : 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: styles.getPropertyValue('--comment-color'), fontStyle: 'italic' },
                    { token: 'keyword', foreground: styles.getPropertyValue('--keyword-color') },
                    { token: 'string', foreground: styles.getPropertyValue('--string-color') },
                    { token: 'number', foreground: styles.getPropertyValue('--number-color') },
                    { token: 'type', foreground: styles.getPropertyValue('--tag-color') },
                    { token: 'delimiter.html', foreground: styles.getPropertyValue('--delimiter-color') },
                    { token: 'tag.html', foreground: styles.getPropertyValue('--tag-color') }
                ],
                colors: {
                    'editor.foreground': styles.getPropertyValue('--text-color'),
                    'editor.background': styles.getPropertyValue('--background-color'),
                    'editorLineNumber.foreground': styles.getPropertyValue('--comment-color')
                }
            });

            // 3. Aplicar tema al editor
            monaco.editor.setTheme('custom-theme');

            // 4. Forzar actualización del editor
            if (editor) {
                editor.updateOptions({ theme: 'custom-theme' });
            }
        }

        function findAndShowHtmlFile() {
            if (!activeFolderPath) {
                showStatusMessage('No hay carpeta activa', 'error');
                return;
            }

            // Limpiar la consola completamente
            const consoleContent = document.getElementById('console-content');
            consoleContent.innerHTML = '<div class="text-gray-400">Los errores y logs de tu código aparecerán aquí</div>';


            // Restablecer la redirección de la consola
            window.consoleRedirected = false;
            initConsoleRedirection();

            // Mostrar la pestaña de consola
            switchTerminalTab('console');

            const previewContainer = document.getElementById('preview-container');
            const terminalPanel = document.getElementById('terminal-panel');

            previewContainer.classList.remove('h-0');
            previewContainer.classList.add('h-full');
            terminalPanel.classList.add('h-0');
            terminalPanel.classList.remove('h-64');

            const htmlFiles = [];

            // Función para buscar archivos HTML recursivamente
            const findHtmlFiles = (folder, currentPath = '') => {
                if (!folder || !folder.children) return;

                folder.children.forEach(child => {
                    const childPath = currentPath ? `${currentPath}/${child.name}` : child.name;
                    if (child.type === 'file' && child.name.endsWith('.html')) {
                        htmlFiles.push({
                            name: child.name,
                            path: childPath,
                            folderPath: childPath.includes('/') ?
                                childPath.substring(0, childPath.lastIndexOf('/')) :
                                '',
                            content: folderCode[childPath.includes('/') ?
                                childPath.substring(0, childPath.lastIndexOf('/')) :
                                ''][child.name] || ''
                        });
                    } else if (child.type === 'folder') {
                        findHtmlFiles(child, childPath);
                    }
                });
            };

            // 1. Primero buscar en la carpeta activa y sus subcarpetas
            const activeFolder = findFolder(activeFolderPath);
            if (activeFolder) {
                findHtmlFiles(activeFolder, activeFolderPath);
            }

            // 2. Si no se encontraron archivos HTML, buscar en todo el proyecto
            if (htmlFiles.length === 0) {
                findHtmlFiles(projectStructure);
            }

            if (htmlFiles.length === 0) {
                showStatusMessage('No se encontraron archivos HTML en el proyecto', 'error');
                return;
            }

            // Ordenar para priorizar index.html si existe
            htmlFiles.sort((a, b) => {
                if (a.name === '.html') return -1;
                if (b.name === '.html') return 1;
                return 0;
            });

            const mainHtmlFile = htmlFiles[0];

            // Guardar el estado actual del editor
            const currentActiveFile = activeFile;
            const currentActiveFolder = activeFolderPath;
            const currentEditorContent = editor ? editor.getValue() : '';

            // Mostrar el iframe con el HTML encont encontrado
            showHtmlInIframe(mainHtmlFile);

            // Restaurar el estado del editor sin cambiar visualmente la pestaña
            activeFile = currentActiveFile;
            activeFolderPath = currentActiveFolder;
            if (editor) {
                editor.setValue(currentEditorContent);
            }

            showStatusMessage(`Mostrando ${mainHtmlFile.name} en vista previa`, 'success');
        }


        function showHtmlInIframe(htmlFile) {
            // Configurar paneles de vista previa
            const previewContainer = document.getElementById('preview-container');
            const terminalPanel = document.getElementById('terminal-panel');

            previewContainer.classList.remove('h-0');
            previewContainer.classList.add('h-64');
            terminalPanel.classList.add('h-0');
            terminalPanel.classList.remove('h-64');

            // Procesar el HTML para incluir recursos
            let htmlContent = htmlFile.content;


            // Obtener el directorio base del archivo HTML
            const baseDir = htmlFile.path.includes('/') ?
                htmlFile.path.substring(0, htmlFile.path.lastIndexOf('/')) :
                '';

            // Función mejorada para resolver rutas relativas
            function resolvePath(relativePath, requestingFilePath = '') {
                // Limpiar la ruta (eliminar comillas y espacios si existen)
                relativePath = relativePath.replace(/^['"\s]|['"\s]$/g, '').trim();

                // Ignorar URLs externas o data URLs
                if (relativePath.startsWith('http://') || relativePath.startsWith('https://') ||
                    relativePath.startsWith('data:')) {
                    return relativePath;
                }

                // Determinar el directorio base para la resolución
                let basePath = baseDir;

                // Si estamos resolviendo desde un archivo específico (como un CSS que referencia una imagen)
                if (requestingFilePath && requestingFilePath.includes('/')) {
                    basePath = requestingFilePath.substring(0, requestingFilePath.lastIndexOf('/'));
                }

                // Construir la ruta completa
                const pathParts = [...basePath.split('/'), ...relativePath.split('/')].filter(p => p && p !== '.');
                const resolvedParts = [];

                for (const part of pathParts) {
                    if (part === '..') {
                        if (resolvedParts.length > 0) resolvedParts.pop();
                    } else {
                        resolvedParts.push(part);
                    }
                }

                const resolvedPath = resolvedParts.join('/');
                const file = findFileByPath(resolvedPath);

                if (file) {
                    // Para imágenes, devolver como data URL
                    const extension = resolvedPath.split('.').pop().toLowerCase();
                    if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(extension)) {
                        if (file.content.startsWith('data:')) {
                            return file.content;
                        } else {
                            // Convertir a data URL si no lo es ya
                            return `data:image/${extension};base64,${btoa(file.content)}`;
                        }
                    }
                    return file.content;
                } else {
                    console.warn(`No se pudo resolver la imagen: ${relativePath} desde ${basePath}`);
                    return `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=`;
                }
            }



            // Procesar imágenes en el HTML
            const imgTags = htmlContent.match(/<img[^>]+src=['"]([^'"]+)['"][^>]*>/g) || [];
            for (const imgTag of imgTags) {
                const imgPath = imgTag.match(/src=['"]([^'"]+)['"]/)?.[1];
                if (!imgPath) continue;

                const imgContent = resolvePath(imgPath);

                if (imgContent) {
                    // Reemplazar la etiqueta img con la data URL
                    htmlContent = htmlContent.replace(
                        imgTag,
                        imgTag.replace(/src=['"][^'"]+['"]/, `src="${imgContent}"`)
                    );
                } else {
                    htmlContent = htmlContent.replace(
                        imgTag,
                        `<!-- Imagen no encontrada: ${imgPath} -->`
                    );
                }
            }

            // Procesar CSS (reemplazar links por estilos embebidos)
            const cssLinks = htmlContent.match(/<link[^>]+href=['"]([^'"]+\.css)['"][^>]*>/g) || [];
            for (const link of cssLinks) {
                const cssPath = link.match(/href=['"]([^'"]+\.css)['"]/)?.[1];
                if (!cssPath) continue;

                const cssContent = resolvePath(cssPath);

                if (cssContent) {
                    // Procesar también las referencias dentro del CSS (como imágenes o fuentes)
                    let processedCss = cssContent;

                    // Mejorar el procesamiento de background-image
                    processedCss = processedCss.replace(/background-image\s*:\s*url$$\s*['"]?([^'")]*)['"]?\s*$$/gi, (match, urlPath) => {
                        // Resolver la ruta relativa desde la ubicación del archivo CSS
                        const resolved = resolvePath(urlPath, cssPath);
                        if (resolved) {
                            return `background-image: url('${resolved}')`;
                        }
                        return match; // Si no se puede resolver, mantener la original
                    });
                    htmlContent = htmlContent.replace(link, `<style>${processedCss}</style>`);
                } else {
                    htmlContent = htmlContent.replace(link, `<!-- Archivo CSS no encontrado: ${cssPath} -->`);
                }
            }

            htmlContent = htmlContent.replace(/<style>([\s\S]*?)<\/style>/gi, (match, cssContent) => {
                // Procesar las URLs en el CSS inline
                const processedCss = cssContent.replace(/background-image\s*:\s*url\(\s*['"]?([^'")]*)['"]?\s*\)/gi, (match, urlPath) => {
                    // Resolver la ruta relativa desde la ubicación del HTML
                    const resolved = resolvePath(urlPath, htmlFile.path);
                    if (resolved) {
                        return `background-image: url('${resolved}')`;
                    }
                    return match;
                });
                return `<style>${processedCss}</style>`;
            });






            // Procesar JavaScript (reemplazar scripts por código embebido)
            const jsScripts = htmlContent.match(/<script[^>]+src=['"]([^'"]+\.js)['"][^>]*><\/script>/g) || [];
            for (const script of jsScripts) {
                const jsPath = script.match(/src=['"]([^'"]+\.js)['"]/)?.[1];
                if (!jsPath) continue;

                const jsContent = resolvePath(jsPath);

                if (jsContent) {
                    htmlContent = htmlContent.replace(script, `<script>${jsContent}<\/script>`);
                } else {
                    htmlContent = htmlContent.replace(script, `<!-- Archivo JS no encontrado: ${jsPath} -->`);
                }
            }

            // Insertar el script de manejo de errores al final del body
            const errorHandlerScript = `
            <script>
                // Solo capturar errores y logs del código del usuario
                (function() {
                    const originalError = window.onerror;
                    const originalConsole = {
                        log: console.log,
                        error: console.error,
                        warn: console.warn,
                        info: console.info
                    };
                    
                    window.onerror = function(message, source, lineno, colno, error) {
                        if (originalError) {
                            originalError.apply(this, arguments);
                        }
                        
                        window.parent.postMessage({
                            type: 'iframe-error',
                            message: message,
                            filename: source,
                            lineno: lineno,
                            colno: colno,
                            error: error ? error.stack : null
                        }, '*');
                        
                        return true;
                    };
                    
                    window.addEventListener('unhandledrejection', function(e) {
                        window.parent.postMessage({
                            type: 'iframe-promise-error',
                            message: e.reason.message || String(e.reason),
                            stack: e.reason.stack
                        }, '*');
                    });
                    
                    ['log', 'error', 'warn', 'info'].forEach(method => {
                        console[method] = function() {
                            originalConsole[method].apply(console, arguments);
                            
                            // Solo enviar mensajes que no sean del sistema
                            if (!arguments[0]?.includes?.('Redirección de consola activada')) {
                                window.parent.postMessage({
                                    type: 'iframe-console',
                                    method: method,
                                    args: Array.from(arguments).map(arg => 
                                        typeof arg === 'object' ? JSON.stringify(arg) : String(arg))
                                }, '*');
                            }
                        };
                    });
                })();
            <\/script>
        `;

            if (!htmlContent.includes('<\/body>')) {
                htmlContent += '<\/body>';
            }
            htmlContent = htmlContent.replace('<\/body>', errorHandlerScript + '<\/body>');

            // Update iframe - FORZAR ACTUALIZACIÓN
            const iframe = document.getElementById('preview-frame');
            iframe.srcdoc = ''; // Limpiar primero
            setTimeout(() => {
                iframe.srcdoc = htmlContent;
            }, 50);

        }

        // En la función findFileByPath(), añade más validaciones:
        function findFileByPath(path) {
            if (!path) {
                console.warn('Ruta de archivo no proporcionada');
                return null;
            }

            try {
                const parts = path.split('/').filter(part => part !== '');
                let current = projectStructure;

                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    const isLast = i === parts.length - 1;

                    const found = current.children.find(child =>
                        child.name === part &&
                        (isLast ? child.type === 'file' : child.type === 'folder'));

                    if (!found) {
                        console.warn(`No se encontró: ${part} en ${current.name}`);
                        return null;
                    }

                    if (isLast) {
                        const folderPath = found.path.includes('/') ?
                            found.path.substring(0, found.path.lastIndexOf('/')) :
                            '';

                        const fileName = found.name;

                        if (folderCode[folderPath] && folderCode[folderPath][fileName] !== undefined) {
                            return {
                                name: fileName,
                                path: found.path,
                                content: folderCode[folderPath][fileName]
                            };
                        }
                        console.warn(`Contenido no encontrado para: ${found.path}`);
                        return null;
                    }

                    current = found;
                }

                return null;
            } catch (error) {
                console.error('Error al buscar archivo:', error);
                return null;
            }
        }

        document.addEventListener('keydown', function (e) {
            if (e.shiftKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                togglePreview();
            }
        });
        document.getElementById('run-btn').addEventListener('click', function () {
            togglePreview();
        });
        function togglePreview() {
            const editorContainer = document.getElementById('editor-container');
            const previewContainer = document.getElementById('preview-container');
            const terminalPanel = document.getElementById('terminal-panel');

            if (!isPreviewVisible) {
                editorContainer.style.display = 'none';
                previewContainer.classList.add('full-height');
                if (terminalPanel.classList.contains('half-screen')) {
                    previewContainer.classList.add('half-screen');
                    terminalPanel.classList.add('half-screen');
                }
                findAndShowHtmlFile();
                isPreviewVisible = true;
            } else {
                editorContainer.style.display = 'block';
                previewContainer.classList.remove('full-height', 'half-screen');
                isPreviewVisible = false;
            }

            setTimeout(() => {
                if (editor) editor.layout();
                document.getElementById('preview-frame').style.height = '100%';
            }, 100);
        }

        // Set up editor events
        editor.onDidChangeModelContent(function () {
            if (activeFolderPath && activeFile) {
                if (!folderCode[activeFolderPath]) {
                    folderCode[activeFolderPath] = {};
                }
                folderCode[activeFolderPath][activeFile] = editor.getValue();
                saveState();
                updateTabStatus(activeFile, false);
            }
        });

        // Set up keybindings
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function () {
            showStatusMessage('Archivo guardado automáticamente', 'success');
        });


        // If we have an active file, load it
        if (activeFolderPath && activeFile) {
            loadFile(activeFolderPath, activeFile);
        }
        editor.onDidChangeModelContent(() => {
            const errors = detectErrors(editor.getValue());
            monaco.editor.setModelMarkers(editor.getModel(), "owner", errors);
            updateErrorDecorations();
        });
        // Cargar estado del sidebar al iniciar
        const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
        const sidebar = document.getElementById('sidebar');
        if (sidebarHidden) {
            sidebar.classList.add('-translate-x-full');
        } else {
            sidebar.classList.remove('-translate-x-full');
        }


    });
}
function findFolder(path) {
    if (!path) return null;

    try {
        const parts = path.split('/').filter(part => part !== '');
        let current = projectStructure;

        for (const part of parts) {
            const found = current.children.find(child =>
                child.name === part && child.type === 'folder');

            if (!found) return null;
            current = found;
        }

        return current;
    } catch (error) {
        console.error('Error al buscar carpeta:', error);
        return null;
    }
}


// Función para crear una ruta de carpetas
function createFolderPath(path) {
    const parts = path.split('/');
    let current = projectStructure;

    for (const part of parts) {
        if (part === '') continue;
        let folder = current.children.find(child => child.name === part && child.type === 'folder');

        if (!folder) {
            folder = {
                name: part,
                type: 'folder',
                children: []
            };
            current.children.push(folder);
        }

        current = folder;
    }

    return current;
}
function updateErrorDecorations() {
    const model = editor.getModel();
    if (!model) return;

    const markers = monaco.editor.getModelMarkers({ resource: model.uri });
    const decorations = [];

    markers.forEach(marker => {
        // Decoración principal (subrayado)
        decorations.push({
            range: new monaco.Range(
                marker.startLineNumber,
                marker.startColumn,
                marker.endLineNumber,
                marker.endColumn
            ),
            options: {
                className: marker.severity === monaco.MarkerSeverity.Error ?
                    'error-lens-decoration-error' :
                    marker.severity === monaco.MarkerSeverity.Warning ?
                        'error-lens-decoration-warning' :
                        'error-lens-decoration-info',
                glyphMarginClassName: marker.severity === monaco.MarkerSeverity.Error ?
                    'error-lens-glyph-margin-error' :
                    'error-lens-glyph-margin-warning',
                hoverMessage: {
                    value: `**${monaco.MarkerSeverity[marker.severity]}**: ${marker.message}`,
                    isTrusted: true
                },
                stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,
                zIndex: 10
            }
        });

        // Decoración adicional para el texto en línea
        decorations.push({
            range: new monaco.Range(
                marker.startLineNumber,
                marker.startColumn,
                marker.endLineNumber,
                marker.endColumn
            ),
            options: {
                afterContentClassName: marker.severity === monaco.MarkerSeverity.Error ?
                    'error-lens-inline-error' :
                    marker.severity === monaco.MarkerSeverity.Warning ?
                        'error-lens-inline-warning' :
                        'error-lens-inline-info',
                stickiness: monaco.editor.TrackedRangeStickinessiness.NeverGrowsWhenTypingAtEdges
            }
        });
    });

    // Aplicar todas las decoraciones
    editor.deltaDecorations([], decorations);
}
function detectErrors(code) {
    const errors = [];
    const lines = code.split('\n');

    // 1. Detección de variables duplicadas
    const variableDeclarations = {};
    const variableRegex = /(?:let|const|var)\s+([a-zA-Z_$][\w$]*)/g;

    let match;
    while ((match = variableRegex.exec(code)) !== null) {
        const varName = match[1];
        const lineNumber = code.substring(0, match.index).split('\n').length;

        if (variableDeclarations[varName]) {
            errors.push({
                startLineNumber: lineNumber,
                startColumn: match.index - code.lastIndexOf('\n', match.index) - 1,
                endLineNumber: lineNumber,
                endColumn: match.index - code.lastIndexOf('\n', match.index) - 1 + match[0].length,
                message: `Variable '${varName}' ya ha sido declarada anteriormente`,
                severity: monaco.MarkerSeverity.Error
            });

            // También marcar la declaración anterior
            errors.push({
                startLineNumber: variableDeclarations[varName].line,
                startColumn: variableDeclarations[varName].column,
                endLineNumber: variableDeclarations[varName].line,
                endColumn: variableDeclarations[varName].column + match[0].length,
                message: `Primera declaración de '${varName}' aquí`,
                severity: monaco.MarkerSeverity.Info
            });
        } else {
            variableDeclarations[varName] = {
                line: lineNumber,
                column: match.index - code.lastIndexOf('\n', match.index) - 1
            };
        }
    }

    // 2. Detección de errores de sintaxis básica
    try {
        new Function(code);
    } catch (e) {
        const lineMatch = e.message.match(/:(\d+):(\d+)/);
        if (lineMatch) {
            errors.push({
                startLineNumber: parseInt(lineMatch[1]),
                startColumn: parseInt(lineMatch[2]),
                endLineNumber: parseInt(lineMatch[1]),
                endColumn: parseInt(lineMatch[2]) + 5,
                message: e.message.split('\n')[0],
                severity: monaco.MarkerSeverity.Error
            });
        }
    }

    // 3. Detección de funciones no utilizadas
    const functionRegex = /function\s+([a-zA-Z_$][\w$]*)\s*$$/g;
    const functionCalls = {};
    const functionDeclarations = {};

    // Primero recopilamos todas las declaraciones
    while ((match = functionRegex.exec(code)) !== null) {
        const funcName = match[1];
        const lineNumber = code.substring(0, match.index).split('\n').length;
        functionDeclarations[funcName] = {
            line: lineNumber,
            column: match.index - code.lastIndexOf('\n', match.index) - 1
        };
    }

    // Luego buscamos llamadas a funciones
    const callRegex = /([a-zA-Z_$][\w$]*)\s*$$/g;
    while ((match = callRegex.exec(code)) !== null) {
        const funcName = match[1];
        if (functionDeclarations[funcName]) {
            functionCalls[funcName] = true;
        }
    }

    // Marcamos funciones no utilizadas
    Object.keys(functionDeclarations).forEach(funcName => {
        if (!functionCalls[funcName] && funcName !== 'main') {
            const decl = functionDeclarations[funcName];
            errors.push({
                startLineNumber: decl.line,
                startColumn: decl.column,
                endLineNumber: decl.line,
                endColumn: decl.column + funcName.length + 9, // "function ".length + nombre
                message: `Función '${funcName}' declarada pero nunca utilizada`,
                severity: monaco.MarkerSeverity.Warning
            });
        }
    });

    // 4. Detección de posibles errores comunes
    lines.forEach((line, index) => {
        const lineNumber = index + 1;

        // Comparaciones con === vs ==
        if (line.includes(' == ') || line.includes(' != ')) {
            errors.push({
                startLineNumber: lineNumber,
                startColumn: line.indexOf(' == ') > -1 ? line.indexOf(' == ') : line.indexOf(' != '),
                endLineNumber: lineNumber,
                endColumn: (line.indexOf(' == ') > -1 ? line.indexOf(' == ') : line.indexOf(' != ')) + 4,
                message: 'Considera usar === en lugar de == para comparaciones estrictas',
                severity: monaco.MarkerSeverity.Warning
            });
        }

        // Comprobación de asignación en condicional
        if (line.match(/if\s*$$[^=]*=[^=].*$$/)) {
            errors.push({
                startLineNumber: lineNumber,
                startColumn: line.indexOf('='),
                endLineNumber: lineNumber,
                endColumn: line.indexOf('=') + 1,
                message: 'Posible asignación (=) en lugar de comparación (== o ===)',
                severity: monaco.MarkerSeverity.Error
            });
        }
    });

    return errors;
}



// Cerrar modal de importación
document.getElementById('close-import-modal').addEventListener('click', function () {
    document.getElementById('import-modal').classList.add('hidden');
});

document.getElementById('cancel-import').addEventListener('click', function () {
    document.getElementById('import-modal').classList.add('hidden');
});

// Cerrar modal de exportación
document.getElementById('close-export-modal').addEventListener('click', function () {
    document.getElementById('export-modal').classList.add('hidden');
});

document.getElementById('cancel-export').addEventListener('click', function () {
    document.getElementById('export-modal').classList.add('hidden');
});


// Setup event listeners
function setupEventListeners() {
    // Menu toggle
    document.getElementById('menu-toggle').addEventListener('click', function () {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');

        // Guardar el estado del sidebar
        const isHidden = sidebar.classList.contains('-translate-x-full');
        localStorage.setItem('sidebarHidden', isHidden);

        // Actualizar el ancho del editor
        updateEditorWidth();

        // Si estamos en escritorio y abrimos el sidebar, aseg asegurarnos que el quick access esté cerrado
        if (!isHidden && window.innerWidth >= 768) {
            document.getElementById('quick-access').classList.add('translate-x-full');
            updateEditorWidth();
        }
    });


    const formatCssBtn = document.getElementById('format-css-btn');
    if (formatCssBtn) {
        formatCssBtn.addEventListener('click', function () {
            if (editor && activeFile && activeFile.endsWith('.css')) {
                editor.getAction('editor.action.formatDocument').run();
                showStatusMessage('CSS formateado', 'success');
            }
        });
    }




    // New folder button
    document.getElementById('new-folder-btn').addEventListener('click', function () {
        document.getElementById('new-folder-modal').classList.remove('hidden');
        document.getElementById('folder-name').focus();
    });

    // New file button
    document.getElementById('new-file-btn').addEventListener('click', function () {
        if (!activeFolder) {
            showStatusMessage('Selecciona una carpeta primero', 'error');
            return;
        }
        document.getElementById('new-file-modal').classList.remove('hidden');
        document.getElementById('file-name').focus();
    });

    // Close modals
    document.getElementById('close-new-folder-modal').addEventListener('click', function () {
        document.getElementById('new-folder-modal').classList.add('hidden');
    });

    document.getElementById('close-new-file-modal').addEventListener('click', function () {
        document.getElementById('new-file-modal').classList.add('hidden');
    });

    // Cancel buttons
    document.getElementById('cancel-new-folder').addEventListener('click', function () {
        document.getElementById('new-folder-modal').classList.add('hidden');
    });

    document.getElementById('cancel-new-file').addEventListener('click', function () {
        document.getElementById('new-file-modal').classList.add('hidden');
    });

    // Create folder
    document.getElementById('create-folder').addEventListener('click', function () {
        const folderName = document.getElementById('folder-name').value.trim();
        if (folderName) {
            createFolder(folderName);
            document.getElementById('new-folder-modal').classList.add('hidden');
            document.getElementById('folder-name').value = '';
        }
    });

    // Create file
    document.getElementById('create-file').addEventListener('click', function () {
        const fileName = document.getElementById('file-name').value.trim();
        if (fileName) {
            createFile(fileName);
            document.getElementById('new-file-modal').classList.add('hidden');
            document.getElementById('file-name').value = '';
        }
    });

    // Run button




    // Terminal toggle
    document.getElementById('terminal-toggle').addEventListener('click', function () {
        const editorContainer = document.getElementById('editor-container');
        const terminalPanel = document.getElementById('terminal-panel');
        const previewContainer = document.getElementById('preview-container');

        if (terminalPanel.classList.contains('half-screen')) {
            // Cerrar terminal
            terminalPanel.classList.remove('half-screen');
            terminalPanel.classList.add('h-0');

            if (previewContainer.classList.contains('half-screen')) {
                // Si el preview está activo en modo medio, expandirlo a pantalla completa
                previewContainer.classList.remove('half-screen');
                previewContainer.classList.add('full-height');
                editorContainer.style.display = 'none';
            } else if (previewContainer.classList.contains('full-height')) {
                // Si el preview ya está en pantalla completa, mantenerlo
                editorContainer.style.display = 'none';
            } else {
                // Si no hay preview, restaurar editor
                editorContainer.classList.remove('half-screen');
                previewContainer.classList.remove('half-screen');
            }
        } else {
            // Abrir terminal
            terminalPanel.classList.remove('h-0');
            terminalPanel.classList.add('half-screen');

            if (previewContainer.classList.contains('full-height')) {
                // Si el preview está activo, ajustar ambos a media altura
                previewContainer.classList.remove('full-height');
                previewContainer.classList.add('half-screen');
                editorContainer.style.display = 'none';
            } else {
                editorContainer.classList.add('half-screen');
            }
        }

        setTimeout(() => {
            if (editor) editor.layout();
            document.getElementById('preview-frame').style.height = '100%';
        }, 300);
    });
    document.getElementById('terminal-content').addEventListener('click', function () {
        const editorContainer = document.getElementById('editor-container');
        const terminalPanel = document.getElementById('terminal-panel');

        if (terminalPanel.classList.contains('half-screen')) {
            terminalPanel.classList.remove('half-screen');
            editorContainer.classList.remove('half-screen');
        } else {
            terminalPanel.classList.add('half-screen');
            editorContainer.classList.add('half-screen');
        }

        setTimeout(() => {
            if (editor) editor.layout();
        }, 300);
    });

    // Quick access toggle - modificado para actualizar el ancho del editor
    document.getElementById('quick-access-toggle').addEventListener('click', function () {
        const quickAccess = document.getElementById('quick-access');
        quickAccess.classList.toggle('translate-x-full');
        updateEditorWidth();
    });

    // Close quick access - modificado para actualizar el ancho del editor
    document.getElementById('close-quick-access').addEventListener('click', function () {
        document.getElementById('quick-access').classList.add('translate-x-full');
        updateEditorWidth();
    });


    // Quick insert buttons
    document.querySelectorAll('.quick-insert-btn').forEach(button => {
        button.addEventListener('click', function () {
            if (editor) {
                const selection = editor.getSelection();
                const range = new monaco.Range(
                    selection.startLineNumber,
                    selection.startColumn,
                    selection.endLineNumber,
                    selection.endColumn
                );
                editor.executeEdits("", [{
                    range: range,
                    text: this.getAttribute('data-insert'),
                    forceMoveMarkers: true
                }]);
            }
        });
    });
    document.getElementById('quick-access-toggle').addEventListener('click', function () {
        document.getElementById('quick-access').classList.toggle('show');
    });

    document.getElementById('close-quick-access').addEventListener('click', function () {
        document.getElementById('quick-access').classList.remove('show');
    });


    // Format button
    document.getElementById('format-btn').addEventListener('click', function () {
        if (editor) {
            editor.getAction('editor.action.formatDocument').run();
            showStatusMessage('Código formateado', 'success');
        }
    });

    // Comment button
    document.getElementById('comment-btn').addEventListener('click', function () {
        if (editor) {
            editor.getAction('editor.action.commentLine').run();
        }
    });

    // Copy all button
    document.getElementById('copy-all-btn').addEventListener('click', function () {
        if (editor) {
            navigator.clipboard.writeText(editor.getValue());
            showStatusMessage('Código copiado al portapapeles', 'success');
        }
    });

    // Close all tabs
    document.getElementById('close-all-tabs').addEventListener('click', function () {
        closeAllTabs();
    });

    // Clear all files button
    document.getElementById('clear-all-btn').addEventListener('click', function () {
        clearAllFiles();
    });

    // Handle tab switching
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('editor-tab')) {

            const fileName = e.target.getAttribute('data-file');
            const folderName = e.target.getAttribute('data-folder');
            switchToTab(folderName, fileName);
        }

        if (e.target.classList.contains('terminal-tab')) {
            const tabName = e.target.getAttribute('data-tab');
            switchTerminalTab(tabName);
        }
    });

    // Handle file clicks in explorer
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('file-item')) {
            const fileName = e.target.getAttribute('data-file');
            const folderName = e.target.getAttribute('data-folder');
            openFile(folderName, fileName);
        }

        if (e.target.classList.contains('folder-item')) {
            const folderName = e.target.getAttribute('data-folder');
            toggleFolder(folderName);
        }

        // Handle click on add file button in folder
        if (e.target.classList.contains('add-file-btn')) {
            e.stopPropagation();
            const folderName = e.target.closest('.folder-item').getAttribute('data-folder');
            activeFolderPath = folderName;
            document.getElementById('new-file-modal').classList.remove('hidden');
            document.getElementById('file-name').focus();
        }

        // Handle click on delete folder button
        if (e.target.classList.contains('delete-folder-btn')) {
            e.stopPropagation();
            const folderName = e.target.closest('.folder-item').getAttribute('data-folder');
            deleteFolder(folderName);
        }
    });

    // Handle drag and drop for files
    const fileExplorer = document.getElementById('file-explorer');
    fileExplorer.addEventListener('dragover', function (e) {
        e.preventDefault();
        this.classList.add('bg-dark-700');
    });

    fileExplorer.addEventListener('dragleave', function () {
        this.classList.remove('bg-dark-700');
    });

    fileExplorer.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('bg-dark-700');

        if (e.dataTransfer.files.length > 0) {
            handleFileDrop(e.dataTransfer.files);
        }

    });
}

// Create a new folder
function createFolder(name) {
    if (!name) {
        showStatusMessage('El nombre de la carpeta no puede estar vacío', 'error');
        return;
    }

    // Validar caracteres no permitidos en nombres de carpeta
    if (/[<>:"/\\|?*]/.test(name)) {
        showStatusMessage('El nombre de la carpeta contiene caracteres no permitidos', 'error');
        return;
    }

    try {
        if (!activeFolderPath) {
            // Crear en la raíz
            const existing = projectStructure.children.find(child =>
                child.name === name && child.type === 'folder');

            if (!existing) {
                const newFolder = {
                    name: name,
                    type: 'folder',
                    children: [],
                    path: name
                };

                projectStructure.children.push(newFolder);
                expandedFolders[name] = true;

                renderFileExplorer();
                saveState();
                showStatusMessage(`Carpeta "${name}" creada`, 'success');
            } else {
                showStatusMessage(`La carpeta "${name}" ya existe`, 'error');
            }
        } else {
            // Crear dentro de la carpeta activa
            const parentFolder = findFolder(activeFolderPath);
            if (parentFolder) {
                const existing = parentFolder.children.find(child =>
                    child.name === name && child.type === 'folder');

                if (!existing) {
                    const newPath = `${activeFolderPath}/${name}`;
                    const newFolder = {
                        name: name,
                        type: 'folder',
                        children: [],
                        path: newPath
                    };

                    parentFolder.children.push(newFolder);
                    expandedFolders[newPath] = true;

                    renderFileExplorer();
                    saveState();
                    showStatusMessage(`Carpeta "${name}" creada en "${activeFolderPath}"`, 'success');
                } else {
                    showStatusMessage(`La carpeta "${name}" ya existe en "${activeFolderPath}"`, 'error');
                }
            }
        }
    } catch (error) {
        console.error('Error al crear carpeta:', error);
        showStatusMessage('Error al crear carpeta', 'error');
    }
}

// Create a new file
function createFile(name) {
    if (!name) {
        showStatusMessage('El nombre del archivo no puede estar vacío', 'error');
        return;
    }

    // Validar caracteres no permitidos en nombres de archivo
    if (/[<>:"/\\|?*]/.test(name)) {
        showStatusMessage('El nombre del archivo contiene caracteres no permitidos', 'error');
        return;
    }

    if (!activeFolderPath) {
        showStatusMessage('Selecciona una carpeta primero', 'error');
        return;
    }

    try {
        const parentFolder = findFolder(activeFolderPath);
        if (parentFolder) {
            const existing = parentFolder.children.find(child =>
                child.name === name && child.type === 'file');

            if (!existing) {
                const filePath = activeFolderPath ? `${activeFolderPath}/${name}` : name;
                const newFile = {
                    name: name,
                    type: 'file',
                    path: filePath
                };

                parentFolder.children.push(newFile);

                // Set default content based on file type
                const extension = name.split('.').pop();
                let content = '';

                switch (extension) {
                    case 'html':
                        content = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Bienvenido a BCode</title>
    <link rel="stylesheet" href="style.css">
<\/head>
<body>
    <h1>Bienvenido a BCode</h1>
    <script src="script.js"><\/script>
<\/body>
<\/html>`;
                        break;
                    case 'css':
                        content = `/* ${name}   */`;
                        break;
                    case 'js':
                        content = `// ${name}`;
                        break;
                    default:
                        content = `// ${name}`;
                }

                // Guardar el contenido del archivo
                if (!folderCode[activeFolderPath]) {
                    folderCode[activeFolderPath] = {};
                }
                folderCode[activeFolderPath][name] = content;

                renderFileExplorer();
                openFile(activeFolderPath, name);
                saveState();
                showStatusMessage(`Archivo "${name}" creado en "${activeFolderPath}"`, 'success');
            } else {
                showStatusMessage(`El archivo "${name}" ya existe en "${activeFolderPath}"`, 'error');
            }
        }
    } catch (error) {
        console.error('Error al crear archivo:', error);
        showStatusMessage('Error al crear archivo', 'error');
    }
    saveState();
}
function normalizePath(path) {
    return path.replace(/\\/g, '/').replace(/\/+/g, '/').replace(/\/$/, '');
}

// Open a file
function openFile(folderPath, fileName) {
    folderPath = normalizePath(folderPath);
    if (!fileName) {
        showStatusMessage('Nombre de archivo no válido', 'error');
        return;
    }

    try {
        if (!monacoInitialized) {
            // Esperar a que Monaco esté listo y volver a intentar
            setTimeout(() => openFile(folderPath, fileName), 100);
            return;
        }

        activeFolderPath = folderPath;
        activeFile = fileName;
        const fullPath = folderPath ? `${folderPath}/${fileName}` : fileName;

        // Add to open tabs if not already there
        if (!openTabs.some(tab => tab.folder === folderPath && tab.file === fileName)) {
            openTabs.push({ folder: folderPath, file: fileName });
            renderTabs();
        }

        loadFile(folderPath, fileName);
        highlightActiveFile();
        updateCurrentLanguage();
        saveState();
    } catch (error) {
        console.error('Error al abrir archivo:', error);
        showStatusMessage('Error al abrir archivo', 'error');
    }
}


function loadFile(folderPath, fileName) {
    try {
        // Verificar si el editor está inicializado
        if (!editor) {
            console.warn('Editor no está inicializado aún');
            setTimeout(() => loadFile(folderPath, fileName), 100);
            return;
        }

        const fullPath = folderPath ? `${folderPath}/${fileName}` : fileName;
        const editorContainer = document.getElementById('editor-container');
        const welcomeMessage = editorContainer.querySelector('h2');
        const monacoEditor = document.getElementById('monaco-editor');

        if (folderPath && fileName && folderCode[folderPath]?.[fileName] !== undefined) {
            welcomeMessage.classList.add('hidden');
            monacoEditor.classList.remove('hidden');

            const extension = fileName.split('.').pop();
            let language = 'plaintext';

            switch (extension) {
                case 'js': language = 'javascript'; break;
                case 'html': language = 'html'; break;
                case 'css': language = 'css'; break;
                case 'json': language = 'json'; break;
            }

            const oldModel = editor.getModel();
            const newModel = monaco.editor.createModel(
                folderCode[folderPath][fileName],
                language
            );

            editor.setModel(newModel);
            if (oldModel) {
                oldModel.dispose();
            }

            document.getElementById('current-file-type').textContent =
                language.charAt(0).toUpperCase() + language.slice(1);

            // Actualizar pestañas activas
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.classList.remove('bg-dark-700', 'text-white');
                tab.classList.add('bg-dark-800', 'text-gray-400');
            });

            const activeTab = document.querySelector(`.editor-tab[data-folder="${folderPath}"][data-file="${fileName}"]`);
            if (activeTab) {
                activeTab.classList.remove('bg-dark-800', 'text-gray-400');
                activeTab.classList.add('bg-dark-700', 'text-white');
            }
        } else {
            welcomeMessage.classList.remove('hidden');
            monacoEditor.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error al cargar archivo:', error);
        showStatusMessage('Error al cargar archivo', 'error');
    }
}
function updateEditorWidth() {
    const sidebar = document.getElementById('sidebar');
    const quickAccess = document.getElementById('quick-access');
    const mainContent = document.getElementById('main-content');

    // Verificar estado de los paneles
    const sidebarHidden = sidebar.classList.contains('-translate-x-full');
    const quickAccessHidden = quickAccess.classList.contains('translate-x-full');

    // Aplicar clases según el estado
    if (sidebarHidden && quickAccessHidden) {
        mainContent.classList.remove('md:ml-64', 'md:mr-48');
        mainContent.classList.add('w-full');
    } else {
        if (sidebarHidden) {
            mainContent.classList.remove('md:ml-64');
        } else {
            mainContent.classList.add('md:ml-64');
        }

        if (quickAccessHidden) {
            mainContent.classList.remove('md:mr-48');
        } else {
            mainContent.classList.add('md:mr-48');
        }
    }

    // Forzar el re-layout del editor
    if (editor) {
        setTimeout(() => {
            editor.layout();
        }, 100);
    }
}


function switchTerminalTab(tabName) {
    document.querySelectorAll('.terminal-tab').forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
            tab.classList.add('border-accent-purple', 'text-white');
            tab.classList.remove('text-gray-400');
        } else {
            tab.classList.remove('border-accent-purple', 'text-white');
            tab.classList.add('text-gray-400');
        }
    });

    document.getElementById('terminal-content').classList.add('hidden');
    document.getElementById('console-content').classList.add('hidden');
    document.getElementById('problems-content').classList.add('hidden');

    document.getElementById(`${tabName}-content`).classList.remove('hidden');
}

// Close all open tabs
function closeAllTabs() {
    openTabs = [];
    renderTabs();

    if (editor) {
        editor.setValue('');
        const model = editor.getModel();
        if (model) {
            monaco.editor.setModelLanguage(model, 'javascript');
        }
    }

    activeFile = null;
    document.getElementById('current-file-type').textContent = 'JavaScript';
    showStatusMessage('Todas las pestañas cerradas', 'success');
}

// Clear all files and folders
function clearAllFiles() {
    if (confirm('¿Estás seguro de que quieres eliminar TODOS los archivos y carpetas? Esta acción no se puede deshacer.')) {
        // Reiniciar estructura completa del proyecto
        projectStructure = {
            name: 'root',
            type: 'folder',
            children: []
        };

        // Limpiar todos los contenidos de archivos
        folderCode = {};

        // Restablecer variables de estado
        activeFolderPath = null;
        activeFile = null;
        openTabs = [];
        expandedFolders = {};

        // Limpiar editor
        if (editor) {
            editor.setValue('// Bienvenido a BCode\n// Crea una carpeta o abre tu carpeta para comenzar');
            const model = editor.getModel();
            if (model) {
                monaco.editor.setModelLanguage(model, 'javascript');
                monaco.editor.setModelMarkers(model, 'owner', []); // Limpiar marcadores de errores
            }
        }

        // Limpiar caché local
        localStorage.removeItem('bustosCodeState');

        // Actualizar interfaz
        renderFileExplorer();
        renderTabs();
        document.getElementById('current-file-type').textContent = 'JavaScript';

        // Limpiar consola y vista previa
        document.getElementById('console-content').innerHTML = '<div class="text-gray-400">Los errores y logs de tu código aparecerán aquí</div>';
        document.getElementById('preview-frame').srcdoc = '';

        // Restablecer estado de la terminal
        document.getElementById('terminal-content').innerHTML = `
            <div class="text-green-400">$ Listo para ejecutar código</div>
            <div class="mt-4 flex items-center">
                <span class="text-green-400">$</span>
                <span id="terminal-cursor" class="terminal-cursor ml-1">_</span>
            </div>
        `;

        showStatusMessage('Todos los archivos y carpetas eliminados', 'success');
    }
}
// Switch to a specific tab
function switchToTab(folderName, fileName) {
    activeFolderPath = folderName;
    activeFile = fileName;
    loadFile(folderName, fileName);
    highlightActiveFile();
    updateCurrentLanguage();
    saveState();
}

// Update the current language in status bar
function updateCurrentLanguage() {
    if (activeFile) {
        const extension = activeFile.split('.').pop();
        let language = '';

        switch (extension) {
            case 'js': language = 'JavaScript'; break;
            case 'html': language = 'HTML'; break;
            case 'css': language = 'CSS'; break;
            case 'json': language = 'JSON'; break;
            default: language = extension.toUpperCase();
        }

        document.getElementById('current-language').textContent = language;
    }
}

// Highlight the active file in explorer
function highlightActiveFile() {
    document.querySelectorAll('.file-item').forEach(file => {
        file.classList.remove('active', 'text-white');
        file.classList.add('text-gray-400');
    });

    if (activeFile) {
        const activeFileElement = document.querySelector(`.file-item[data-folder="${activeFolderPath}"][data-file="${activeFile}"]`);

        if (activeFileElement) {
            activeFileElement.classList.add('active', 'text-white');
            activeFileElement.classList.remove('text-gray-400');
        }
    }
}

function renderFolder(folder, parentPath = '', level = 0) {
    const folderPath = parentPath ? `${parentPath}/${folder.name}` : folder.name;
    const isExpanded = expandedFolders[folderPath] || false;

    // Verificar si esta carpeta tiene una subcarpeta img o images
    const hasImgFolder = folder.children.some(child =>
        child.type === 'folder' && (child.name.toLowerCase() === 'img' || child.name.toLowerCase() === 'images')
    );

    // Crear elemento contenedor de la carpeta
    const folderElement = document.createElement('div');
    folderElement.className = 'mb-2';
    folderElement.style.marginLeft = `${level * 12}px`; // Corregido: se eliminó el apóstrofo al final

    // Crear encabezado de la carpeta
    const folderHeader = document.createElement('div');
    folderHeader.className = 'flex items-center justify-between px-2 py-1 rounded hover:bg-dark-700 cursor-pointer folder-item';
    folderHeader.setAttribute('data-folder', folderPath);

    // Parte izquierda del encabezado (icono y nombre)
    const folderLeft = document.createElement('div');
    folderLeft.className = 'flex items-center';

    const folderIcon = document.createElement('i');
    folderIcon.className = isExpanded ?
        'fas fa-folder-open mr-2 text-accent-amber' :
        'fas fa-folder mr-2 text-accent-amber';

    const folderNameSpan = document.createElement('span');
    folderNameSpan.className = 'text-sm';
    folderNameSpan.textContent = folder.name;

    folderLeft.appendChild(folderIcon);
    folderLeft.appendChild(folderNameSpan);

    // Acciones de la carpeta (botones)
    const folderActions = document.createElement('div');
    folderActions.className = 'flex items-center';

    // Botón para añadir subcarpeta
    const addFolderBtn = document.createElement('button');
    addFolderBtn.className = 'add-subfolder-btn text-gray-400 hover:text-white ml-2 p-1 rounded-full hover:bg-dark-600';
    addFolderBtn.innerHTML = '<i class="fas fa-folder-plus text-xs"></i>';
    addFolderBtn.title = 'Añadir subcarpeta';
    addFolderBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        activeFolderPath = folderPath;
        document.getElementById('new-folder-modal').classList.remove('hidden');
        document.getElementById('folder-name').focus();
    });
    folderActions.appendChild(addFolderBtn);

    // Botón para añadir archivo
    const addFileBtn = document.createElement('button');
    addFileBtn.className = 'add-file-btn text-gray-400 hover:text-white ml-2 p-1 rounded-full hover:bg-dark-600';
    addFileBtn.innerHTML = '<i class="fas fa-plus text-xs"></i>';
    addFileBtn.title = 'Añadir archivo';
    folderActions.appendChild(addFileBtn);

    // Botón para subir imágenes (solo si tiene subcarpeta img/images)
    if (hasImgFolder) {
        const uploadImgBtn = document.createElement('button');
        uploadImgBtn.className = 'upload-img-btn text-blue-400 hover:text-blue-500 ml-2 p-1 rounded-full hover:bg-dark-600';
        uploadImgBtn.innerHTML = '<i class="fas fa-image text-xs"></i>';
        uploadImgBtn.title = 'Subir imágenes';
        uploadImgBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadImagesToFolder(folderPath);
        });
        folderActions.appendChild(uploadImgBtn);
    }

    // Botón para eliminar carpeta
    const deleteFolderBtn = document.createElement('button');
    deleteFolderBtn.className = 'delete-folder-btn text-red-400 hover:text-red-500 ml-2 p-1 rounded-full hover:bg-dark-600';
    deleteFolderBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
    deleteFolderBtn.title = 'Eliminar carpeta';
    folderActions.appendChild(deleteFolderBtn);

    // Ensamblar el encabezado
    folderHeader.appendChild(folderLeft);
    folderHeader.appendChild(folderActions);
    folderElement.appendChild(folderHeader);

    // Renderizar contenido si está expandido
    if (isExpanded && folder.children && folder.children.length > 0) {
        folder.children.forEach(child => {
            if (child.type === 'folder') {
                folderElement.appendChild(renderFolder(child, folderPath, level + 1));
            } else {
                // Crear elemento de archivo
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center px-2 py-1 rounded hover:bg-dark-700 cursor-pointer text-gray-400 file-item file-highlight';
                fileElement.setAttribute('data-folder', folderPath);
                fileElement.setAttribute('data-file', child.name);
                fileElement.style.marginLeft = `${(level + 1) * 12}px`; // Corregido: se eliminó el apóstrofo al final

                // Resaltar archivo activo
                if (activeFolderPath === folderPath && activeFile === child.name) {
                    fileElement.classList.add('active', 'text-white');
                }

                // Icono y nombre del archivo
                const fileIcon = document.createElement('i');
                fileIcon.className = getFileIcon(child.name) + ' mr-2';
                const fileNameSpan = document.createElement('span');
                fileNameSpan.className = 'text-sm';
                fileNameSpan.textContent = child.name; // Corregido: se eliminó la parte incorrecta "fileName"

                fileElement.appendChild(fileIcon);
                fileElement.appendChild(fileNameSpan);
                folderElement.appendChild(fileElement);
            }
        });
    }

    return folderElement;
}
function uploadImagesToFolder(folderPath) {
    // Encontrar la subcarpeta img o images
    const folder = findFolder(folderPath);
    if (!folder) return;

    const imgFolder = folder.children.find(child =>
        child.type === 'folder' && (child.name.toLowerCase() === 'img' || child.name.toLowerCase() === 'images')
    );

    if (!imgFolder) {
        showStatusMessage('No se encontró la carpeta img/images', 'error');
        return;
    }

    // Crear input de archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = 'image/*';

    input.onchange = function (e) {
        const files = e.target.files;
        if (files.length === 0) return;

        let uploadedCount = 0;

        Array.from(files).forEach(file => {
            // Verificar que sea una imagen
            if (!file.type.startsWith('image/')) {
                showStatusMessage(`El archivo ${file.name} no es una imagen`, 'error');
                return;
            }

            const fileName = file.name;
            const imgFolderPath = imgFolder.path;

            // Verificar si el archivo ya existe
            const fileExists = imgFolder.children.some(child =>
                child.type === 'file' && child.name === fileName
            );

            if (fileExists) {
                showStatusMessage(`La imagen ${fileName} ya existe`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                // Crear el archivo en la estructura
                const newFile = {
                    name: fileName,
                    type: 'file',
                    path: `${imgFolderPath}/${fileName}`
                };

                imgFolder.children.push(newFile);

                // Guardar el contenido (como data URL para imágenes)
                if (!folderCode[imgFolderPath]) {
                    folderCode[imgFolderPath] = {};
                }
                folderCode[imgFolderPath][fileName] = e.target.result;

                uploadedCount++;

                if (uploadedCount === files.length) {
                    showStatusMessage(`${uploadedCount} imágenes subidas a ${imgFolder.name}`, 'success');
                    renderFileExplorer();
                    saveState();
                }
            };

            reader.readAsDataURL(file);
        });
    };

    input.click();
}

function renderFileExplorer() {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';

    // Add clear all button
    const clearAllBtn = document.createElement('button');
    clearAllBtn.id = 'clear-all-btn';
    clearAllBtn.className = 'text-red-400 hover:text-red-500 text-sm mb-4 flex items-center';
    clearAllBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Eliminar todo';
    clearAllBtn.addEventListener('click', clearAllFiles);
    fileList.appendChild(clearAllBtn);

    if (projectStructure.children.length === 0) {
        fileList.innerHTML += `
            <div class="text-center py-4 text-gray-500 text-sm">
                <i class="fas fa-folder-open text-2xl mb-2"></i>
                <p>No hay carpetas creadas</p>
                <button id="create-first-folder" class="mt-2 text-accent-purple hover:underline">
                    Crea tu primera carpeta
                </button>
            </div>
        `;

        document.getElementById('create-first-folder').addEventListener('click', function () {
            document.getElementById('new-folder-modal').classList.remove('hidden');
            document.getElementById('folder-name').focus();
        });

        return;
    }

    // Render each folder recursively
    projectStructure.children.forEach(child => {
        if (child.type === 'folder') {
            fileList.appendChild(renderFolder(child));
        } else if (child.type === 'file') {
            // Handle root level files if any
            const fileElement = document.createElement('div');
            fileElement.className = 'flex items-center px-2 py-1 rounded hover:bg-dark-700 cursor-pointer text-gray-400 file-item file-highlight';
            fileElement.setAttribute('data-folder', '');
            fileElement.setAttribute('data-file', child.name);

            if (activeFolderPath && activeFile) {
                fileElement.classList.add('active', 'text-white');
            }

            const fileIcon = document.createElement('i');
            fileIcon.className = getFileIcon(child.name) + ' mr-2';
            const fileNameSpan = document.createElement('span');
            fileNameSpan.className = 'text-sm';
            fileNameSpan.textContent = child.name;

            fileElement.appendChild(fileIcon);
            fileElement.appendChild(fileNameSpan);
            fileList.appendChild(fileElement);
        }
    });
}

// Get appropriate file icon
function getFileIcon(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    let iconClass = 'fas fa-file';

    switch (extension) {
        case 'html': iconClass = 'fab fa-html5 text-red-500'; break;
        case 'css': iconClass = 'fab fa-css3-alt text-blue-500'; break;
        case 'js': iconClass = 'fab fa-js-square text-yellow-500'; break;
        case 'json': iconClass = 'fas fa-code text-green-500'; break;
        case 'png':
        case 'jpg':
        case 'jpeg':
        case 'gif':
        case 'svg':
        case 'webp':
        case 'bmp':
            iconClass = 'fas fa-image text-purple-500'; break;
    }

    return iconClass;
}


// Render open tabs
function renderTabs() {
    const tabsContainer = document.querySelector('#editor-tabs > div');
    tabsContainer.innerHTML = '';

    openTabs.forEach(tab => {
        const tabElement = document.createElement('div');
        tabElement.className = 'flex items-center px-3 py-2 text-sm font-medium bg-dark-800 text-gray-400 editor-tab cursor-pointer';
        tabElement.setAttribute('data-folder', tab.folder);
        tabElement.setAttribute('data-file', tab.file);

        if (activeFolderPath === tab.folder && activeFile === tab.file) {
            tabElement.classList.remove('bg-dark-800', 'text-gray-400');
            tabElement.classList.add('bg-dark-700', 'text-white');
        }

        const fileNameSpan = document.createElement('span');
        fileNameSpan.textContent = tab.file;

        const closeButton = document.createElement('button');
        closeButton.className = 'ml-2 text-gray-400 hover:text-white';
        closeButton.innerHTML = '<i class="fas fa-times text-xs"></i>';
        closeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            closeTab(tab.folder, tab.file);
        });

        tabElement.appendChild(fileNameSpan);
        tabElement.appendChild(closeButton);
        tabsContainer.appendChild(tabElement);
    });
}

// Close a specific tab
function closeTab(folderName, fileName) {
    openTabs = openTabs.filter(tab => !(tab.folder === folderName && tab.file === fileName));
    renderTabs();

    if (activeFolderPath === folderName && activeFile === fileName) {
        if (openTabs.length > 0) {
            const lastTab = openTabs[openTabs.length - 1];
            switchToTab(lastTab.folder, lastTab.file);
        } else {
            activeFile = null;
            if (editor) {
                editor.setValue('// Bienvenido a BCode  Crea una carpeta o abre tu carpeta para comenzar');
            }
            document.getElementById('current-file-type').textContent = 'JavaScript';
            showStatusMessage(`Pestaña "${fileName}" cerrada`, 'success');
        }
    }
}

// Update tab status (modified/clean)
function updateTabStatus(fileName, isModified) {
    const tab = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
    if (tab) {
        if (isModified) {
            tab.classList.add('italic');
        } else {
            tab.classList.remove('italic');
        }
    }
}

// Show status message
function showStatusMessage(message, type = 'info') {
    const statusElement = document.getElementById('status-message');
    statusElement.textContent = message;

    // Reset classes
    statusElement.className = '';

    // Add base and type classes
    statusElement.classList.add('px-2', 'py-1', 'rounded');

    switch (type) {
        case 'success':
            statusElement.classList.add('bg-green-500', 'text-white');
            break;
        case 'error':
            statusElement.classList.add('bg-red-500', 'text-white');
            break;
        case 'warning':
            statusElement.classList.add('bg-yellow-500', 'text-dark-900');
            break;
        default:
            statusElement.classList.add('bg-blue-500', 'text-white');
    }

    // Clear after 5 seconds
    setTimeout(() => {
        if (statusElement.textContent === message) {
            statusElement.textContent = 'Ready';
            statusElement.className = '';
        }
    }, 5000);
}

// Update clock
function updateClock() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('current-time').textContent = `${hours}:${minutes}`;
}



// Handle file drop
function handleFileDrop(files) {
    if (!activeFolderPath) {
        showStatusMessage('Selecciona una carpeta primero', 'error');
        return;
    }

    Array.from(files).forEach(file => {
        const fileName = file.name;

        if (!folderCode[activeFolderPath].includes(fileName)) {
            folderCode[activeFolderPath].push(fileName);

            const reader = new FileReader();
            reader.onload = function (e) {
                if (!folderCode[activeFolder]) {
                    folderCode[activeFolder] = {};
                }

                folderCode[activeFolder][fileName] = e.target.result;
                renderFileExplorer();
                saveState();
                showStatusMessage(`Archivo "${fileName}" importado`, 'success');
            };
            reader.readAsText(file);
        } else {
            showStatusMessage(`El archivo "${fileName}" ya existe`, 'error');
        }
    });
}

// Save app state to localStorage
async function saveState() {
    try {
        if (currentUser) {
            // Usuario autenticado - guardar solo en Firebase
            const state = {
                projectStructure: projectStructure,
                folderCode: folderCode,
                activeFolderPath: activeFolderPath,
                activeFile: activeFile,
                openTabs: openTabs,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('users').doc(currentUser.uid)
                .collection('projects').doc('default')
                .set(state, { merge: true });

            showStatusMessage('Proyecto guardado en la nube', 'success');
        } else {
            // Usuario no autenticado - guardar solo en Local Storage
            const state = {
                projectStructure: projectStructure,
                folderCode: folderCode,
                activeFolderPath: activeFolderPath,
                activeFile: activeFile,
                openTabs: openTabs,
                theme: currentTheme,
                expandedFolders: expandedFolders
            };

            localStorage.setItem('bustosCodeState', JSON.stringify(state));
        }
    } catch (error) {
        console.error('Error al guardar:', error);
        showStatusMessage('Error al guardar', 'error');
    }
}

function validateFileStructure() {
    try {
        // Verificar que todas las rutas en folderCode existan en projectStructure
        for (const folderPath in folderCode) {
            const folder = findFolder(folderPath);
            if (!folder) {
                console.warn(`Carpeta no encontrada en estructura: ${folderPath}`);
                delete folderCode[folderPath];
                continue;
            }

            for (const fileName in folderCode[folderPath]) {
                const fileExists = folder.children.some(
                    child => child.type === 'file' && child.name === fileName
                );

                if (!fileExists) {
                    console.warn(`Archivo no encontrado en estructura: ${fileName}`);
                    delete folderCode[folderPath][fileName];
                }
            }
        }

        return true;
    } catch (error) {
        console.error('Error validando estructura:', error);
        return false;
    }
}

// Load app state from localStorage
async function loadState() {
    try {
        // Si hay usuario autenticado, cargar de Firestore
        if (currentUser) {
            const doc = await db.collection('users').doc(currentUser.uid)
                .collection('projects').doc('default')
                .get();

            if (doc.exists) {
                const cloudState = doc.data();
                applyState(cloudState);
                showStatusMessage('Proyecto cargado desde la nube', 'success');
                return;
            }

            // Si no hay datos en Firestore, usar estado inicial
            resetToInitialState();
        } else {
            // Si no hay usuario, cargar de Local Storage
            const localState = localStorage.getItem('bustosCodeState');
            if (localState) {
                const state = JSON.parse(localState);
                applyState(state);
            } else {
                // Si no hay nada en Local Storage, usar estado inicial
                resetToInitialState();
            }
        }
    } catch (error) {
        console.error('Error al cargar:', error);
        showStatusMessage('Error al cargar el proyecto', 'error');
    }
}
function applyState(state) {
    projectStructure = state.projectStructure || {
        name: 'root',
        type: 'folder',
        children: []
    };

    folderCode = state.folderCode || {};
    activeFolderPath = state.activeFolderPath || null;
    activeFile = state.activeFile || null;
    openTabs = state.openTabs || [];
    currentTheme = state.theme || 'dark';
    expandedFolders = state.expandedFolders || {};

    renderFileExplorer();
    renderTabs();

    if (activeFolderPath && activeFile) {
        loadFile(activeFolderPath, activeFile);
    }
}

function toggleFolder(folderPath) {
    expandedFolders[folderPath] = !expandedFolders[folderPath];
    renderFileExplorer();
    saveState();
}
function checkConnection() {
    // Verificar estado de conexión usando el navegador
    isOnline = navigator.onLine;
    showStatusMessage(isOnline ? 'Conectado' : 'Modo sin conexión',
        isOnline ? 'success' : 'warning');

    // Escuchar cambios en la conexión
    window.addEventListener('online', () => {
        isOnline = true;
        showStatusMessage('Conectado', 'success');
        // Sincronizar datos con el servidor
        db.enableNetwork();
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        showStatusMessage('Modo sin conexión', 'warning');
        // Trabajar en modo offline
        db.disableNetwork();
    });
}
// Llamar al iniciar
checkConnection();

// Guardar después de operaciones importantes
function setupAutoSave() {
    // Guardar después de cambios en el editor
    if (editor) {
        editor.onDidChangeModelContent(() => {
            debouncedSave();
        });
    }

    // Guardar al cambiar de pestaña
    window.addEventListener('focus', debouncedSave);

    // Guardar antes de cerrar la página
    window.addEventListener('beforeunload', (e) => {
        saveState();
    });
}

// Debounce para evitar muchos guardados seguidos
const debouncedSave = debounce(() => {
    saveState();
}, 2000);

function debounce(func, wait) {
    let timeout;
    return function () {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}

// Delete a folder
function deleteFolder(folderPath) {
    if (confirm(`¿Estás seguro de que quieres eliminar la carpeta "${folderPath}" y todos sus archivos?`)) {
        const parts = folderPath.split('/');
        let parent = projectStructure;

        for (let i = 0; i < parts.length - 1; i++) {
            if (parts[i] === '') continue;
            parent = parent.children.find(child => child.name === parts[i] && child.type === 'folder');
            if (!parent) return;
        }

        const folderName = parts[parts.length - 1];
        const folderIndex = parent.children.findIndex(child => child.name === folderName && child.type === 'folder');

        if (folderIndex !== -1) {
            // Eliminar todos los archivos asociados
            const deleteFilesRecursively = (folder) => {
                folder.children.forEach(child => {
                    if (child.type === 'file') {
                        delete folderCode[child.path];
                    } else if (child.type === 'folder') {
                        deleteFilesRecursively(child);
                    }
                });
            };

            deleteFilesRecursively(parent.children[folderIndex]);

            // Eliminar la carpeta
            parent.children.splice(folderIndex, 1);

            // Cerrar pestañas abiertas de esta carpeta
            openTabs = openTabs.filter(tab => !tab.folder.startsWith(folderPath));

            // Si el archivo activo está en esta carpeta, limpiarlo
            if (activeFolderPath && activeFolderPath.startsWith(folderPath)) {
                activeFolderPath = null;
                activeFile = null;

                if (editor) {
                    editor.setValue('// Bienvenido a BCode  Crea una carpeta o abre tu carpeta para comenzar');
                    const model = editor.getModel();
                    if (model) {
                        monaco.editor.setModelLanguage(model, 'javascript');
                    }
                }
            }

            // Actualizar UI
            renderFileExplorer();
            renderTabs();
            saveState();

            showStatusMessage(`Carpeta "${folderPath}" eliminada`, 'success');
        }
    }
}
// Export current file
function exportFile() {
    if (!activeFolderPath || !activeFile) {
        showStatusMessage('No hay archivo abierto para exportar', 'error');
        return;
    }

    const content = folderCode[activeFolderPath][activeFile];
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = activeFile;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showStatusMessage(`Archivo "${activeFile}" exportado`, 'success');
}





function appendToConsole(type, message, file = '', line = '', col = '') {
    const consoleContent = document.getElementById('console-content');

    // Limpiar el mensaje inicial si existe
    if (consoleContent.children.length === 1 &&
        consoleContent.children[0].classList.contains('text-gray-400')) {
        consoleContent.innerHTML = '';
    }

    const messageElement = document.createElement('div');
    messageElement.className = `console-${type} mb-1`;

    // Formatear la ubicación del error si está disponible
    let locationInfo = '';
    if (file && line) {
        const shortFile = file.split('/').pop().split('\\').pop();
        locationInfo = ` (${shortFile}:${line}${col ? `:${col}` : ''})`;
    }

    // Crear elemento de timestamp
    const timestamp = new Date().toLocaleTimeString();
    const timestampElement = document.createElement('span');
    timestampElement.className = 'text-gray-500 text-xs mr-2';
    timestampElement.textContent = `[${timestamp}]`;
    messageElement.appendChild(timestampElement);

    // Crear elemento de tipo (ERROR, WARN, etc.)
    const typeElement = document.createElement('span');
    typeElement.className = `font-bold mr-2 ${type === 'error' ? 'text-red-400' :
            type === 'warn' ? 'text-yellow-400' :
                'text-blue-400'
        }`;
    typeElement.textContent = type.toUpperCase() + ':';
    messageElement.appendChild(typeElement);

    // Crear elemento de mensaje
    const messageTextElement = document.createElement('span');
    messageTextElement.textContent = message;
    messageElement.appendChild(messageTextElement);

    // Añadir información de ubicación si existe
    if (locationInfo) {
        const locationElement = document.createElement('span');
        locationElement.className = 'text-gray-400 text-xs ml-2';
        locationElement.textContent = locationInfo;
        messageElement.appendChild(locationElement);
    }

    consoleContent.appendChild(messageElement);
    consoleContent.scrollTop = consoleContent.scrollHeight;
}
const originalConsole = {
    log: console.log,
    error: console.error,
    warn: console.warn,
    info: console.info,
    debug: console.debug
};

function initConsoleRedirection() {
    // Verificar si ya está redirigido
    if (window.consoleRedirected) return;

    // Guardar las funciones originales de la consola
    const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info,
        debug: console.debug
    };



    window.consoleRedirected = true;
}


// Import button functionality
document.getElementById('import-btn').addEventListener('click', function () {
    document.getElementById('import-modal').classList.remove('hidden');
    document.getElementById('file-import').value = ''; // Limpiar el input
});


// Browse files button
document.getElementById('browse-files').addEventListener('click', function () {
    const input = document.createElement('input');
    input.type = 'file';
    input.setAttribute('multiple', '');
    input.setAttribute('webkitdirectory', ''); // Permite seleccionar carpetas
    input.click();

    input.onchange = function (e) {
        const files = e.target.files;
        if (files.length > 0) {
            // Extraer el nombre de la carpeta principal
            const folderName = files[0].webkitRelativePath.split('/')[0];

            // Verificar si la carpeta ya existe
            const existingFolder = projectStructure.children.find(
                child => child.name === folderName && child.type === 'folder'
            );

            if (existingFolder) {
                // Si la carpeta ya existe, preguntar si sobrescribir
                if (!confirm(`La carpeta "${folderName}" ya existe. ¿Deseas sobrescribir su contenido?`)) {
                    return;
                }

                // Eliminar la carpeta existente
                const folderIndex = projectStructure.children.findIndex(
                    child => child.name === folderName && child.type === 'folder'
                );
                if (folderIndex !== -1) {
                    projectStructure.children.splice(folderIndex, 1);
                }
            }

            // Crear la nueva carpeta en la raíz
            const newFolder = {
                name: folderName,
                type: 'folder',
                children: [],
                path: folderName
            };

            projectStructure.children.push(newFolder);

            // Procesar cada archivo
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const fileName = file.name;
                    const filePath = file.webkitRelativePath;

                    // Obtener la ruta relativa dentro de la carpeta importada
                    const relativePath = filePath.split('/').slice(1, -1);

                    let currentFolder = newFolder;

                    // Crear subcarpetas si es necesario
                    for (const part of relativePath) {
                        let subfolder = currentFolder.children.find(
                            child => child.name === part && child.type === 'folder'
                        );

                        if (!subfolder) {
                            subfolder = {
                                name: part,
                                type: 'folder',
                                children: [],
                                path: currentFolder.path ? `${currentFolder.path}/${part}` : part
                            };
                            currentFolder.children.push(subfolder);
                        }
                        currentFolder = subfolder;
                    }

                    // Agregar el archivo
                    const newFile = {
                        name: fileName,
                        type: 'file',
                        path: currentFolder.path ? `${currentFolder.path}/${fileName}` : fileName
                    };
                    currentFolder.children.push(newFile);

                    // Guardar el contenido del archivo
                    const folderPath = currentFolder.path || '';
                    if (!folderCode[folderPath]) {
                        folderCode[folderPath] = {};
                    }
                    folderCode[folderPath][fileName] = e.target.result;
                };

                reader.readAsText(file);
            });

            // Actualizar la interfaz después de procesar todos los archivos
            setTimeout(() => {
                renderFileExplorer();
                saveState();
                showStatusMessage(`Carpeta "${folderName}" importada con éxito`, 'success');
                document.getElementById('import-modal').classList.add('hidden');
            }, 100);
        }
    };
});

// // Confirm import button
// document.getElementById('confirm-import').addEventListener('click', function() {
//     document.getElementById('import-modal').classList.add('hidden');
// });
// Export button functionality
// Export button functionality
document.getElementById('export-btn').addEventListener('click', function () {
    // Populate folder select for export - solo carpetas principales
    const select = document.getElementById('export-folder-select');
    select.innerHTML = '<option value="">Seleccionar carpeta...</option>';

    // Solo agregar carpetas del primer nivel
    projectStructure.children.forEach(child => {
        if (child.type === 'folder') {
            const option = document.createElement('option');
            option.value = child.name;  // Solo el nombre, no la ruta completa
            option.textContent = child.name;
            select.appendChild(option);
        }
    });

    document.getElementById('export-modal').classList.remove('hidden');
});


// Confirm export button
document.getElementById('confirm-export').addEventListener('click', function () {
    const folderPath = document.getElementById('export-folder-select').value;
    if (!folderPath) {
        showStatusMessage('Selecciona una carpeta para exportar', 'error');
        return;
    }

    exportFolder(folderPath);
    document.getElementById('export-modal').classList.add('hidden');
});

// Function to export a folder
function exportFolder(folderPath) {
    const folder = findFolder(folderPath);
    if (!folder) {
        showStatusMessage('Carpeta no encontrada', 'error');
        return;
    }

    const zip = new JSZip();

    // Función recursiva para agregar archivos al zip
    function addFilesToZip(currentFolder, currentPath = '') {
        currentFolder.children.forEach(child => {
            const childPath = currentPath ? `${currentPath}/${child.name}` : child.name;

            if (child.type === 'file') {
                const folderPath = child.path.includes('/') ?
                    child.path.substring(0, child.path.lastIndexOf('/')) :
                    '';

                const fileName = child.name;
                const content = folderCode[folderPath]?.[fileName];

                if (content) {
                    zip.file(childPath, content);
                }
            } else if (child.type === 'folder') {
                addFilesToZip(child, childPath);
            }
        });
    }

    addFilesToZip(folder);

    zip.generateAsync({ type: 'blob' }).then(content => {
        const a = document.createElement('a');
        const url = URL.createObjectURL(content);
        a.href = url;
        a.download = `${folder.name}.zip`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 0);

        showStatusMessage(`Carpeta "${folder.name}" exportada`, 'success');
    });
}

// Code actions button functionality
document.getElementById('code-actions-btn').addEventListener('click', function () {
    if (editor) {
        // Cargar el código actual del editor en el textarea
        document.getElementById('code-textarea').value = editor.getValue();
        document.getElementById('code-actions-modal').classList.remove('hidden');
        document.getElementById('code-textarea').focus();
    } else {
        showStatusMessage('No hay código para mostrar', 'error');
    }
});


// Copy code button
document.getElementById('copy-code').addEventListener('click', function () {
    const code = document.getElementById('code-textarea').value;
    navigator.clipboard.writeText(code).then(() => {
        showStatusMessage('Código copiado al portapapeles', 'success');
    });
});

// Paste code button
document.getElementById('paste-code').addEventListener('click', function () {
    navigator.clipboard.readText().then(text => {
        document.getElementById('code-textarea').value = text;
        showStatusMessage('Texto pegado desde el portapapeles', 'success');
    }).catch(err => {
        showStatusMessage('Error al pegar desde el portapapeles', 'error');
    });
});

// Insert code button

document.getElementById('insert-code').addEventListener('click', function () {
    if (editor) {
        const newCode = document.getElementById('code-textarea').value;
        const currentCode = editor.getValue();

        // Solo insertar si el código es diferente al actual
        if (newCode !== currentCode) {
            const selection = editor.getSelection();

            // Si hay texto seleccionado, reemplazarlo
            if (!selection.isEmpty()) {
                const range = new monaco.Range(
                    selection.startLineNumber,
                    selection.startColumn,
                    selection.endLineNumber,
                    selection.endColumn
                );

                editor.executeEdits("", [{
                    range: range,
                    text: newCode,
                    forceMoveMarkers: true
                }]);
            } else {
                // Si no hay selección, reemplazar todo el contenido
                editor.setValue(newCode);

                // Mover el cursor al principio del editor
                editor.setPosition({
                    lineNumber: 1,
                    column: 1
                });
            }

            document.getElementById('code-actions-modal').classList.add('hidden');
            showStatusMessage('Código insertado', 'success');
        } else {
            document.getElementById('code-actions-modal').classList.add('hidden');
            showStatusMessage('No hay cambios para insertar', 'info');
        }
    }
});

// Close code actions modal
document.getElementById('close-code-actions-modal').addEventListener('click', function () {
    document.getElementById('code-actions-modal').classList.add('hidden');
});
// Find folder by path
function findFolder(path) {
    if (!path) return null;

    const parts = path.split('/').filter(part => part !== '');
    let current = projectStructure;

    for (const part of parts) {
        const found = current.children.find(child =>
            child.name === part && child.type === 'folder'
        );

        if (!found) return null;
        current = found;
    }

    return current;
}

// Create folder structure
function createFolderPath(path) {
    const parts = path.split('/');
    let current = projectStructure;

    for (const part of parts) {
        if (part === '') continue;
        let folder = current.children.find(child =>
            child.name === part && child.type === 'folder'
        );

        if (!folder) {
            folder = {
                name: part,
                type: 'folder',
                children: [],
                path: current.path ? `${current.path}/${part}` : part
            };
            current.children.push(folder);
        }

        current = folder;
    }

    return current;
}

function createPrincipalFolder() {
    document.getElementById('new-principal-folder-modal').classList.remove('hidden');
    document.getElementById('principal-folder-name').focus();
    document.getElementById('principal-folder-name').value = '';

    // Configurar el botón de creación
    const createBtn = document.getElementById('create-principal-folder');
    createBtn.onclick = function () {
        const folderName = document.getElementById('principal-folder-name').value.trim();
        if (!folderName) {
            showStatusMessage('El nombre de la carpeta no puede estar vacío', 'error');
            return;
        }

        if (/[<>:"/\\|?*]/.test(folderName)) {
            showStatusMessage('El nombre de la carpeta contiene caracteres no permitidos', 'error');
            return;
        }

        // Verificar si ya existe en la raíz
        const existing = projectStructure.children.find(child =>
            child.name === folderName && child.type === 'folder');

        if (!existing) {
            const newFolder = {
                name: folderName,
                type: 'folder',
                children: [],
                path: folderName,
                isPrincipal: true // Puedes añadir esta propiedad si quieres diferenciarlas
            };

            projectStructure.children.push(newFolder);
            expandedFolders[folderName] = true;

            renderFileExplorer();
            saveState();
            showStatusMessage(`Carpeta principal "${folderName}" creada`, 'success');

            // Cerrar modal
            document.getElementById('new-principal-folder-modal').classList.add('hidden');
        } else {
            showStatusMessage(`La carpeta principal "${folderName}" ya existe`, 'error');
        }
    };
}
async function signUp(email, password) {
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        currentUser = userCredential.user;

        // Limpiar formulario
        document.getElementById('signup-email').value = '';
        document.getElementById('signup-password').value = '';
        document.getElementById('signup-confirm').value = '';

        // Cerrar modal de autenticación
        document.getElementById('auth-modal').classList.add('hidden');

        // Mostrar UI de usuario autenticado
        showAuthUI();
        showStatusMessage('Registro exitoso', 'success');

        // Inicializar estado limpio para nuevo usuario
        resetToInitialState();

        // Guardar estado inicial en Firebase
        await saveState();
    } catch (error) {
        console.error('Error al registrar:', error);
        showAuthError(error, 'signup');
    }
}

function resetToInitialState() {
    projectStructure = {
        name: 'root',
        type: 'folder',
        children: []
    };
    folderCode = {};
    activeFolderPath = null;
    activeFile = null;
    openTabs = [];

    renderFileExplorer();
    renderTabs();

    if (editor) {
        editor.setValue('// Crea una carpeta o abre tu carpeta para comenzar');
    }

    showStatusMessage('Estado inicial cargado', 'success');
}
function showAuthError(error, formType) {
    const errorMessages = {
        'auth/email-already-in-use': 'El correo electrónico ya está en uso',
        'auth/invalid-email': 'Correo electrónico inválido',
        'auth/weak-password': 'La contraseña debe tener al menos 6 caracteres',
        'auth/user-not-found': 'Usuario no encontrado',
        'auth/wrong-password': 'Contraseña incorrecta'
    };

    const message = errorMessages[error.code] || error.message;

    // Mostrar error debajo del formulario correspondiente
    const errorContainer = document.getElementById(`${formType}-error`);
    if (!errorContainer) {
        // Crear contenedor si no existe
        const form = document.getElementById(`${formType}-content`);
        const container = document.createElement('div');
        container.id = `${formType}-error`;
        container.className = 'mt-4 p-3 bg-red-500/20 text-red-400 rounded text-sm';
        form.appendChild(container);
    }

    document.getElementById(`${formType}-error`).textContent = message;

    // También mostrar en la barra de estado
    showStatusMessage(message, 'error');
}
async function signIn(email, password) {
    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        showAuthUI();
        showStatusMessage('Inicio de sesión exitoso', 'success');

        // Cargar el estado desde Firebase
        await loadState();
    } catch (error) {
        console.error('Error al iniciar sesión:', error);

        // Mostrar modal de error personalizado
        if (error.code === 'auth/user-not-found') {
            showErrorModal('Usuario no encontrado', 'El usuario no está registrado. Por favor regístrate primero.');
        } else {
            showStatusMessage(`Error al iniciar sesión: ${error.message}`, 'error');
        }
    }
}

function showErrorModal(title, message) {
    // Crear el modal si no existe
    if (!document.getElementById('error-modal')) {
        const modalHTML = `
        <div id="error-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
            <div class="bg-dark-800 rounded-lg shadow-xl border border-accent-red w-96">
                <div class="p-4 border-b border-accent-red flex items-center justify-between">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-times-circle text-accent-red mr-2"></i>
                        <span>${title}</span>
                    </h3>
                    <button id="close-error-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-4">
                    <p class="text-gray-300">${message}</p>
                </div>
                <div class="p-4 border-t border-dark-700 flex justify-end">
                    <button id="ok-error-modal" class="px-4 py-2 text-sm rounded bg-accent-red hover:bg-red-600 text-white">
                        Aceptar
                    </button>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Agregar event listeners
        document.getElementById('close-error-modal').addEventListener('click', () => {
            document.getElementById('error-modal').classList.add('hidden');
        });

        document.getElementById('ok-error-modal').addEventListener('click', () => {
            document.getElementById('error-modal').classList.add('hidden');
            // Mostrar pestaña de registro
            document.querySelector('.auth-tab[data-tab="signup"]').click();
        });
    }

    // Mostrar el modal
    document.getElementById('error-modal').classList.remove('hidden');
}

async function signOut() {
    try {
        // Mostrar mensaje de "Cerrando sesión..."
        showStatusMessage('Cerrando sesión...', 'info');

        // Guardar el estado actual antes de cerrar sesión
        await saveState();

        // Mostrar spinner o indicador de carga
        const signoutBtn = document.getElementById('signout-btn');
        const originalContent = signoutBtn.innerHTML;
        signoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Cerrando...';
        signoutBtn.disabled = true;

        // Cerrar sesión
        await auth.signOut();
        currentUser = null;

        // Limpiar completamente el Local Storage al cerrar sesión
        localStorage.removeItem('bustosCodeState');

        // Restaurar botón
        signoutBtn.innerHTML = originalContent;
        signoutBtn.disabled = false;

        // Mostrar UI y mensaje
        showAuthUI();
        showStatusMessage('Sesión cerrada', 'success');

        // Resetear el estado a valores iniciales
        resetToInitialState();
    } catch (error) {
        console.error('Error al cerrar sesión:', error);

        // Restaurar botón en caso de error
        const signoutBtn = document.getElementById('signout-btn');
        signoutBtn.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión';
        signoutBtn.disabled = false;

        showStatusMessage(`Error al cerrar sesión: ${error.message}`, 'error');
    }
}

// Mostrar/ocultar elementos según el estado de autenticación
function showAuthUI() {
    const authModal = document.getElementById('auth-modal');
    const userProfile = document.querySelector('.user-profile');

    if (currentUser) {
        // Usuario autenticado
        authModal.classList.add('hidden');
        userProfile.classList.remove('hidden');

        // Mostrar iniciales del usuario
        const initials = currentUser.email.charAt(0).toUpperCase();
        document.querySelector('.user-initials').textContent = initials;
        document.querySelector('.user-email').textContent = currentUser.email;

        // Mejorar el dropdown
        const dropdown = userProfile.querySelector('.dropdown');
        let hideTimeout;

        userProfile.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            dropdown.classList.remove('hidden');
        });

        userProfile.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                dropdown.classList.add('hidden');
            }, 300);
        });

        dropdown.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
        });

        dropdown.addEventListener('mouseleave', () => {
            dropdown.classList.add('hidden');
        });
    } else {
        // Usuario no autenticado
        userProfile.classList.add('hidden');
    }
}
// Auth event listeners
document.getElementById('signin-btn').addEventListener('click', function () {
    document.getElementById('auth-modal').classList.remove('hidden');
});

document.getElementById('signout-btn').addEventListener('click', signOut);

document.getElementById('close-auth-modal').addEventListener('click', function () {
    document.getElementById('auth-modal').classList.add('hidden');
});

// Auth tabs
document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', function () {
        const tabName = this.getAttribute('data-tab');

        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(t => {
            t.classList.remove('border-accent-purple', 'text-white');
            t.classList.add('text-gray-400');
        });
        this.classList.add('border-accent-purple', 'text-white');

        // Update content
        document.querySelectorAll('.auth-content').forEach(content => {
            content.classList.add('hidden');
        });
        document.getElementById(`${tabName}-content`).classList.remove('hidden');
    });
});

// Login button
document.getElementById('login-btn').addEventListener('click', async function () {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;

    // Limpiar errores previos
    document.getElementById('login-error').textContent = '';

    if (!email || !password) {
        showAuthError({ code: '', message: 'Por favor ingresa email y contraseña' }, 'login');
        return;
    }

    try {
        await signIn(email, password);
    } catch (error) {
        showAuthError(error, 'login');
    }
});

// Signup button
document.getElementById('signup-btn').addEventListener('click', async function () {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const confirm = document.getElementById('signup-confirm').value;

    // Limpiar errores previos
    document.getElementById('signup-error').textContent = '';

    if (!email || !password || !confirm) {
        showAuthError({ code: '', message: 'Por favor completa todos los campos' }, 'signup');
        return;
    }

    if (password !== confirm) {
        showAuthError({ code: '', message: 'Las contraseñas no coinciden' }, 'signup');
        return;
    }

    if (password.length < 6) {
        showAuthError({ code: 'auth/weak-password', message: '' }, 'signup');
        return;
    }

    try {
        await signUp(email, password);
    } catch (error) {
        showAuthError(error, 'signup');
    }
});
document.getElementById('new-folder-principal-btn').addEventListener('click', createPrincipalFolder);
document.getElementById('close-new-principal-folder-modal').addEventListener('click', function () {
    document.getElementById('new-principal-folder-modal').classList.add('hidden');
});
document.addEventListener('DOMContentLoaded', function () {
    init();
    initConsoleRedirection();
});



    </script>
</body>

</html  por favor modifica eso ojo eso solo es acceso lo demas sigue tal cual  codigo completo de las funciones modificadas tal cual completo

ojo codigos completo  las reglas yo lo debo de poder manejar de firestore firebase  como cuando activarlo   y que mensaje enviarle al activar