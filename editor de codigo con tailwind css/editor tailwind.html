<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCode</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Spectrum Color Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            900: '#1e1e28',
                            800: '#282a36',
                            700: '#44475a',
                            600: '#6272a4',
                            500: '#f8f8f2',
                        },
                        accent: {
                            purple: '#bd93f9',
                            pink: '#ff79c6',
                            teal: '#8be9fd',
                            amber: '#ffb86c',
                            green: '#50fa7b',
                            red: '#ff5555'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/editor/editor.main.min.css">
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Spectrum Color Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css">
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Smooth transitions */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
        
        /* Editor container glow effect */
        .editor-glow {
            box-shadow: 0 0 15px rgba(189, 147, 249, 0.3);
        }
        
        /* File tree highlight */
        .file-highlight {
            position: relative;
        }
        .file-highlight::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 2px;
            background: #bd93f9;
            transform: scaleY(0);
            transform-origin: top;
            transition: transform 0.2s ease;
        }
        .file-highlight.active::after {
            transform: scaleY(1);
        }
        
        /* Floating action buttons */
        .fab {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }
        .fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Terminal cursor effect */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .terminal-cursor {
            animation: blink 1s step-end infinite;
        }
        
        /* Gradient text */
        .gradient-text {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, #bd93f9, #ff79c6);
        }
        
        /* Monaco Editor custom styles */
        .monaco-editor .suggest-widget .monaco-list-row.focused .codicon {
            color: #bd93f9 !important;
        }
        .monaco-editor .suggest-widget .monaco-list-row.focused {
            color: #f8f8f2 !important;
            background-color: #44475a !important;
        }
        .monaco-editor .parameter-hints-widget {
            border: 1px solid #44475a;
            background-color: #282a36;
        }
        .monaco-editor .parameter-hints-widget .signature {
            color: #f8f8f2;
        }
        .monaco-editor .parameter-hints-widget .docs {
            color: #6272a4;
        }
        
        /* Custom modal styles */
        .modal-overlay {
            background-color: rgba(30, 30, 40, 0.8);
        }
        
        /* Custom tooltip */
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #282a36;
            color: #f8f8f2;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .console-log {
            color: #f8f8f2;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        .console-error {
            color: #ff5555;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        .console-warn {
            color: #ffb86c;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        .console-info {
            color: #8be9fd;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 4px 0;
            line-height: 1.5;
        }

        #console-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-family: monospace;
            line-height: 1.5;
            padding: 8px;
        }

        /* Estilos para errores */
        .error-lens-decoration-error {
            background: rgba(255, 85, 85, 0.1);
            border-bottom: 2px dashed #ff5555;
        }

        .error-lens-glyph-margin-error {
            background: rgba(255, 85, 85, 0.2);
        }

        .error-lens-inline-error::after {
            content: attr(title);
            color: #ff5555;
            background: rgba(30, 30, 40, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 12px;
        }

        /* Estilos para advertencias */
        .error-lens-decoration-warning {
            background: rgba(255, 184, 108, 0.1);
            border-bottom: 2px dashed #ffb86c;
        }

        .error-lens-glyph-margin-warning {
            background: rgba(255, 184, 108, 0.2);
        }

        .error-lens-inline-warning::after {
            content: attr(title);
            color: #ffb86c;
            background: rgba(30, 30, 40, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 12px;
        }

        /* Estilos para información */
        .error-lens-decoration-info {
            background: rgba(139, 233, 253, 0.1);
            border-bottom: 2px dashed #8be9fd;
        }

        .error-lens-glyph-margin-info {
            background: rgba(139, 233, 253, 0.2);
        }

        .error-lens-inline-info::after {
            content: attr(title);
            color: #8be9fd;
            background: rgba(30, 30, 40, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 5px;
            font-size: 12px;
        }
        #sidebar {
            position: absolute;
            height: calc(100vh - 3.5rem);
            z-index: 20;
            transition: transform 0.3s ease-in-out;
        }

        @media (min-width: 768px) {
            #sidebar {
                position: absolute;
                transform: translateX(0);
            }
            
            #sidebar.-translate-x-full {
                transform: translateX(-100%);
            }
            #quick-access {
                position: absolute;
                right: 0;
                top: 0;
                height: 100%;
                z-index: 20;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
            }

            #quick-access.show {
                transform: translateX(0);
            }

        }
        
       
        #main-content {
            width: 100%;
            transition: width 0.3s ease;
        }

        #editor-container {
            width: 100%;
        }

        #monaco-editor {
            width: 100% !important;
        }

        #quick-access {
    position: absolute; /* Siempre posición absoluta */
    right: 0;
    top: 0;
    height: 100%;
    z-index: 20;
    transform: translateX(100%);
    transition: transform 0.3s ease-in-out;
}

#quick-access.show {
    transform: translateX(0);
}

.tooltip-text{
    font-size: 1rem;
    font-family:monospace;
    text-align: center;
    align-items: center;
}




        
    </style>
</head>
<body class="bg-dark-900 text-gray-200 font-sans antialiased overflow-hidden h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="bg-dark-800 border-b border-dark-700 px-4 py-3 flex items-center justify-between">
        <div class="flex flex-1 overflow-hidden w-full">
            <!-- Menu Button -->
            <button id="menu-toggle" class="text-gray-400 hover:text-white transition-all p-2 rounded-md hover:bg-dark-700">
                <i class="fas fa-bars text-lg"></i>
            </button>
            
            <!-- Logo/Brand -->
            <div class="flex items-center">
                <i class="fas fa-code text-accent-purple text-xl mr-2"></i>
                <span class="text-xl font-bold gradient-text">BCode</span>
            </div>
        </div>
        
        <!-- Right Side Controls -->
        <div class="flex items-center space-x-3">
            <!-- Theme Toggle -->
            <button id="theme-toggle" class="text-gray-400 hover:text-white transition-all p-2 rounded-md hover:bg-dark-700">
                <i class="fas fa-moon"></i>
            </button>
            
            <!-- User Profile -->
            <div class="w-8 h-8 rounded-full bg-accent-teal flex items-center justify-center text-white font-semibold cursor-pointer">
                <span>BC</span>
            </div>
        </div>
    </header>
    
    <div class="flex flex-1 overflow-hidden  " >
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-dark-800 w-64 border-r border-dark-700 flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-20">
            <!-- File Explorer Header -->
            <div class="px-4 py-3 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-sm font-semibold uppercase tracking-wider text-gray-400">Explorador</h3>
                <div class="flex space-x-2">
                    <button id="new-folder-btn" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-folder-plus text-sm"></i>
                        <span class="tooltip-text">Nueva carpeta</span>
                    </button>
                    <button id="new-file-btn" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-file-plus text-sm"></i>
                        <span class="tooltip-text">Nuevo archivo</span>
                    </button>
                </div>
            </div>
            
            <!-- File Tree -->
                <div id="file-explorer" class="flex-1 overflow-y-auto py-2">
                <!-- Files will be loaded here dynamically -->
                <div id="file-list" class="px-2"></div>
            </div>
            
            <!-- Status Bar -->
            <div class="px-3 py-2 border-t border-dark-700 text-xs text-gray-500 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-circle text-green-500"></i>
                    <span id="current-language">HTML</span>
                </div>
                <div>
                    <span>UTF-8</span>
                </div>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden w-full transition-all duration-300" id="main-content">

            <!-- Editor Tabs -->
            <div id="editor-tabs" class="bg-dark-800 border-b border-dark-700 flex items-center overflow-x-auto">
                <div class="flex">
                    <!-- Tabs will be loaded here dynamically -->
                </div>
                
                <!-- Tab Actions -->
                <div class="ml-auto flex items-center px-3">
                    <button id="close-all-tabs" class="text-gray-400 hover:text-white p-1 rounded hover:bg-dark-700 tooltip">
                        <i class="fas fa-times-circle text-sm"></i>
                        <span class="tooltip-text">Cerrar todas</span>
                    </button>
                </div>
            </div>
            
            <!-- Editor Area -->
            <div id="editor-container" class="flex-1 overflow-hidden editor-glow transition-all flex items-center justify-center">
                <h2 class="text-3xl font-bold text-accent-purple text-center">
                    BCode tu mejor editor de código<br>
                    <span class="text-xl text-gray-400 font-normal">Crea tu archivo para empezar a codificar</span>
                </h2>
                <!-- Monaco Editor se cargará aquí cuando se necesite -->
                <div id="monaco-editor" class="h-full w-full hidden"></div>
            </div>
            
            <!-- Preview Panel -->
            <div id="preview-container" class="bg-white h-0 overflow-hidden transition-all duration-300">
                <iframe id="preview-frame" class="w-full h-full border-none"></iframe>
            </div>
            
            <!-- Terminal/Output Panel -->
            <div id="terminal-panel" class="bg-dark-800 border-t border-dark-700 h-0 overflow-hidden transition-all duration-300">
                <!-- Terminal Tabs -->
                <div class="bg-dark-800 flex border-b border-dark-700">
                    <button class="terminal-tab px-4 py-2 text-sm font-medium border-b-2 border-accent-purple text-white" data-tab="terminal">
                        Terminal
                    </button>
                    <button class="terminal-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white" data-tab="console">
                        Consola
                    </button>
                    <button class="terminal-tab px-4 py-2 text-sm font-medium text-gray-400 hover:text-white" data-tab="problems">
                        Problemas
                    </button>
                </div>
                
                <!-- Terminal Content -->
                <div id="terminal-content" class="p-3 font-mono text-sm h-full overflow-y-auto">
                    <div class="text-green-400">$ Listo para ejecutar código</div>
                    <div class="mt-4 flex items-center">
                        <span class="text-green-400">$</span>
                        <span id="terminal-cursor" class="terminal-cursor ml-1">_</span>
                    </div>
                </div>
                
                <!-- Console Content -->
                <div id="console-content" class="p-3 font-mono text-sm h-full overflow-y-auto hidden">
                    <div class="text-gray-400"></div>
                </div>

                
                <!-- Problems Content -->
                <div id="problems-content" class="p-3 font-mono text-sm h-full overflow-y-auto hidden">
                    <div class="text-gray-400">tu codigo no tiene problemas parece estar todo ok</div>
                </div>
            </div>
        </main>
        
        <!-- Quick Access Panel (Right Sidebar) -->
        <aside id="quick-access" class="bg-dark-800 w-48 border-l border-dark-dark-700 flex flex-col">
            <div class="px-4 py-3 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-sm font-semibold uppercase tracking-wider text-gray-400">Accesos</h3>
                <button id="close-quick-access" class="text-gray-400 hover:text-white transition-all p-1 rounded hover:bg-dark-700">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto py-2 px-2">
                <!-- Color Picker -->
                <div id="color-picker-container" class="mb-4">
                    <input type="text" id="color-picker" class="w-full" />
                </div>
                
                <!-- Quick Insert Buttons -->
                <div class="mb-4">
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">INSERTAR</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded rounded hover:bg-dark-600 hover:text-white" data-insert="{">{</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="}">}</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="[">[</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="]">]</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="(">(</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert=")">)</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="'">'</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert='"'>"</button>
                        <button class="quick-insert-btn bg-dark-700 text-gray-300 p-2 rounded hover:bg-dark-600 hover:text-white" data-insert="`">`</button>
                    </div>
                </div>
                
                <!-- Code Actions -->
                <div>
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">ACCIONES</h4>
                    <div class="space-y-2">
                        <button id="comment-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">
                            <i class="fas fa-comment mr-2 text-gray-400"></i>
                            Comentar
                        </button>
                        <button id="format-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">
                            <i class="fas fa-align-left mr-2 text-gray-400"></i>
                            Formatear
                        </button>
                        <button id="copy-all-btn" class="w-full text-left px-3 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600 flex items-center">
                            <i class="fas fa-copy mr-2 text-gray-400"></i>
                            Copiar todo
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Status Bar -->
    <footer class="bg-dark-800 border-t border-dark-700 px-3 py-1 flex items-center justify-between text-xs text-gray-400">
        <div class="flex items-center space-x-4">
            <div class="flex items-center">
                <i class="fas fa-code-branch mr-1"></i>
                <span>main</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-circle text-green-500 mr-1"></i>
                <span id="status-message">Ready</span>
            </div>
        </div>
        
        <div class="flex items-center space-x-4">
            <div class="flex items-center">
                <i class="fas fa-laptop-code mr-1"></i>
                <span>UTF-8</span>
            </div>
            <div class="flex items-center">
                <i class="fab fa-js mr-1"></i>
                <span id="current-file-type">JavaScript</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-clock mr-1"></i>
                <span id="current-time">00:00</span>
            </div>
        </div>
    </footer>
    
    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 flex flex-col space-y-3 z-10">
        <!-- Run Button -->
        <button id="run-btn" class="fab w-12 h-12 rounded-full bg-accent-purple text-white flex items-center justify-center shadow-lg hover:bg-purple-600 tooltip">
            <i class="fas fa-play"></i>
            <span class="tooltip-text">Ejecutar código</span>
        </button>
        
        <!-- Terminal Toggle -->
        <button id="terminal-toggle" class="fab w-12 h-12 rounded-full bg-dark-700 text-gray-300 flex items-center justify-center shadow-lg hover:bgbg-dark-600 hover:text-white tooltip">
            <i class="fas fa-terminal"></i>
            <span class="tooltip-text">Terminal</span>
        </button>
        
        <!-- Quick Access Toggle -->
        <button id="quick-access-toggle" class="fab w-12 h-12 rounded-full bg-dark-700 text-gray-300 flex items-center justify-center shadow-lg hover:bg-dark-600 hover:text-white tooltip">
            <i class="fas fa-bolt"></i>
            <span class="tooltip-text">Accesos rápidos</span>
        </button>
    </div>
    
    <!-- AI Assistant Button -->
    <div class="fixed bottom-6 left-6 z-10">
        <button id="ai-assistant" class="fab w-14 h-14 rounded-full bg-gradient-to-r from-accent-purple to-accent-pink text-white flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105 transition-all tooltip">
            <i class="fas fa-robot text-xl"></i>
            <span class="tooltip-text">Asistente de IA</span>
        </button>
    </div>
    
    <!-- AI Assistant Panel -->
    <div id="ai-panel" class="fixed bottom-20 left-6 w-80 bg-dark-800 rounded-lg shadow-xl border border-dark-700 hidden transform transition-all duration-300 origin-bottom-left">
        <div class="p-3 border-b border-dark-700 flex items-center justify-between">
            <h3 class="text-sm font-semibold">Asistente de IA</h3>
            <button id="close-ai" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="ai-chat" class="p-3 h-64 overflow-y-auto">
            <div class="bg-dark-700 rounded-lg p-3 mb-3">
                <div class="text-xs text-gray-400 mb-1">AI:</div>
                <p class="text-sm">Hola, soy tu asistente de IA. ¿En qué puedo ayudarte con tu código hoy?</p>
            </div>
        </div>
        <div class="p-3 border-t border-dark-700">
            <div class="flex">
                <input id="ai-input" type="text" placeholder="Escribe tu pregunta..." class="flex-1 bg-dark-700 border border-dark-600 rounded-l-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                <button id="ai-send" class="bg-accent-purple text-white px-3 py-2 rounded-r-lg text-sm hover:bg-purple-600">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- New Folder Modal -->
    <div id="new-folder-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Nueva Carpeta</h3>
                <button id="close-new-folder-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="folder-name" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 mb-4 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="Nombre de la carpeta">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-new-folder" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="create-folder" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Crear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New File Modal -->
    <div id="new-file-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Nuevo Archivo</h3>
                <button id="close-new-file-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <input type="text" id="file-name" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 mb-4 focus:outline-none focus:ring-1 focus:ring-accent-purple" placeholder="Nombre del archivo (ej. index.html)">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-new-file" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="create-file" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Crear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Importar Archivos</h3>
                <button id="close-import-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Seleccionar archivos o carpeta</label>
                    <input type="file" id="file-import" class="hidden" multiple webkitdirectory>
                    <button id="browse-files" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 text-sm hover:bg-dark-600">
                        <i class="fas fa-folder-open mr-2"></i> Seleccionar archivos
                    </button>
                </div>
                <div class="flex justify-end space-x--2">
                    <button id="cancel-import" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="confirm-import" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Importar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-96">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Exportar Proyecto</h3>
                <button id="close-export-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Seleccionar carpeta</label>
                    <select id="export-folder-select" class="w-full bg-dark-700 border border-dark-600 rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple">
                        <!-- Folders will be loaded here -->
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-export" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        Cancelar
                    </button>
                    <button id="confirm-export" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Code Actions Modal -->
    <div id="code-actions-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-dark-800 rounded-lg shadow-xl border border-dark-700 w-1/2 max-w-2xl">
            <div class="p-4 border-b border-dark-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Acciones de Código</h3>
                <button id="close-code-actions-modal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <textarea id="code-textarea" class="w-full h-64 bg-dark-700 border border-dark-600 rounded px-3 py-2 font-mono text-sm focus:outline-none focus:ring-1 focus:ring-accent-purple"></textarea>
                <div class="flex justify-end space-x-2 mt-4">
                    <button id="copy-code" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        <i class="fas fa-copy mr-2"></i> Copiar
                    </button>
                    <button id="paste-code" class="px-4 py-2 text-sm rounded bg-dark-700 hover:bg-dark-600">
                        <i class="fas fa-paste mr-2"></i> Pegar
                    </button>
                    <button id="insert-code" class="px-4 py-2 text-sm rounded bg-accent-purple hover:bg-purple-600 text-white">
                        <i class="fas fa-code mr-2"></i> Insertar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    
    <!-- Main App Script -->
    <script>
        window.addEventListener('beforeunload', function(e) {
            saveState();
        });
        // Global variables
let expandedFolders = {};
let editor = null;
let currentTheme = 'dark';
let folders = {};
let folderCode = {};
let activeFolder = null;
let activeFile = null;
let openTabs = [];
let monacoInitialized = false;

// Initialize the app
function init() {
    // Load saved state
    loadState();
    
    // Initialize Monaco Editor
    initMonaco();
    
    // Setup event listeners
    setupEventListeners();
    
    // Update clock
    updateClock();
    setInterval(updateClock, 60000);
    
    // Initialize color picker
    $("#color-picker").spectrum({
        color: "#bd93f9",
        preferredFormat: "hex",
        showInput: true,
        showPalette: true,
        palette: [
            ["#000000", "#44475a", "#6272a4", "#bd93f9"],
            ["#ff5555", "#ff79c6", "#ffb86c", "#f1fa8c"],
            ["#50fa7b", "#8be9fd", "#282a36", "#f8f8f2"]
        ],
        change: function(color) {
            if (editor) {
                const selection = editor.getSelection();
                const range = new monaco.Range(
                    selection.startLineNumber,
                    selection.startColumn,
                    selection.endLineNumber,
                    selection.endColumn
                );
                editor.executeEdits("", [{
                    range: range,
                    text: color.toHexString(),
                    forceMoveMarkers: true
                }]);
            }
        }
    });
}

// Initialize Monaco Editor
function initMonaco() {
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
    
    require(['vs/editor/editor.main'], function() {
        monacoInitialized = true;
        
        // Define a new theme
        monaco.editor.defineTheme('bustoscode-dark', {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'comment', foreground: '#6272a4', fontStyle: 'italic' },
                { token: 'keyword', foreground: '#ff79c6' },
                { token: 'number', foreground: '#bd93f9' },
                { token: 'string', foreground: '#f1fa8c' },
                { token: 'type', foreground: '#8be9fd' },
                { token: 'delimiter.html', foreground: '#ffb86c' }
            ],
            colors: {
                'editor.background': '#1e1e28',
                'editor.foreground': '#f8f8f2',
                'editor.lineHighlightBackground': '#282a36',
                'editor.lineHighlightBorder': '#282a36',
                'editor.selectionBackground': '#44475a',
                'editor.inactiveSelectionBackground': '#44475a80',
                'editorCursor.foreground': '#f8f8f2',
                'editorWhitespace.foreground': '#44475a',
                'editorIndentGuide.background': '#44475a',
                'editorIndentGuide.activeBackground': '#6272a4',
                'editor.selectionHighlightBorder': '#6272a4'
            }
        });
        
        // Create editor
        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: "// Bienvenido a BCode  Crea una carpeta o abre tu carpeta para comenzar",
            language: 'javascript',
            theme: 'bustoscode-dark',
            automaticLayout: true,
            minimap: { enabled: true },
            scrollBeyondLastLine: false,
            fontSize: 14,
            lineNumbers: 'on',
            roundedSelection: true,
            scrollbar: {
                vertical: 'auto',
                horizontal: 'auto',
                useShadows: true
            },
            tabSize: 2,
            suggestOnTriggerCharacters: true,
            wordBasedSuggestions: true,
            autoClosingBrackets: 'always',
            autoClosingQuotes: 'always',
            autoIndent: 'full',
            formatOnPaste: true,
            formatOnType: true
        });
        
        // Set up editor events
        editor.onDidChangeModelContent(function() {
            if (activeFolder && activeFile) {
                const fileExt = activeFile.split('.').pop();
                let language = 'plaintext';
                
                switch(fileExt) {
                    case 'js': language = 'javascript'; break;
                    case 'html': language = 'html'; break;
                    case 'css': language = 'css'; break;
                    case 'json': language = 'json'; break;
                }
                
                if (!folderCode[activeFolder]) {
                    folderCode[activeFolder] = {};
                }
                
                folderCode[activeFolder][activeFile] = editor.getValue();
                saveState();
                
                // Update tab status
                updateTabStatus(activeFile, false);
            }
        });
        
        // Set up keybindings
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
            showStatusMessage('Archivo guardado automáticamente', 'success');
        });
        
        // If we have an active file, load it
        if (activeFolder && activeFile) {
            loadFile(activeFolder, activeFile);
        }
        editor.onDidChangeModelContent(() => {
            const errors = detectErrors(editor.getValue());
            monaco.editor.setModelMarkers(editor.getModel(), "owner", errors);
            updateErrorDecorations();
            setTimeout(() => {
            validateCurrentFile();
        }, 500);
        });
        // Cargar estado del sidebar al iniciar
        const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
        const sidebar = document.getElementById('sidebar');
        if (sidebarHidden) {
            sidebar.classList.add('-translate-x-full');
        } else {
            sidebar.classList.remove('-translate-x-full');
        }


    });
}

function updateErrorDecorations() {
    const model = editor.getModel();
    if (!model) return;
    
    const markers = monaco.editor.getModelMarkers({ resource: model.uri });
    const decorations = [];
    
    markers.forEach(marker => {
        // Decoración principal (subrayado)
        decorations.push({
            range: new monaco.Range(
                marker.startLineNumber,
                marker.startColumn,
                marker.endLineNumber,
                marker.endColumn
            ),
            options: {
                className: marker.severity === monaco.MarkerSeverity.Error ? 
                    'error-lens-decoration-error' : 
                    marker.severity === monaco.MarkerSeverity.Warning ?
                    'error-lens-decoration-warning' :
                    'error-lens-decoration-info',
                glyphMarginClassName: marker.severity === monaco.MarkerSeverity.Error ? 
                    'error-lens-glyph-margin-error' : 
                    'error-lens-glyph-margin-warning',
                hoverMessage: {
                    value: `**${monaco.MarkerSeverity[marker.severity]}**: ${marker.message}`,
                    isTrusted: true
                },
                stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,
                zIndex: 10
            }
        });
        
        // Decoración adicional para el texto en línea
        decorations.push({
            range: new monaco.Range(
                marker.startLineNumber,
                marker.startColumn,
                marker.endLineNumber,
                marker.endColumn
            ),
            options: {
                afterContentClassName: marker.severity === monaco.MarkerSeverity.Error ? 
                    'error-lens-inline-error' : 
                    marker.severity === monaco.MarkerSeverity.Warning ?
                    'error-lens-inline-warning' :
                    'error-lens-inline-info',
                stickiness: monaco.editor.TrackedRangeStickinessiness.NeverGrowsWhenTypingAtEdges
            }
        });
    });
    
    // Aplicar todas las decoraciones
    editor.deltaDecorations([], decorations);
}
function detectErrors(code) {
    const errors = [];
    const lines = code.split('\n');
    
    // 1. Detección de variables duplicadas
    const variableDeclarations = {};
    const variableRegex = /(?:let|const|var)\s+([a-zA-Z_$][\w$]*)/g;
    
    let match;
    while ((match = variableRegex.exec(code)) !== null) {
        const varName = match[1];
        const lineNumber = code.substring(0, match.index).split('\n').length;
        
        if (variableDeclarations[varName]) {
            errors.push({
                startLineNumber: lineNumber,
                startColumn: match.index - code.lastIndexOf('\n', match.index) - 1,
                endLineNumber: lineNumber,
                endColumn: match.index - code.lastIndexOf('\n', match.index) - 1 + match[0].length,
                message: `Variable '${varName}' ya ha sido declarada anteriormente`,
                severity: monaco.MarkerSeverity.Error
            });
            
            // También marcar la declaración anterior
            errors.push({
                startLineNumber: variableDeclarations[varName].line,
                startColumn: variableDeclarations[varName].column,
                endLineNumber: variableDeclarations[varName].line,
                endColumn: variableDeclarations[varName].column + match[0].length,
                message: `Primera declaración de '${varName}' aquí`,
                severity: monaco.MarkerSeverity.Info
            });
        } else {
            variableDeclarations[varName] = {
                line: lineNumber,
                column: match.index - code.lastIndexOf('\n', match.index) - 1
            };
        }
    }
    
    // 2. Detección de errores de sintaxis básica
    try {
        new Function(code);
    } catch (e) {
        const lineMatch = e.message.match(/:(\d+):(\d+)/);
        if (lineMatch) {
            errors.push({
                startLineNumber: parseInt(lineMatch[1]),
                startColumn: parseInt(lineMatch[2]),
                endLineNumber: parseInt(lineMatch[1]),
                endColumn: parseInt(lineMatch[2]) + 5,
                message: e.message.split('\n')[0],
                severity: monaco.MarkerSeverity.Error
            });
        }
    }
    
    // 3. Detección de funciones no utilizadas
    const functionRegex = /function\s+([a-zA-Z_$][\w$]*)\s*$$/g;
    const functionCalls = {};
    const functionDeclarations = {};
    
    // Primero recopilamos todas las declaraciones
    while ((match = functionRegex.exec(code)) !== null) {
        const funcName = match[1];
        const lineNumber = code.substring(0, match.index).split('\n').length;
        functionDeclarations[funcName] = {
            line: lineNumber,
            column: match.index - code.lastIndexOf('\n', match.index) - 1
        };
    }
    
    // Luego buscamos llamadas a funciones
    const callRegex = /([a-zA-Z_$][\w$]*)\s*$$/g;
    while ((match = callRegex.exec(code)) !== null) {
        const funcName = match[1];
        if (functionDeclarations[funcName]) {
            functionCalls[funcName] = true;
        }
    }
    
    // Marcamos funciones no utilizadas
    Object.keys(functionDeclarations).forEach(funcName => {
        if (!functionCalls[funcName] && funcName !== 'main') {
            const decl = functionDeclarations[funcName];
            errors.push({
                startLineNumber: decl.line,
                startColumn: decl.column,
                endLineNumber: decl.line,
                endColumn: decl.column + funcName.length + 9, // "function ".length + nombre
                message: `Función '${funcName}' declarada pero nunca utilizada`,
                severity: monaco.MarkerSeverity.Warning
            });
        }
    });
    
    // 4. Detección de posibles errores comunes
    lines.forEach((line, index) => {
        const lineNumber = index + 1;
        
        // Comparaciones con === vs ==
        if (line.includes(' == ') || line.includes(' != ')) {
            errors.push({
                startLineNumber: lineNumber,
                startColumn: line.indexOf(' == ') > -1 ? line.indexOf(' == ') : line.indexOf(' != '),
                endLineNumber: lineNumber,
                endColumn: (line.indexOf(' == ') > -1 ? line.indexOf(' == ') : line.indexOf(' != ')) + 4,
                message: 'Considera usar === en lugar de == para comparaciones estrictas',
                severity: monaco.MarkerSeverity.Warning
            });
        }
        
        // Comprobación de asignación en condicional
        if (line.match(/if\s*$$[^=]*=[^=].*$$/)) {
            errors.push({
                startLineNumber: lineNumber,
                startColumn: line.indexOf('='),
                endLineNumber: lineNumber,
                endColumn: line.indexOf('=') + 1,
                message: 'Posible asignación (=) en lugar de comparación (== o ===)',
                severity: monaco.MarkerSeverity.Error
            });
        }
    });
    
    return errors;
}



// Setup event listeners
function setupEventListeners() {
    // Menu toggle
    document.getElementById('menu-toggle').addEventListener('click', function() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
        
        // Guardar el estado del sidebar
        const isHidden = sidebar.classList.contains('-translate-x-full');
        localStorage.setItem('sidebarHidden', isHidden);
        
        // Actualizar el ancho del editor
        updateEditorWidth();
        
        // Si estamos en escritorio y abrimos el sidebar, aseg asegurarnos que el quick access esté cerrado
        if (!isHidden && window.innerWidth >= 768) {
            document.getElementById('quick-access').classList.add('translate-x-full');
            updateEditorWidth();
        }
    });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', function() {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        if (editor) {
            editor.updateOptions({ theme: currentTheme === 'dark' ? 'bustoscode-dark' : 'vs' });
        }
        document.body.classList.toggle('bg-gray-100', currentTheme === 'light');
        document.body.classList.toggle('text-gray-800', currentTheme === 'light');
        saveState();
    });

    // New folder button
    document.getElementById('new-folder-btn').addEventListener('click', function() {
        document.getElementById('new-folder-modal').classList.remove('hidden');
        document.getElementById('folder-name').focus();
    });

    // New file button
    document.getElementById('new-file-btn').addEventListener('click', function() {
        if (!activeFolder) {
            showStatusMessage('Selecciona una carpeta primero', 'error');
            return;
        }
        document.getElementById('new-file-modal').classList.remove('hidden');
        document.getElementById('file-name').focus();
    });

    // Close modals
    document.getElementById('close-new-folder-modal').addEventListener('click', function() {
        document.getElementById('new-folder-modal').classList.add('hidden');
    });

    document.getElementById('close-new-file-modal').addEventListener('click', function() {
        document.getElementById('new-file-modal').classList.add('hidden');
    });

    // Cancel buttons
    document.getElementById('cancel-new-folder').addEventListener('click', function() {
        document.getElementById('new-folder-modal').classList.add('hidden');
    });

    document.getElementById('cancel-new-file').addEventListener('click', function() {
        document.getElementById('new-file-modal').classList.add('hidden');
    });

    // Create folder
    document.getElementById('create-folder').addEventListener('click', function() {
        const folderName = document.getElementById('folder-name').value.trim();
        if (folderName) {
            createFolder(folderName);
            document.getElementById('new-folder-modal').classList.add('hidden');
            document.getElementById('folder-name').value = '';
        }
    });

    // Create file
    document.getElementById('create-file').addEventListener('click', function() {
        const fileName = document.getElementById('file-name').value.trim();
        if (fileName) {
            createFile(fileName);
            document.getElementById('new-file-modal').classList.add('hidden');
            document.getElementById('file-name').value = '';
        }
    });

    // Run button
    document.getElementById('run-btn').addEventListener('click', function() {
        togglePreview();
    });
    function togglePreview() {
        const previewContainer = document.getElementById('preview-container');
        const terminalPanel = document.getElementById('terminal-panel');
        
        if (previewContainer.classList.contains('h-0')) {
            // Si está cerrado, ejecutar código y mostrar preview
            runCode();
        } else {
            // Si está abierto, cerrarlo
            previewContainer.classList.add('h-0');
            previewContainer.classList.remove('h-64');
            terminalPanel.classList.add('h-0');
            terminalPanel.classList.remove('h-64');
            showStatusMessage('Vista previa cerrada', 'success');
        }
    }


    
    // Terminal toggle
    document.getElementById('terminal-toggle').addEventListener('click', function() {
        const terminalPanel = document.getElementById('terminal-panel');
        const previewContainer = document.getElementById('preview-container');
        
        if (terminalPanel.classList.contains('h-0')) {
            terminalPanel.classList.remove('h-0');
            terminalPanel.classList.add('h-64');
            previewContainer.classList.add('h-0');
            previewContainer.classList.remove('h-64');
        } else {
            terminalPanel.classList.add('h-0');
            terminalPanel.classList.remove('h-64');
            previewContainer.classList.add('h-0');
            previewContainer.classList.remove('h-64');
        }
    });

     // Quick access toggle - modificado para actualizar el ancho del editor
     document.getElementById('quick-access-toggle').addEventListener('click', function() {
        const quickAccess = document.getElementById('quick-access');
        quickAccess.classList.toggle('translate-x-full');
        updateEditorWidth();
    });

    // Close quick access - modificado para actualizar el ancho del editor
    document.getElementById('close-quick-access').addEventListener('click', function() {
        document.getElementById('quick-access').classList.add('translate-x-full');
        updateEditorWidth();
    });
    function updateEditorWidth() {
        const sidebar = document.getElementById('sidebar');
        const quickAccess = document.getElementById('quick-access');
        const mainContent = document.getElementById('main-content');
        
        // Verificar estado de los paneles
        const sidebarHidden = sidebar.classList.contains('-translate-x-full');
        const quickAccessHidden = quickAccess.classList.contains('translate-x-full');
        
        // Aplicar clases según el estado
        if (sidebarHidden && quickAccessHidden) {
            mainContent.classList.remove('md:ml-64', 'md:mr-48');
            mainContent.classList.add('w-full');
        } else {
            if (sidebarHidden) {
                mainContent.classList.remove('md:ml-64');
            } else {
                mainContent.classList.add('md:ml-64');
            }
            
            if (quickAccessHidden) {
                mainContent.classList.remove('md:mr-48');
            } else {
                mainContent.classList.add('md:mr-48');
            }
        }
        
        // Forzar el re-layout del editor
        if (editor) {
            setTimeout(() => {
                editor.layout();
            }, 100);
        }
    }

    // AI Assistant
    document.getElementById('ai-assistant').addEventListener('click', function() {
        document.getElementById('ai-panel').classList.toggle('hidden');
    });

    document.getElementById('close-ai').addEventListener('click', function() {
        document.getElementById('ai-panel').classList.add('hidden');
    });

    // AI Send message
    document.getElementById('ai-send').addEventListener('click', function() {
        sendAIMessage();
    });

    document.getElementById('ai-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendAIMessage();
        }
    });

    // Quick insert buttons
    document.querySelectorAll('.quick-insert-btn').forEach(button => {
        button.addEventListener('click', function() {
            if (editor) {
                const selection = editor.getSelection();
                const range = new monaco.Range(
                    selection.startLineNumber,
                    selection.startColumn,
                    selection.endLineNumber,
                    selection.endColumn
                );
                editor.executeEdits("", [{
                    range: range,
                    text: this.getAttribute('data-insert'),
                    forceMoveMarkers: true
                }]);
            }
        });
    });
    document.getElementById('quick-access-toggle').addEventListener('click', function() {
        document.getElementById('quick-access').classList.toggle('show');
    });

    document.getElementById('close-quick-access').addEventListener('click', function() {
        document.getElementById('quick-access').classList.remove('show');
    });


    // Format button
    document.getElementById('format-btn').addEventListener('click', function() {
        if (editor) {
            editor.getAction('editor.action.formatDocument').run();
            showStatusMessage('Código formateado', 'success');
        }
    });

    // Comment button
    document.getElementById('comment-btn').addEventListener('click', function() {
        if (editor) {
            editor.getAction('editor.action.commentLine').run();
        }
    });

    // Copy all button
    document.getElementById('copy-all-btn').addEventListener('click', function() {
        if (editor) {
            navigator.clipboard.writeText(editor.getValue());
            showStatusMessage('Código copiado al portapapeles', 'success');
        }
    });

    // Close all tabs
    document.getElementById('close-all-tabs').addEventListener('click', function() {
        closeAllTabs();
    });

    // Clear all files button
    document.getElementById('clear-all-btn').addEventListener('click', function() {
        clearAllFiles();
    });

    // Handle tab switching
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('editor-tab')) {
            const fileName = e.target.getAttribute('data-file');
            const folderName = e.target.getAttribute('data-folder');
            switchToTab(folderName, fileName);
        }
        
        if (e.target.classList.contains('terminal-tab')) {
            const tabName = e.target.getAttribute('data-tab');
            switchTerminalTab(tabName);
        }
    });

    // Handle file clicks in explorer
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('file-item')) {
            const fileName = e.target.getAttribute('data-file');
            const  folderName = e.target.getAttribute('data-folder');
            openFile(folderName, fileName);
        }
        
        if (e.target.classList.contains('folder-item')) {
            const folderName = e.target.getAttribute('data-folder');
            toggleFolder(folderName);
        }
        
        // Handle click on add file button in folder
        if (e.target.classList.contains('add-file-btn')) {
            e.stopPropagation();
            const folderName = e.target.closest('.folder-item').getAttribute('data-folder');
            activeFolder = folderName;
            document.getElementById('new-file-modal').classList.remove('hidden');
            document.getElementById('file-name').focus();
        }
        
        // Handle click on delete folder button
        if (e.target.classList.contains('delete-folder-btn')) {
            e.stopPropagation();
            const folderName = e.target.closest('.folder-item').getAttribute('data-folder');
            deleteFolder(folderName);
        }
    });

    // Handle drag and drop for files
    const fileExplorer = document.getElementById('file-explorer');
    fileExplorer.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('bg-dark-700');
    });

    fileExplorer.addEventListener('dragleave', function() {
        this.classList.remove('bg-dark-700');
    });

    fileExplorer.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('bg-dark-700');
        
        if (e.dataTransfer.files.length > 0) {
            handleFileDrop(e.dataTransfer.files);
        }
 
    });
}

// Create a new folder
function createFolder(name) {
    if (!folders[name]) {
        folders[name] = [];
        expandedFolders[name] = true; // Auto-expand new folders
        renderFileExplorer();
        saveState();
        showStatusMessage(`Carpeta "${name}" creada`, 'success');
    } else {
        showStatusMessage(`La carpeta "${name}" ya existe`, 'error');
    }
}

// Create a new file
function createFile(name) {
    if (!activeFolder) {
        showStatusMessage('Selecciona una carpeta primero', 'error');
        return;
    }

    if (!folders[activeFolder].includes(name)) {
        folders[activeFolder].push(name);
        
        if (!folderCode[activeFolder]) {
            folderCode[activeFolder] = {};
        }
        
        // Set default content based on file type
        const extension = name.split('.').pop();
        let content = '';
        
        switch(extension) {
            case 'html':
                content = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCode</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Bienvenido a BCode </h1>
    <script src="script.js"><\/script>
<\/body>
<\/html>`;
                break;
            case 'css':
                content = `/* ${name} */`;
                break;
            case 'js':
                content = `// ${name}`;
                break;
            default:
                content = `// ${name}`;
        }
        
        folderCode[activeFolder][name] = content;
        renderFileExplorer();
        openFile(activeFolder, name);
        saveState();
        showStatusMessage(`Archivo "${name}" creado`, 'success');
    } else {
        showStatusMessage(`El archivo "${name}" ya existe`, 'error');
    }
}

// Open a file
function openFile(folderName, fileName) {
    if (!monacoInitialized) {
        setTimeout(() => openFile(folderName, fileName), 100);
        return;
    }

    activeFolder = folderName;
    activeFile = fileName;
    
    // Add to open tabs if not already there
    if (!openTabs.some(tab => tab.folder === folderName && tab.file === fileName)) {
        openTabs.push({ folder: folderName, file: fileName });
        renderTabs();
    }
    
    loadFile(folderName, fileName);
    highlightActiveFile();
    updateCurrentLanguage();
    saveState();
}

// Load file content into editor
function loadFile(folderName, fileName) {
    const editorContainer = document.getElementById('editor-container');
    const welcomeMessage = editorContainer.querySelector('h2');
    const monacoEditor = document.getElementById('monaco-editor');
    
    if (editor && folderCode[folderName] && folderCode[folderName][fileName]) {
        // Mostrar editor y ocultar mensaje de bienvenida
        welcomeMessage.classList.add('hidden');
        monacoEditor.classList.remove('hidden');
        
        // Resto del código original de loadFile...
        const extension = fileName.split('.').pop();
        let language = 'plaintext';
        
        switch(extension) {
            case 'js': language = 'javascript'; break;
            case 'html': language = 'html'; break;
            case 'css': language = 'css'; break;
            case 'json': language = 'json'; break;
        }

        // Set the model language
        const oldModel = editor.getModel();
        const newModel = monaco.editor.createModel(
            folderCode[folderName][fileName],
            language
        );
        
        editor.setModel(newModel);
        if (oldModel) {
            oldModel.dispose();
        }
        
        // Update status bar
        document.getElementById('current-file-type').textContent = 
            language.charAt(0).toUpperCase() + language.slice(1);
        
        // Highlight active tab
        document.querySelectorAll('.editor-tab').forEach(tab => {
            tab.classList.remove('bg-dark-700', 'text-white');
            tab.classList.add('bg-dark-800', 'text-gray-400');
        });
        
        const activeTab = document.querySelector(`.editor-tab[data-folder="${folderName}"][data-file="${fileName}"]`);
        if (activeTab) {
            activeTab.classList.remove('bg-dark-800', 'text-gray-400');
            activeTab.classList.add('bg-dark-700', 'text-white');
        }else {
                // Mostrar mensaje de bienvenida y ocultar editor
                welcomeMessage.classList.remove('hidden');
                monacoEditor.classList.add('hidden');
            }
    }
}
function runCode() {
    if (!activeFolder) {
        showStatusMessage('No hay carpeta activa para ejecutar', 'error');
        return;
    }
    const consoleContent = document.getElementById('console-content');
    consoleContent.innerHTML = ''; // Limpiar la consola

    if (console.log === originalConsole.log) {
        initConsoleRedirection();
    }

    const previewContainer = document.getElementById('preview-container');
    const terminalPanel = document.getElementById('terminal-panel');
    
    // Mostrar la pestaña de consola
    switchTerminalTab('console');
    
    previewContainer.classList.remove('h-0');
    previewContainer.classList.add('h-64');
    terminalPanel.classList.add('h-0');
    terminalPanel.classList.remove('h-64');
    
    // Configurar el listener para Ctrl+S
    if (editor) {
        editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
            // Guardar el código actual
            if (activeFolder && activeFile) {
                folderCode[activeFolder][activeFile] = editor.getValue();
                saveState();
            }
            
            // Volver a ejecutar el código
            runCode();
            showStatusMessage('Código guardado y actualizado', 'success');
        });
    }
    
    // Get all files in the folder
    const htmlFiles = folders[activeFolder].filter(f => f.endsWith('.html'));
    
    if (htmlFiles.length === 0) {
        showStatusMessage('No se encontró archivo HTML principal', 'error');
        return;
    }
    
    // Use the first HTML file as main file
    const mainHtmlFile = htmlFiles[0];
    
    // Get the main HTML content
    let htmlContent = folderCode[activeFolder][mainHtmlFile];
    
    // Buscar archivos CSS enlazados en el HTML
    const cssLinks = htmlContent.match(/<link[^>]+href=['"]([^'"]+\.css)['"][^>]*>/g) || [];
    cssLinks.forEach(link => {
        const cssFile = link.match(/href=['"]([^'"]+\.css)['"]/)[1];
        if (folders[activeFolder].includes(cssFile)) {
            const cssContent = folderCode[activeFolder][cssFile];
            // Reemplazar el enlace por el contenido CSS
            htmlContent = htmlContent.replace(
                link, 
                `<style>${cssContent}</style>`
            );
        }
    });
    
    // Buscar archivos JS enlazados en el HTML
    const jsScripts = htmlContent.match(/<script[^>]+src=['"]([^'"]+\.js)['"][^>]*><\/script>/g) || [];
    jsScripts.forEach(script => {
        const jsFile = script.match(/src=['"]([^'"]+\.js)['"]/)[1];
        if (folders[activeFolder].includes(jsFile)) {
            const jsContent = folderCode[activeFolder][jsFile];
            // Reemplazar el script por su contenido
            htmlContent = htmlContent.replace(
                script, 
                `<script>${jsContent}<\/script>`
            );
        }
    });
    
    // Añadir script para capturar errores del iframe
    const errorHandlerScript = `
        <script>
            window.addEventListener('error', function(e) {
                window.parent.postMessage({
                    type: 'iframe-error',
                    message: e.message,
                    filename: e.filename,
                    lineno: e.lineno,
                    colno: e.colno,
                    error: e.error ? e.error.stack : null
                }, '*');
                return true; // Prevenir el manejo por defecto
            });
            
            // Capturar errores no capturados en promesas
            window.addEventListener('unhandledrejection', function(e) {
                window.parent.postMessage({
                    type: 'iframe-promise-error',
                    message: e.reason.message || String(e.reason),
                    stack: e.reason.stack
                }, '*');
            });
            
            // Sobrescribir console para enviar mensajes al padre
            const originalConsole = {
                log: console.log,
                error: console.error,
                warn: console.warn,
                info: console.info
            };
            
            ['log', 'error', 'warn', 'info'].forEach(method => {
                console[method] = function() {
                    originalConsole[method].apply(console, arguments);
                    window.parent.postMessage({
                        type: 'iframe-console',
                        method: method,
                        args: Array.from(arguments).map(arg => 
                            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                        )
                    }, '*');
                };
            });
        <\/script>
    `;
    
    // Insertar el script de manejo de errores al final del body
    if (!htmlContent.includes('<\/body>')) {
        htmlContent += '<\/body>';
    }
    htmlContent = htmlContent.replace('<\/body>', errorHandlerScript + '<\/body>');
    
    // Configurar el listener para mensajes del iframe
    window.addEventListener('message', function(e) {
        if (e.data.type === 'iframe-error') {
            let errorMessage = e.data.message;
            if (e.data.error) {
                errorMessage += '\n' + e.data.error;
            }
            appendToConsole('error', errorMessage, e.data.filename, e.data.lineno, e.data.colno);
        } else if (e.data.type === 'iframe-promise-error') {
            appendToConsole('error', `Unhandled Promise Rejection: ${e.data.message}`);
            if (e.data.stack) {
                appendToConsole('error', `Stack: ${e.data.stack}`);
            }
        } else if (e.data.type === 'iframe-console') {
            appendToConsole(e.data.method, e.data.args.join(' '));
        }
    });
    
    // Update iframe
    const iframe = document.getElementById('preview-frame');
    iframe.srcdoc = htmlContent;
    
    // Ejecutar código JavaScript directamente para capturar logs iniciales
    try {
        const jsFiles = folders[activeFolder].filter(f => f.endsWith('.js'));
        jsFiles.forEach(jsFile => {
            const jsContent = folderCode[activeFolder][jsFile];
            try {
                // Usar eval para ejecutar en el contexto global
                const evalFn = new Function(jsContent);
                evalFn();
            } catch (e) {
                appendToConsole('error', `Error al ejecutar ${jsFile}: ${e.message}`, jsFile, e.lineNumber, e.columnNumber);
                if (e.stack) {
                    appendToConsole('error', `Stack: ${e.stack}`);
                }
            }
        });
    } catch (e) {
        appendToConsole('error', `Error general al ejecutar:  ${e.message}`, e.lineNumber, e.columnNumber);
    }
    
    showStatusMessage('Proyecto ejecutado (HTML + CSS + JS)', 'success');
}

// Switch between terminal tabs
function switchTerminalTab(tabName) {
    document.querySelectorAll('.terminal-tab').forEach(tab => {
        if (tab.getAttribute('data-tab') === tabName) {
            tab.classList.add('border-accent-purple', 'text-white');
            tab.classList.remove('text-gray-400');
        } else {
            tab.classList.remove('border-accent-purple', 'text-white');
            tab.classList.add('text-gray-400');
        }
    });
    
    document.getElementById('terminal-content').classList.add('hidden');
    document.getElementById('console-content').classList.add('hidden');
    document.getElementById('problems-content').classList.add('hidden');
    
    document.getElementById(`${tabName}-content`).classList.remove('hidden');
}


// Close all open tabs
function closeAllTabs() {
    openTabs = [];
    renderTabs();
    
    if (editor) {
        editor.setValue('');
        const model = editor.getModel();
        if (model) {
            monaco.editor.setModelLanguage(model, 'javascript');
        }
    }
    
    activeFile = null;
    document.getElementById('current-file-type').textContent = 'JavaScript';
    showStatusMessage('Todas las pestañas cerradas', 'success');
}

// Clear all files and folders
function clearAllFiles() {
    if (confirm('¿Estás seguro de que quieres eliminar TODOS los archivos y carpetas? Esta acción no se puede deshacer.')) {
        folders = {};
        folderCode = {};
        activeFolder = null;
        activeFile = null;
        openTabs = [];
        expandedFolders = {};
        
        // Clear editor
        if (editor) {
            editor.setValue('// Bienvenido a BCode  Crea una carpeta o abre tu carpeta para comenzar');
            const model = editor.getModel();
            if (model) {
                monaco.editor.setModelLanguage(model, 'javascript');
            }
        }
        
        // Clear localStorage
        localStorage.removeItem('bustosCodeState');
        
        // Update UI
        renderFileExplorer();
        renderTabs();
        document.getElementById('current-file-type').textContent = 'JavaScript';
        
        showStatusMessage('Todos los archivos y carpetas eliminados', 'success');
    }
}

// Switch to a specific tab
function switchToTab(folderName, fileName) {
    activeFolder = folderName;
    activeFile = fileName;
    loadFile(folderName, fileName);
    highlightActiveFile();
    updateCurrentLanguage();
    saveState();
}

// Update the current language in status bar
function updateCurrentLanguage() {
    if (activeFile) {
        const extension = activeFile.split('.').pop();
        let language = '';
        
        switch(extension) {
            case 'js': language = 'JavaScript'; break;
            case 'html': language = 'HTML'; break;
            case 'css': language = 'CSS'; break;
            case 'json': language = 'JSON'; break;
            default: language = extension.toUpperCase();
        }
        
        document.getElementById('current-language').textContent = language;
    }
}

// Highlight the active file in explorer
function highlightActiveFile() {
    document.querySelectorAll('.file-item').forEach(file => {
        file.classList.remove('active', 'text-white');
        file.classList.add('text-gray-400');
    });
    
    if (activeFile) {
        const activeFileElement = document.querySelector(`.file-item[data-folder="${activeFolder}"][data-file="${activeFile}"]`);
        if (activeFileElement) {
            activeFileElement.classList.add('active', 'text-white');
            activeFileElement.classList.remove('text-gray-400');
        }
    }
}

// Render the file explorer
function renderFileExplorer() {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    
    // Add clear all button
    const clearAllBtn = document.createElement('button');
    clearAllBtn.id = 'clear-all-btn';
    clearAllBtn.className = 'text-red-400 hover:text-red-500 text-sm mb-4 flex items-center';
    clearAllBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Eliminar todo';
    clearAllBtn.addEventListener('click', clearAllFiles);
    fileList.appendChild(clearAllBtn);
    
    if (Object.keys(folders).length === 0) {
        fileList.innerHTML += `
            <div class="text-center py-4 text-gray-500 text-sm">
                <i class="fas fa-folder-open text-2xl mb-2"></i>
                <p>No hay carpetas creadas</p>
                <button id="create-first-folder" class="mt-2 text-accent-purple hover:underline">
                    Crea tu primera carpeta
                </button>
            </div>
        `;
        
        document.getElementById('create-first-folder').addEventListener('click', function() {
            document.getElementById('new-folder-modal').classList.remove('hidden');
            document.getElementById('folder-name').focus();
        });
        
        return;
    }
    
    Object.keys(folders).forEach(folderName => {
        const folderElement = document.createElement('div');
        folderElement.className = 'mb-2';
        
        const folderHeader = document.createElement('div');
        folderHeader.className = 'flex items-center justify-between px-2 py-1 rounded hover:bg-dark-700 cursor-pointer folder-item';
        folderHeader.setAttribute('data-folder', folderName);
        
        const folderLeft = document.createElement('div');
        folderLeft.className = 'flex items-center';
        
        const folderIcon = document.createElement('i');
        folderIcon.className = expandedFolders[folderName] ? 
            'fas fa-folder-open mr-2 text-accent-amber' : 
            'fas fa-folder mr-2 text-accent-amber';
        
        const folderNameSpan = document.createElement('span');
        folderNameSpan.className = 'text-sm';
        folderNameSpan.textContent = folderName;
        
        folderLeft.appendChild(folderIcon);
        folderLeft.appendChild(folderNameSpan);
        
        const folderActions = document.createElement('div');
        folderActions.className = 'flex items-center';
        
        // Add file button inside folder
        const addFileBtn = document.createElement('button');
        addFileBtn.className = 'add-file-btn text-gray-400 hover:text-white ml-2 p-1 rounded-full hover:bg-dark-600';
        addFileBtn.innerHTML = '<i class="fas fa-plus text-xs"></i>';
        addFileBtn.title = 'Añadir archivo';
        
        // Delete folder button
        const deleteFolderBtn = document.createElement('button');
        deleteFolderBtn.className = 'delete-folder-btn text-red-400 hover:text-red-500 ml-2 p-1 rounded-full hover:bg-dark-600';
        deleteFolderBtn.innerHTML = '<i class="fas fa-trash text-xs"></i>';
        deleteFolderBtn.title = 'Eliminar carpeta';
        
        folderActions.appendChild(addFileBtn);
        folderActions.appendChild(deleteFolderBtn);
        
        folderHeader.appendChild(folderLeft);
        folderHeader.appendChild(folderActions);
        folderElement.appendChild(folderHeader);
        
        const fileContainer = document.createElement('div');
        fileContainer.className = 'ml-4 mt-1';
        if (!expandedFolders[folderName]) {
            fileContainer.classList.add('hidden');
        }
        
        folders[folderName].forEach(fileName => {
            const fileElement = document.createElement('div');
            fileElement.className = 'flex items-center px-2 py-1 rounded hover:bg-dark-700 cursor-pointer text-gray-400 file-item file-highlight';
            fileElement.setAttribute('data-folder', folderName);
            fileElement.setAttribute('data-file', fileName);
            
            if (activeFolder === folderName && activeFile === fileName) {
                fileElement.classList.add('active', 'text-white');
            }
            
            const fileIcon = document.createElement('i');
            fileIcon.className = getFileIcon(fileName) + ' mr-2';
            const fileNameSpan = document.createElement('span');
            fileNameSpan.className = 'text-sm';
            fileNameSpan.textContent = fileName;
            
            fileElement.appendChild(fileIcon);
            fileElement.appendChild(fileNameSpan);
            fileContainer.appendChild(fileElement);
        });
        
        folderElement.appendChild(fileContainer);
        fileList.appendChild(folderElement);
    });
}

// Get appropriate file icon
function getFileIcon(fileName) {
    const extension = fileName.split('.').pop();
    let iconClass = 'fas fa-file';
    
    switch(extension) {
        case 'html': iconClass = 'fab fa-html5 text-red-500'; break;
        case 'css': iconClass = 'fab fa-css3-alt text-blue-500'; break;
        case 'js': iconClass = 'fab fa-js-square text-yellow-500'; break;
        case 'json': iconClass = 'fas fa-code text-green-500'; break;
        case 'png':
        case 'jpg':
        case 'jpeg':
        case 'gif': iconClass = 'fas fa-image text-purple-500'; break;
    }
    
    return iconClass;
}

// Render open tabs
function renderTabs() {
    const tabsContainer = document.querySelector('#editor-tabs > div');
    tabsContainer.innerHTML = '';
    
    openTabs.forEach(tab => {
        const tabElement = document.createElement('div');
        tabElement.className = 'flex items-center px-3 py-2 text-sm font-medium bg-dark-800 text-gray-400 editor-tab cursor-pointer';
        tabElement.setAttribute('data-folder', tab.folder);
        tabElement.setAttribute('data-file', tab.file);
        
        if (activeFolder === tab.folder && activeFile === tab.file) {
            tabElement.classList.remove('bg-dark-800', 'text-gray-400');
            tabElement.classList.add('bg-dark-700', 'text-white');
        }
        
        const fileNameSpan = document.createElement('span');
        fileNameSpan.textContent = tab.file;
        
        const closeButton = document.createElement('button');
        closeButton.className = 'ml-2 text-gray-400 hover:text-white';
        closeButton.innerHTML = '<i class="fas fa-times text-xs"></i>';
        closeButton.addEventListener('click', (e) => {
            e.stopPropagation();
            closeTab(tab.folder, tab.file);
        });
        
        tabElement.appendChild(fileNameSpan);
        tabElement.appendChild(closeButton);
        tabsContainer.appendChild(tabElement);
    });
}

// Close a specific tab
function closeTab(folderName, fileName) {
    openTabs = openTabs.filter(tab => !(tab.folder === folderName && tab.file === fileName));
    renderTabs();
    
    if (activeFolder === folderName && activeFile === fileName) {
        if (openTabs.length > 0) {
            const lastTab = openTabs[openTabs.length - 1];
            switchToTab(lastTab.folder, lastTab.file);
        } else {
            activeFile = null;
            if (editor) {
                editor.setValue('// Bienvenido a BCode  Crea una carpeta o abre tu carpeta para comenzar');
            }
            document.getElementById('current-file-type').textContent = 'JavaScript';
            showStatusMessage(`Pestaña "${fileName}" cerrada`, 'success');
        }
    }
}

// Update tab status (modified/clean)
function updateTabStatus(fileName, isModified) {
    const tab = document.querySelector(`.editor-tab[data-file="${fileName}"]`);
    if (tab) {
        if (isModified) {
            tab.classList.add('italic');
        } else {
            tab.classList.remove('italic');
        }
    }
}

// Show status message
function showStatusMessage(message, type = 'info') {
    const statusElement = document.getElementById('status-message');
    statusElement.textContent = message;
    
    // Remove all color classes
    statusElement.classList.remove('text-green-500', 'text-red-500', 'text-yellow-500', 'text-blue-500');
    
    // Add appropriate color class
    switch(type) {
        case 'success': statusElement.classList.add('text-green-500'); break;
        case 'error': statusElement.classList.add('text-red-500'); break;
        case 'warning': statusElement.classList.add('text-yellow-500'); break;
        default: statusElement.classList.add('text-blue-500');
    }
    
    // Clear after 3 seconds
    setTimeout(() => {
        if (statusElement.textContent === message) {
            statusElement.textContent = 'Ready';
            statusElement.classList.remove('text-green-500', 'text-red-500', 'text-yellow-500', 'text-blue-500');
        }
    }, 3000);
}

// Update clock
function updateClock() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('current-time').textContent = `${hours}:${minutes}`;
}

// Send AI message
function sendAIMessage() {
    const input = document.getElementById('ai-input');
    const message = input.value.trim();
    
    if (message) {
        const chat = document.getElementById('ai-chat');
        
        // Add user message
        chat.innerHTML += `
            <div class="bg-dark-700 rounded-lg p-3 mb-3 text-right">
                <div class="text-xs text-gray-400 mb-1">Tú:</div>
                <p class="text-sm">${message}</p>
            </div>
        `;
        
        // Simulate AI response
        setTimeout(() => {
            chat.innerHTML += `
                <div class="bg-dark-700 rounded-lg p-3 mb-3">
                    <div class="text-xs text-gray-400 mb-1">AI:</div>
                    <p class="text-sm">Estoy procesando tu solicitud: "${message}"</p>
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
        }, 500);
        
        input.value = '';
        chat.scrollTop = chat.scrollHeight;
    }
}

// Handle file drop
function handleFileDrop(files) {
    if (!activeFolder) {
        showStatusMessage('Selecciona una carpeta primero', 'error');
        return;
    }
    
    Array.from(files).forEach(file => {
        const fileName = file.name;
        
        if (!folders[activeFolder].includes(fileName)) {
            folders[activeFolder].push(fileName);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!folderCode[activeFolder]) {
                    folderCode[activeFolder] = {};
                }
                
                folderCode[activeFolder][fileName] = e.target.result;
                renderFileExplorer();
                saveState();
                showStatusMessage(`Archivo "${fileName}" importado`, 'success');
            };
            reader.readAsText(file);
        } else {
            showStatusMessage(`El archivo "${fileName}" ya existe`, 'error');
        }
    });
}

// Save app state to localStorage
function saveState() {
    const state = {
        folders: folders,
        folderCode: folderCode,
        activeFolder: activeFolder,
        activeFile: activeFile,
        openTabs: openTabs,
        theme: currentTheme,
        expandedFolders: expandedFolders
    };
    
    localStorage.setItem('bustosCodeState', JSON.stringify(state));
}

// Load app state from localStorage
function loadState() {
    const savedState = localStorage.getItem('bustosCodeState');
    
    if (savedState) {
        const state = JSON.parse(savedState);
        
        folders = state.folders || {};
        folderCode = state.folderCode || {};
        activeFolder = state.activeFolder || null;
        activeFile = state.activeFile || null;
        openTabs = state.openTabs || [];
        currentTheme = state.theme || 'dark';
        expandedFolders = state.expandedFolders || {};
        
        // Apply theme
        if (currentTheme === 'light') {
            document.body.classList.add('bg-gray-100', 'text-gray-800');
        }
    }
    
    // Render UI with loaded state
    renderFileExplorer();
    renderTabs();
}

// Toggle folder expansion state
function toggleFolder(folderName) {
    expandedFolders[folderName] = !expandedFolders[folderName];
    renderFileExplorer();
    saveState();
}

// Delete a folder
function deleteFolder(folderName) {
    if (confirm(`¿Estás seguro de que quieres eliminar la carpeta "${folderName}" y todos sus archivos?`)) {
        // Close any open tabs from this folder
        openTabs = openTabs.filter(tab => tab.folder !== folderName);
        
        // If active file is in this folder, clear it
        if (activeFolder === folderName) {
            activeFolder = null;
            activeFile = null;
            
            if (editor) {
                editor.setValue('// Bienvenido a BCode  Crea una carpeta o abre tu carpeta para comenzar');
                const model = editor.getModel();
                if (model) {
                    monaco.editor.setModelLanguage(model, 'javascript');
                }
            }
        }
        
        // Remove folder and its contents
        delete folders[folderName];
        delete folderCode[folderName];
        delete expandedFolders[folderName];
        
        // Update UI
        renderFileExplorer();
        renderTabs();
        saveState();
        
        showStatusMessage(`Carpeta "${folderName}" eliminada`, 'success');
    }
}

// Export current file
function exportFile() {
    if (!activeFolder || !activeFile) {
        showStatusMessage('No hay archivo abierto para exportar', 'error');
        return;
    }
    
    const content = folderCode[activeFolder][activeFile];
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = activeFile;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatusMessage(`Archivo "${activeFile}" exportado`, 'success');
}



function appendToConsole(type, message, file = '', line = '', col = '') {
    const consoleContent = document.getElementById('console-content');
    const timestamp = new Date().toLocaleTimeString();
    
    let messageElement = document.createElement('div');
    messageElement.className = `console-${type}`;
    
    // Convertir objetos a string
    if (typeof message === 'object') {
        try {
            message = JSON.stringify(message, null, 2);
        } catch (e) {
            message = String(message);
        }
    }
    
    // Estilos diferentes según el tipo de mensaje
    switch(type) {
        case 'error':
            messageElement.style.color = '#ff5555';
            // Para errores, extraemos solo el mensaje principal si viene con stack trace
            message = message.split('\n')[0];
            break;
        case 'warn':
            messageElement.style.color = '#ffb86c';
            break;
        case 'info':
            messageElement.style.color = '#8be9fd';
            break;
        default:
            messageElement.style.color = '#f8f8f2';
    }
    
    // Construir el mensaje con información de ubicación si está disponible
    let locationInfo = '';
    if (file && line) {
        // Extraer solo el nombre del archivo si es una ruta larga
        const shortFile = file.split('/').pop();
        locationInfo = ` (${shortFile}:${line}${col ? `:${col}` : ''})`;
    }
    
    // Formatear el mensaje final
    messageElement.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> <span class="font-bold">${type.toUpperCase()}:</span> ${message}${locationInfo}`;
    
    consoleContent.appendChild(messageElement);
    
    // Auto-scroll al final
    consoleContent.scrollTop = consoleContent.scrollHeight;
}


const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info,
        debug: console.debug
    };
// Mejorar la redirección de la consola
function initConsoleRedirection() {
    // Solo sobrescribe si no se ha hecho antes
    if (console.log !== originalConsole.log) return;

    ['log', 'error', 'warn', 'info', 'debug'].forEach(method => {
        console[method] = function() {
            // Llama a la función original
            originalConsole[method].apply(console, arguments);
            
            // Obtener información del stack trace para errores
            let file = '', line = '', col = '';
            if (method === 'error') {
                try {
                    throw new Error();
                } catch (e) {
                    const stackLines = e.stack.split('\n');
                    if (stackLines.length > 2) {
                        // El formato del stack trace puede variar según el navegador
                        const match = stackLines[2].match(/at (.+):(\d+):(\d+)/);

                        if (match) {
                            file = match[1];
                            line = match[2];
                            col = match[3];
                        }
                    }
                }
            }
            
            const messages = Array.from(arguments).map(arg => {
                if (typeof arg === 'object' && arg !== null) {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            });
            
            const fullMessage = messages.join(' ');
            appendToConsole(method === 'debug' ? 'log' : method, fullMessage, file, line, col);
        };
    });
    // Al final de tu función init()
window.addEventListener('resize', updateEditorWidth);
updateEditorWidth();

}


document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>

